# 企业微信架构说明

## 常见误解

### ❌ 误解：企业微信需要在服务器上运行
很多开发者以为需要把企业微信客户端或服务安装到自己的服务器上。

### ✅ 正确理解：企业微信是腾讯的SaaS服务
企业微信是腾讯提供的云服务，运行在腾讯的服务器上，不需要在您的服务器上安装任何企业微信相关的程序。

---

## 工作原理

```
┌─────────────────────────────────────────────────────────────┐
│                      腾讯企业微信服务器                       │
│                    (由腾讯管理和运行)                         │
│                                                              │
│  ┌──────────────┐                                           │
│  │ 企业微信后台  │  用户在这里配置回调URL                     │
│  └──────┬───────┘                                           │
│         │                                                    │
│         │ 当用户点击"验证URL"时                              │
│         │                                                    │
│         ▼                                                    │
│  ┌──────────────┐                                           │
│  │  验证模块     │  发送GET请求到您的服务器                   │
│  └──────┬───────┘                                           │
│         │                                                    │
└─────────┼────────────────────────────────────────────────────┘
          │
          │ HTTP请求 (GET)
          │ URL: http://47.110.72.148:8080/api/wechat/callback
          │ 参数: msg_signature, timestamp, nonce, echostr
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│                    您的服务器 (阿里云)                        │
│                                                              │
│  ┌──────────────────────────────────────┐                   │
│  │  FastAPI 服务 (8080端口)             │                   │
│  │                                       │                   │
│  │  src/api/wechat_callback_simple.py   │  ◄── 我们写的代码   │
│  │                                       │                   │
│  │  企业微信URL验证接口                   │                   │
│  └──────────────────────────────────────┘                   │
│         │                                                    │
│         │ 接收请求，验证签名，返回echostr                     │
│         │                                                    │
└─────────┼────────────────────────────────────────────────────┘
          │
          │ HTTP响应 (200 OK)
          │ Body: echostr (纯文本)
          │
          ▼
┌─────────────────────────────────────────────────────────────┐
│                      腾讯企业微信服务器                       │
│                                                              │
│  接收到echostr，验证通过                                     │
│  后台显示 "URL验证成功"                                       │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 我们的服务器需要做什么？

### 1. 提供一个接口
- **URL**: `http://47.110.72.148:8080/api/wechat/callback`
- **方法**: GET
- **功能**: 接收企业微信的验证请求

### 2. 验证签名
- 使用企业微信提供的Token验证请求的合法性
- 防止恶意请求

### 3. 返回echostr
- 将接收到的echostr原样返回（纯文本格式）
- 企业微信收到后验证成功

### 4. 记录日志
- 记录所有请求，方便调试
- 我们已经添加了请求日志中间件

---

## 配置步骤

### 第一步：服务器端（已完成 ✅）
1. ✅ 编写企业微信URL验证接口
2. ✅ 配置Token、EncodingAESKey、Corp ID
3. ✅ 启动FastAPI服务（8080端口）
4. ✅ 测试接口是否可访问
5. ✅ 添加请求日志监控

### 第二步：企业微信后台（需要您操作）
1. 打开企业微信管理后台
2. 进入应用管理
3. 找到"TNHO全能营销助手"应用
4. 进入开发者配置
5. 填写以下信息：
   - **回调URL**: `http://47.110.72.148:8080/api/wechat/callback`
   - **Token**: `gkIzrwgJI041s52TPAszz2j5iGnpZ4`
   - **EncodingAESKey**: `2pCDTnGuFB0s8Ianv7WDzhfcyMnmlwb65KDnAbXNFCr`
6. 点击"验证"或"保存"按钮

### 第三步：监控日志（正在等待）
1. 启动日志监控：
   ```bash
   bash watch.sh
   ```
2. 在企业微信后台点击"验证"
3. 观察日志，看是否有请求到达

---

## 日志示例

### 成功的场景（期望看到的日志）
```
INFO:src.api.middleware:收到请求
INFO:src.api.middleware:  客户端 IP: [企业微信的IP]
INFO:src.api.middleware:  URL: http://47.110.72.148:8080/api/wechat/callback
INFO:src.api.middleware:  User-Agent: [企业微信的UA]
INFO:src.api.wechat_callback_simple:收到企业微信 URL 验证请求
INFO:src.api.wechat_callback_simple:  msg_signature: xxx
INFO:src.api.wechat_callback_simple:  timestamp: xxx
INFO:src.api.wechat_callback_simple:  nonce: xxx
INFO:src.api.wechat_callback_simple:  echostr: xxx
INFO:src.api.wechat_callback_simple:✅ 签名验证通过
INFO:src.api.middleware:  响应状态码: 200
```

### 失败的场景（看不到任何日志）
- 企业微信没有发送请求（配置未保存、网络问题）
- 请求被拦截（防火墙、安全组）
- URL配置错误

---

## 当前状态

### ✅ 服务器端已完成
- FastAPI服务正常运行
- 企业微信接口已实现
- 签名验证逻辑正确
- 请求日志已启用
- 公网访问正常

### ⏳ 等待用户操作
- 在企业微信后台配置回调URL
- 点击"验证"按钮
- 观察日志输出

---

## 常见问题

### Q: 为什么服务器上没有企业微信的程序？
A: 企业微信是腾讯的SaaS服务，不需要在您的服务器上安装。您只需要提供一个接口供企业微信调用即可。

### Q: 如何知道企业微信是否发送了请求？
A: 启动日志监控，如果企业微信发送了请求，日志中会显示"收到企业微信 URL 验证请求"。

### Q: 如果看不到日志怎么办？
A:
1. 检查企业微信后台是否正确配置了URL和Token
2. 检查阿里云安全组是否开放8080端口（已开放）
3. 尝试从公网访问回调URL测试是否可访问
4. 联系企业微信技术支持

### Q: 为什么使用HTTP而不是HTTPS？
A: 当前使用HTTP是为了快速验证。正式环境建议使用HTTPS，可以配置Nginx反向代理和SSL证书。

---

## 下一步

1. **启动监控**：
   ```bash
   bash watch.sh
   ```

2. **在企业微信后台验证URL**：
   - 回调URL: `http://47.110.72.148:8080/api/wechat/callback`
   - Token: `gkIzrwgJI041s52TPAszz2j5iGnpZ4`

3. **观察日志输出**，看是否有请求到达

---

**最后更新**: 2026-01-15 02:38
**服务器状态**: ✅ 准备就绪
**等待**: 企业微信验证请求
