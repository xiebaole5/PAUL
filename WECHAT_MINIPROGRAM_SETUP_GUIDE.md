# 微信小程序 - 一步一步设置指南

## 📱 准备工作

### 已完成
✅ 下载并安装微信开发者工具
✅ 注册微信小程序账号

### 准备信息
- 微信小程序 AppID（测试号或正式 AppID）
- 后端 API 地址（稍后配置）

---

## 第一步：打开微信开发者工具

1. **启动微信开发者工具**
   - 在电脑上找到微信开发者工具图标
   - 双击打开

2. **登录微信账号**
   - 使用微信扫码登录
   - 确保登录的微信账号已注册小程序

---

## 第二步：导入项目

1. **点击"导入项目"**
   - 在开发者工具首页，点击"+"号
   - 或选择"导入项目"

2. **填写项目信息**

   | 字段 | 填写内容 | 说明 |
   |------|---------|------|
   | **项目名称** | `天虹紧固件视频生成` | 随便填，方便识别 |
   | **目录** | 选择 `miniprogram` 文件夹 | 见下方说明 |
   | **AppID** | 填写你的 AppID | 测试号或正式 AppID |
   | **开发模式** | 小程序 | 默认选项 |

3. **如何选择 miniprogram 目录**

   **方式一：如果文件已在本地**
   - 点击"选择"按钮
   - 浏览到 `tnho-video-miniprogram.tar.gz` 解压后的目录
   - 选择 `miniprogram` 文件夹

   **方式二：如果还在服务器**
   - 先将项目下载到本地（见 DOWNLOAD_GUIDE.md）
   - 解压后选择 `miniprogram` 文件夹

4. **点击"导入"**
   - 等待项目加载

---

## 第三步：配置 AppID

### 如果你没有正式 AppID

#### 使用测试号（快速测试）

1. **获取测试号**
   - 打开 [微信小程序开发工具](https://developers.weixin.qq.com/sandbox)
   - 用微信扫码登录
   - 复制 `appID`（格式：wx 开头）

2. **填写 AppID**
   - 在开发者工具中
   - 项目设置 → 基本信息 → AppID
   - 粘贴测试号 AppID

#### 注册正式 AppID（长期使用）

1. **注册小程序**
   - 访问 [微信小程序注册页面](https://mp.weixin.qq.com/)
   - 点击"立即注册"
   - 选择"小程序"
   - 按指引填写信息（邮箱、密码等）

2. **认证小程序**
   - 邮箱验证
   - 信息登记（个人/企业）
   - 个人可快速通过，企业需要认证

3. **获取 AppID**
   - 注册成功后
   - 在小程序后台的"开发" → "开发设置"中查看
   - 复制 AppID

---

## 第四步：配置后端 API 地址

### 1. 找到配置文件

在开发者工具的文件管理器中：
```
miniprogram/
├── app.json
├── app.js          ← 这个文件
├── app.wxss
└── ...
```

2. **编辑 app.js**

点击 `app.js`，找到以下内容：

```javascript
app.globalData = {
  // 后端 API 地址，需要修改为实际部署地址
  apiBaseUrl: 'http://localhost:8000'
}
```

3. **修改 API 地址**

根据你的部署情况，填写正确的地址：

#### 情况一：在 Coze 平台开发（当前）

如果你使用 Coze 提供的测试环境：
```javascript
apiBaseUrl: 'http://115.191.1.199:8000'
```

#### 情况二：部署到自己的服务器

```javascript
apiBaseUrl: 'http://your-server-ip:8000'
```

替换 `your-server-ip` 为你的服务器公网 IP。

#### 情况三：本地开发（后端在自己电脑）

```javascript
apiBaseUrl: 'http://localhost:8000'
```

4. **保存文件**
   - 按 `Ctrl + S`（Windows）或 `Cmd + S`（Mac）
   - 或点击工具栏的"保存"按钮

---

## 第五步：配置项目基本信息

### 1. 编辑 project.config.json

找到并打开 `project.config.json`：

```json
{
  "description": "天虹紧固件视频生成小程序",
  "packOptions": {
    "ignore": []
  },
  "setting": {
    ...
  },
  "compileType": "miniprogram",
  "libVersion": "2.19.4",
  "appid": "your_miniprogram_appid",  ← 修改这里
  "projectname": "tnho-video-generator"
}
```

2. **修改 appid**

将 `"your_miniprogram_appid"` 替换为你的实际 AppID。

---

## 第六步：预览小程序

### 1. 点击"预览"按钮

在开发者工具顶部工具栏：
- 找到"预览"按钮
- 点击它

### 2. 扫码预览

- 用手机微信扫描二维码
- 即可在手机上看到小程序界面

### 3. 查看效果

你应该能看到：
- 红色 TNHO Logo
- "天虹紧固件产品宣传视频生成"标题
- 产品名称输入框
- 主题选择（品质保证、技术创新、工业应用、品牌形象）
- 时长选择（5-30秒）
- "生成视频"按钮
- 使用提示

---

## 第七步：配置服务器域名（正式发布）

### 开发阶段（跳过此步）

在开发阶段，开发者工具会自动跳过域名验证：
- 点击右上角"详情"
- 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

### 正式发布（必须配置）

#### 1. 在微信公众平台配置

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入你的小程序
3. 点击"开发" → "开发管理" → "开发设置"
4. 找到"服务器域名"
5. 点击"修改"

#### 2. 配置域名

在以下分类中添加你的后端域名：

| 域名类型 | 填写内容 | 说明 |
|---------|---------|------|
| **request 合法域名** | `https://your-domain.com` | 必须是 HTTPS |
| **uploadFile 合法域名** | `https://your-domain.com` | 上传文件 |
| **downloadFile 合法域名** | `https://your-domain.com` | 下载文件 |

**注意**：
- ✅ 必须使用 HTTPS
- ✅ 域名需要备案
- ✅ 不能使用 IP 地址

#### 3. 使用域名代替 IP

如果你有域名，需要：
1. 购买域名
2. 域名备案
3. 配置 DNS 解析
4. 购买 SSL 证书
5. 配置 Nginx 反向代理

---

## 第八步：启动后端服务

### 在 Coze 平台（开发测试）

由于 Coze 平台的后端服务可能需要手动启动，你需要：

#### 选项一：使用 Coze 的内置运行功能
1. 在 Coze 平台找到"运行"或"测试"按钮
2. 启动服务
3. 获取访问地址

#### 选项二：手动启动（如果有终端访问）
```bash
cd /workspace/projects
uvicorn src.api.app:app --host 0.0.0.0 --port 8000
```

### 在自己的服务器

```bash
# 1. 上传项目到服务器
scp -r miniprogram user@server:/path/to/project

# 2. 安装依赖
pip install -r requirements.txt

# 3. 启动服务
uvicorn src.api.app:app --host 0.0.0.0 --port 8000
```

---

## 第九步：测试小程序

### 测试步骤

1. **填写产品名称**
   - 在小程序中输入：`高强度螺栓`

2. **选择主题**
   - 点击选择：`品质保证`

3. **选择时长**
   - 点击选择：`20` 秒

4. **点击"生成视频"**
   - 等待 30-60 秒
   - 查看是否返回视频 URL

5. **预览视频**
   - 点击视频播放
   - 检查是否显示红色 TNHO 商标

---

## 第十步：上传和发布（可选）

### 1. 点击"上传"

在开发者工具中：
- 点击"上传"按钮
- 填写版本号（如 1.0.0）
- 填写项目备注

### 2. 提交审核

1. 登录微信公众平台
2. 进入"管理" → "版本管理"
3. 找到刚才上传的版本
4. 点击"提交审核"

### 3. 发布上线

- 审核通过后
- 点击"全量发布"
- 小程序即可在微信中搜索到

---

## ❓ 常见问题

### Q1: 导入项目后报错"项目配置错误"

**解决**：
- 检查 `miniprogram` 目录结构是否完整
- 确认 AppID 填写正确
- 尝试关闭开发者工具，重新导入

### Q2: 点击"生成视频"后提示"请求失败"

**解决**：
- 检查 `app.js` 中的 `apiBaseUrl` 是否正确
- 确认后端服务已启动
- 开发阶段勾选"不校验合法域名"

### Q3: 视频生成失败

**解决**：
- 查看后端日志（如果有访问权限）
- 检查 API Key 是否有效
- 确认网络连接正常

### Q4: 无法扫码预览

**解决**：
- 确保微信开发者工具已登录
- 检查网络连接
- 尝试重启开发者工具

---

## 📞 需要帮助？

如果在设置过程中遇到问题，请提供：
1. 当前进行到哪一步
2. 出现的错误提示
3. 截图（如果能提供）

---

## 🎯 下一步

设置完成后，你可以：
- 自定义小程序样式
- 添加更多功能
- 发布正式版本

祝你使用愉快！🚀
