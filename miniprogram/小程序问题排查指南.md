# å°ç¨‹åºæ— æ³•æ‰“å¼€ - é—®é¢˜æ’æŸ¥æŒ‡å—

## ğŸš¨ å½“å‰é—®é¢˜

å¾®ä¿¡å¼€å‘è€…å·¥å…·æ‰“ä¸å¼€å°ç¨‹åº

## âœ… æœåŠ¡å™¨çŠ¶æ€æ£€æŸ¥ç»“æœ

### æœåŠ¡ç«¯çŠ¶æ€ï¼ˆå…¨éƒ¨æ­£å¸¸ï¼‰
- âœ… Nginx æœåŠ¡æ­£å¸¸è¿è¡Œï¼ˆç›‘å¬ 80/443 ç«¯å£ï¼‰
- âœ… FastAPI æœåŠ¡æ­£å¸¸è¿è¡Œï¼ˆç«¯å£ 8080ï¼‰
- âœ… HTTPS è®¿é—®æµ‹è¯•é€šè¿‡ï¼š`https://47.110.72.148/health` è¿”å›æ­£å¸¸
- âœ… API æ¥å£æµ‹è¯•é€šè¿‡ï¼š`/api/generate-video` è¿”å›æ­£å¸¸å“åº”

### å°ç¨‹åºé…ç½®
- âœ… API åœ°å€é…ç½®æ­£ç¡®ï¼š`https://tnho-fasteners.com`
- âœ… å°ç¨‹åºä»£ç ä½¿ç”¨ `app.globalData.apiUrl`ï¼ˆç»Ÿä¸€é…ç½®ï¼‰

## ğŸ” é—®é¢˜åŸå› åˆ†æ

### æœ€å¯èƒ½çš„åŸå› ï¼šè‡ªç­¾å SSL è¯ä¹¦

**å½“å‰ä½¿ç”¨çš„è¯ä¹¦**ï¼š
- ç±»å‹ï¼šè‡ªç­¾åè¯ä¹¦
- è·¯å¾„ï¼š`/etc/nginx/ssl/tnho-origin.crt`
- é—®é¢˜ï¼šå¾®ä¿¡å°ç¨‹åº**ä¸¥æ ¼æ‹’ç»**è‡ªç­¾åè¯ä¹¦

**ä¸ºä»€ä¹ˆä¼šå¯¼è‡´é—®é¢˜**ï¼š
- å¾®ä¿¡å°ç¨‹åºè¦æ±‚ä½¿ç”¨**å—ä¿¡ä»»çš„ CA ç­¾å‘çš„è¯ä¹¦**
- è‡ªç­¾åè¯ä¹¦ä¸åœ¨ä¿¡ä»»åˆ—è¡¨ä¸­ï¼Œä¼šè¢«å°ç¨‹åºæ‹’ç»
- è¿™æ˜¯å¾®ä¿¡çš„å®‰å…¨ç­–ç•¥ï¼Œæ— æ³•ç»•è¿‡ï¼ˆé™¤éåœ¨å¼€å‘å·¥å…·ä¸­å…³é—­åŸŸåæ ¡éªŒï¼‰

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šä¸´æ—¶è§£å†³æ–¹æ¡ˆï¼ˆå¼€å‘å·¥å…·è°ƒè¯•ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¼€å‘è°ƒè¯•ã€å¿«é€Ÿæµ‹è¯•

**æ­¥éª¤**ï¼š

1. **ä¸´æ—¶å…³é—­åŸŸåæ ¡éªŒ**
   - æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·
   - ç‚¹å‡»å³ä¸Šè§’ `è¯¦æƒ…` æŒ‰é’®
   - é€‰æ‹© `æœ¬åœ°è®¾ç½®` æ ‡ç­¾
   - å‹¾é€‰ `ä¸æ ¡éªŒåˆæ³•åŸŸåã€web-viewï¼ˆä¸šåŠ¡åŸŸåï¼‰ã€TLS ç‰ˆæœ¬ä»¥åŠ HTTPS è¯ä¹¦`

2. **åˆ·æ–°å°ç¨‹åº**
   - å…³é—­å°ç¨‹åºçª—å£
   - é‡æ–°æ‰“å¼€å°ç¨‹åºé¡¹ç›®
   - åº”è¯¥å¯ä»¥æ­£å¸¸è¿è¡Œäº†

**ç¼ºç‚¹**ï¼š
- âŒ åªèƒ½åœ¨å¼€å‘å·¥å…·ä¸­ä½¿ç”¨
- âŒ çœŸæœºè°ƒè¯•å’Œæ­£å¼å‘å¸ƒä¸å¯ç”¨
- âŒ ä¸ç¬¦åˆå°ç¨‹åºå‘å¸ƒè§„èŒƒ

---

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ HTTP åœ°å€ï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šå¿«é€Ÿå¼€å‘æµ‹è¯•

**æ­¥éª¤**ï¼š

1. **ä¿®æ”¹å°ç¨‹åºé…ç½®**
   æ‰“å¼€ `miniprogram/app.js`ï¼Œä¿®æ”¹ API åœ°å€ï¼š

   ```javascript
   // æ³¨é‡Šæ‰ HTTPS åœ°å€
   // apiUrl: 'https://tnho-fasteners.com',

   // ä½¿ç”¨ HTTP åœ°å€
   apiUrl: 'http://47.110.72.148',
   ```

2. **å…³é—­åŸŸåæ ¡éªŒ**ï¼ˆåŒæ–¹æ¡ˆä¸€ï¼‰

3. **åˆ·æ–°å°ç¨‹åº**

**ç¼ºç‚¹**ï¼š
- âŒ çœŸæœºè°ƒè¯•ä¸å¯ç”¨
- âŒ æ­£å¼å‘å¸ƒä¸å¯ç”¨
- âŒ ä¸ç¬¦åˆå°ç¨‹åºè§„èŒƒ

---

### æ–¹æ¡ˆä¸‰ï¼šå‡çº§ä¸º Cloudflare Origin Certificateï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šçœŸæœºè°ƒè¯•ã€æ­£å¼å‘å¸ƒ

**æ­¥éª¤**ï¼š

1. **ç™»å½• Cloudflare æ§åˆ¶å°**
   - è®¿é—®ï¼šhttps://dash.cloudflare.com/
   - é€‰æ‹© `tnho-fasteners.com` åŸŸå

2. **ç”Ÿæˆ Origin Certificate**
   - å¯¼èˆªåˆ° `SSL/TLS` -> `Origin Server`
   - ç‚¹å‡» `Create Certificate`
   - é…ç½®ï¼š
     - Hostnames: `*.tnho-fasteners.com`, `tnho-fasteners.com`
     - Validity: 15 years
     - Certificate Type: RSA
   - ç‚¹å‡» `Create`

3. **ä¿å­˜è¯ä¹¦å’Œç§é’¥**
   - ä¸‹è½½ Certificate (PEM æ ¼å¼) -> ä¿å­˜ä¸º `tnho-origin.crt`
   - ä¸‹è½½ Private Key (RSA æ ¼å¼) -> ä¿å­˜ä¸º `tnho-origin.key`

4. **ä¸Šä¼ è¯ä¹¦åˆ°æœåŠ¡å™¨**

   åœ¨æœ¬åœ°ç”µè„‘æ‰§è¡Œï¼š
   ```bash
   # æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨ IP
   scp tnho-origin.crt root@47.110.72.148:/etc/nginx/ssl/tnho-origin.crt
   scp tnho-origin.key root@47.110.72.148:/etc/nginx/ssl/tnho-origin.key
   ```

5. **é‡å¯ Nginx**

   SSH ç™»å½•æœåŠ¡å™¨åæ‰§è¡Œï¼š
   ```bash
   nginx -t && nginx -s reload
   ```

6. **ç¡®è®¤ Cloudflare SSL è®¾ç½®**
   - åœ¨ Cloudflare æ§åˆ¶å°ï¼Œç¡®ä¿ SSL/TLS æ¨¡å¼ä¸º `Full` æˆ– `Full (strict)`
   - ä¸è¦ä½¿ç”¨ `Flexible` æ¨¡å¼

7. **æµ‹è¯•è¯ä¹¦**
   - è®¿é—®ï¼šhttps://tnho-fasteners.com
   - æµè§ˆå™¨åº”è¯¥ä¸å†æ˜¾ç¤ºè¯ä¹¦è­¦å‘Š

**ä¼˜ç‚¹**ï¼š
- âœ… è¯ä¹¦å—ä¿¡ä»»ï¼Œå°ç¨‹åºå¯ä»¥æ­£å¸¸è®¿é—®
- âœ… æ”¯æŒçœŸæœºè°ƒè¯•
- âœ… æ”¯æŒæ­£å¼å‘å¸ƒ
- âœ… é•¿æœŸæœ‰æ•ˆï¼ˆ15 å¹´ï¼‰

---

### æ–¹æ¡ˆå››ï¼šç”³è¯· Let's Encrypt è¯ä¹¦ï¼ˆå¤‡é€‰ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šä¸æ„¿ä½¿ç”¨ Cloudflare ä»£ç†

**æ­¥éª¤**ï¼š

1. **ä¸´æ—¶å…³é—­ Cloudflare ä»£ç†**
   - åœ¨ Cloudflare DNS è®¾ç½®ä¸­ï¼Œå°† A è®°å½•çš„æ©™è‰²äº‘æœµæ”¹ä¸ºç°è‰²ï¼ˆä»… DNSï¼‰
   - ç­‰å¾… DNS ä¼ æ’­ï¼ˆ1-5 åˆ†é’Ÿï¼‰

2. **ç”³è¯·è¯ä¹¦**

   SSH ç™»å½•æœåŠ¡å™¨åæ‰§è¡Œï¼š
   ```bash
   # åœæ­¢ Nginx
   nginx -s stop

   # ç”³è¯·è¯ä¹¦
   certbot certonly --standalone \
     -d tnho-fasteners.com \
     -d www.tnho-fasteners.com \
     --non-interactive \
     --agree-tos \
     --email admin@tnho-fasteners.com

   # å¯åŠ¨ Nginx
   nginx
   ```

3. **æ›´æ–° Nginx é…ç½®**

   ä¿®æ”¹ `/etc/nginx/sites-available/tnho-https.conf`ï¼š
   ```nginx
   ssl_certificate /etc/letsencrypt/live/tnho-fasteners.com/fullchain.pem;
   ssl_certificate_key /etc/letsencrypt/live/tnho-fasteners.com/privkey.pem;
   ```

4. **é‡å¯ Cloudflare ä»£ç†**
   - åœ¨ Cloudflare DNS è®¾ç½®ä¸­ï¼Œå°†ç°è‰²äº‘æœµæ”¹ä¸ºæ©™è‰²ï¼ˆä»£ç†å¼€å¯ï¼‰
   - é…ç½® SSL/TLS æ¨¡å¼ä¸º `Full (strict)`

5. **é‡å¯ Nginx**
   ```bash
   nginx -s reload
   ```

**ä¼˜ç‚¹**ï¼š
- âœ… å…è´¹è¯ä¹¦ï¼Œå—ä¿¡ä»»
- âœ… è‡ªåŠ¨ç»­æœŸï¼ˆ90 å¤©ï¼‰

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦ä¸´æ—¶å…³é—­ Cloudflare ä»£ç†
- âŒ è¯ä¹¦æœ‰æ•ˆæœŸçŸ­ï¼ˆ90 å¤©ï¼Œéœ€è‡ªåŠ¨ç»­æœŸï¼‰

---

## ğŸ“‹ å¿«é€Ÿè¯Šæ–­æ¸…å•

è¯·æŒ‰ä»¥ä¸‹é¡ºåºæ£€æŸ¥ï¼š

### 1. æ£€æŸ¥å¾®ä¿¡å¼€å‘è€…å·¥å…·è®¾ç½®
- [ ] è¯¦æƒ… -> æœ¬åœ°è®¾ç½® -> ä¸æ ¡éªŒåˆæ³•åŸŸåï¼ˆå·²å‹¾é€‰ï¼Ÿï¼‰

### 2. æ£€æŸ¥æœåŠ¡å™¨è¿æ¥
- [ ] èƒ½å¦è®¿é—® https://tnho-fasteners.com/health
- [ ] èƒ½å¦è®¿é—® https://47.110.72.148/health

### 3. æ£€æŸ¥å°ç¨‹åºé…ç½®
- [ ] `miniprogram/app.js` ä¸­ `apiUrl` æ˜¯å¦ä¸º `https://tnho-fasteners.com`

### 4. æ£€æŸ¥é”™è¯¯ä¿¡æ¯
- [ ] å¾®ä¿¡å¼€å‘è€…å·¥å…·æ§åˆ¶å°æœ‰ä»€ä¹ˆé”™è¯¯ï¼Ÿ
- [ ] ç½‘ç»œé¢æ¿æ˜¾ç¤ºä»€ä¹ˆé”™è¯¯ï¼Ÿ

### 5. æ£€æŸ¥ Cloudflare è®¾ç½®
- [ ] DNS è®°å½•æ˜¯å¦æ­£ç¡®ï¼ˆA è®°å½•æŒ‡å‘ 47.110.72.148ï¼‰
- [ ] ä»£ç†çŠ¶æ€æ˜¯å¦å¼€å¯ï¼ˆæ©™è‰²äº‘æœµï¼‰
- [ ] SSL/TLS æ¨¡å¼æ˜¯å¦ä¸º `Full` æˆ– `Full (strict)`

---

## ğŸ†˜ å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

### é”™è¯¯ 1ï¼šrequest:fail - è¯ä¹¦é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
request:fail
url: https://tnho-fasteners.com/api/generate-video
net::ERR_CERT_AUTHORITY_INVALID
```

**åŸå› **ï¼šè‡ªç­¾åè¯ä¹¦ä¸è¢«ä¿¡ä»»

**è§£å†³æ–¹æ¡ˆ**ï¼š
- å¼€å‘è°ƒè¯•ï¼šå…³é—­åŸŸåæ ¡éªŒï¼ˆæ–¹æ¡ˆä¸€ï¼‰
- æ­£å¼ä½¿ç”¨ï¼šå‡çº§ä¸º Cloudflare Origin Certificateï¼ˆæ–¹æ¡ˆä¸‰ï¼‰

---

### é”™è¯¯ 2ï¼šrequest:fail - åŸŸåä¸åœ¨ç™½åå•

**é”™è¯¯ä¿¡æ¯**ï¼š
```
request:fail
url: https://tnho-fasteners.com/api/generate-video
ä¸åœ¨ä»¥ä¸‹ request åˆæ³•åŸŸååˆ—è¡¨ä¸­
```

**åŸå› **ï¼šå°ç¨‹åºåå°æœªé…ç½®æœåŠ¡å™¨åŸŸå

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°ï¼šhttps://mp.weixin.qq.com/
2. è¿›å…¥ `å¼€å‘` -> `å¼€å‘ç®¡ç†` -> `å¼€å‘è®¾ç½®`
3. é…ç½®æœåŠ¡å™¨åŸŸåï¼š
   - request åˆæ³•åŸŸåï¼š`https://tnho-fasteners.com`
   - uploadFile åˆæ³•åŸŸåï¼š`https://tnho-fasteners.com`
   - downloadFile åˆæ³•åŸŸåï¼š`https://tnho-fasteners.com`

---

### é”™è¯¯ 3ï¼šrequest:fail - è¿æ¥è¶…æ—¶

**é”™è¯¯ä¿¡æ¯**ï¼š
```
request:fail
url: https://tnho-fasteners.com/api/generate-video
net::ERR_CONNECTION_TIMED_OUT
```

**åŸå› **ï¼šç½‘ç»œé—®é¢˜æˆ–æœåŠ¡æœªå¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥æœåŠ¡å™¨æœåŠ¡æ˜¯å¦è¿è¡Œï¼š
   ```bash
   ps aux | grep nginx
   ps aux | grep python3
   ```
2. æ£€æŸ¥é˜²ç«å¢™ï¼š
   ```bash
   ufw status
   ```
3. æ£€æŸ¥ Cloudflare ä»£ç†æ˜¯å¦å¼€å¯

---

### é”™è¯¯ 4ï¼šrequest:fail - 404 Not Found

**é”™è¯¯ä¿¡æ¯**ï¼š
```
request:fail
statusCode: 404
url: https://tnho-fasteners.com/api/generate-video
```

**åŸå› **ï¼šAPI è·¯å¾„é”™è¯¯æˆ–æœåŠ¡æœªå¯åŠ¨

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ API è·¯å¾„æ˜¯å¦æ­£ç¡®
2. æµ‹è¯• API æ˜¯å¦å¯è®¿é—®ï¼š
   ```bash
   curl -k https://tnho-fasteners.com/health
   curl -k https://tnho-fasteners.com/api/
   ```

---

## ğŸ”§ ç›¸å…³æ–‡æ¡£

- [HTTPS é…ç½®å®Œæˆè¯´æ˜](../docs/HTTPS_SETUP.md)
- [å°ç¨‹åºé…ç½®è¯´æ˜](å°ç¨‹åºé…ç½®è¯´æ˜.md)
- [å°ç¨‹åºå¿«é€Ÿå¯åŠ¨æŒ‡å—](å¿«é€Ÿå¯åŠ¨æŒ‡å—.md)
- [å°ç¨‹åºæ­£å¼å‘å¸ƒæŒ‡å—](../docs/å°ç¨‹åºæ­£å¼å‘å¸ƒæŒ‡å—.md)

---

## ğŸ’¬ éœ€è¦å¸®åŠ©ï¼Ÿ

å¦‚æœä»¥ä¸Šæ–¹æ¡ˆéƒ½æ— æ³•è§£å†³é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **é”™è¯¯æˆªå›¾**ï¼šå¾®ä¿¡å¼€å‘è€…å·¥å…·çš„é”™è¯¯ä¿¡æ¯
2. **æ§åˆ¶å°æ—¥å¿—**ï¼šConsole é¢æ¿çš„é”™è¯¯ä¿¡æ¯
3. **ç½‘ç»œè¯·æ±‚**ï¼šNetwork é¢æ¿çš„è¯·æ±‚è¯¦æƒ…
4. **æµ‹è¯•ç¯å¢ƒ**ï¼šæ¨¡æ‹Ÿå™¨è¿˜æ˜¯çœŸæœºè°ƒè¯•
5. **å½“å‰é…ç½®**ï¼š
   - `miniprogram/app.js` ä¸­çš„ `apiUrl`
   - æ˜¯å¦å…³é—­äº†åŸŸåæ ¡éªŒ

---

**æ›´æ–°æ—¶é—´**ï¼š2026-01-14 18:35
**ç‰ˆæœ¬**ï¼šv1.0.0
