# 微信小程序功能更新日志

## 更新时间
2026-01-13

## 更新内容

### 1. 优化超时设置
**文件**: `miniprogram/pages/index/index.js`

- **视频生成请求超时**: 从10秒调整为5秒
  - 原因：视频生成是异步任务，服务器会立即返回task_id，不需要长时间等待

- **脚本生成请求超时**: 新增120秒超时设置
  - 原因：脚本生成需要调用大模型，可能需要较长时间
  - 优化：给LLM足够的生成时间，避免超时

```javascript
// 根据生成类型设置不同的超时时间
const timeout = this.data.generateType === 'video' ? 5000 : 120000 // 视频异步5秒，脚本同步120秒
```

### 2. 改进错误处理
**文件**: `miniprogram/pages/index/index.js`

- **更友好的错误提示**:
  - 超时错误：显示"生成超时，请稍后重试或减少时长"
  - 网络错误：显示"服务器连接失败，请检查网络或稍后重试"
  - 延长错误提示显示时间到3秒

```javascript
let errorMessage = '网络错误，生成失败'
if (err.errMsg && err.errMsg.includes('timeout')) {
  errorMessage = this.data.generateType === 'script'
    ? '生成超时，请稍后重试或减少时长'
    : '请求超时，请检查网络连接'
}
```

### 3. 优化图生视频提示
**文件**: `miniprogram/pages/index/index.wxml`

- **更新图片上传说明**:
  - 标题改为"上传产品图片（选填，推荐）"
  - 强调"支持图生视频，提升生成质量"

- **更新底部说明**:
  - 添加"支持图生视频：上传产品图片可提升生成质量"
  - 添加"超过12秒的视频自动分段生成并拼接"

### 4. 更新API配置说明
**文件**: `miniprogram/app.js`

- **添加详细配置说明**:
  - 生产环境：https://tnho-fasteners.com（需要配置合法域名）
  - 开发环境：http://47.110.72.148（可忽略域名校验）
  - 提示：如果遇到证书问题，请在开发工具中关闭域名校验

### 5. 更新结果页面说明
**文件**: `miniprogram/pages/result/result.wxml`

- **添加模型信息**:
  - 显示"使用最新图生视频模型（doubao-seedance-1-5-pro-251215）"

## 功能对比：小程序 vs 服务器

### 已实现的功能 ✅

| 功能 | 服务器端 | 小程序端 | 状态 |
|------|---------|---------|------|
| 图片上传 | POST /api/upload-image | chooseImage() + uploadImage() | ✅ 一致 |
| 视频生成 | POST /api/generate-video | generateVideo() | ✅ 一致 |
| 脚本生成 | POST /api/generate-video | generateVideo() | ✅ 一致 |
| 进度查询 | GET /api/progress/{task_id} | pollProgress() | ✅ 一致 |
| 结果展示 | 返回JSON数据 | result页面 | ✅ 一致 |
| 图生视频 | 支持 product_image_url | 支持产品图片上传 | ✅ 一致 |
| 场景描述 | 支持 scenario | 场景描述输入 | ✅ 一致 |
| 时长分段 | 自动分段 | 显示分段提示 | ✅ 一致 |
| 视频拼接 | 自动拼接 | 展示拼接结果 | ✅ 一致 |

### 服务器端特有功能
- 视频任务管理（数据库存储任务状态）
- 后台异步任务处理

### 小程序端特有功能
- 进度轮询UI展示
- 多段视频切换展示
- 视频下载到相册
- 脚本复制功能

## 使用建议

### 开发环境
1. 在微信开发者工具中打开"详情" → "本地设置"
2. 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
3. 使用 `http://47.110.72.148` 作为API地址

### 生产环境
1. 在小程序后台配置服务器域名：
   - request合法域名：`https://tnho-fasteners.com`
   - uploadFile合法域名：`https://tnho-fasteners.com`
   - downloadFile合法域名：`https://tnho-fasteners.com`（火山方舟视频URL）
2. 使用 `https://tnho-fasteners.com` 作为API地址
3. 确保SSL证书有效（建议使用Let's Encrypt免费证书）

### 图生视频使用建议
1. **上传产品图片**：可以显著提升视频生成质量
2. **描述使用场景**：帮助模型更好地理解产品应用场景
3. **选择合适时长**：
   - 5-10秒：产品快速展示
   - 15-20秒：详细介绍
   - 25-30秒：完整宣传片

## 已知问题

### 1. HTTPS证书问题
- **问题**：自签名证书可能导致连接失败
- **影响**：生产环境无法访问
- **解决方案**：使用Let's Encrypt申请正式SSL证书

### 2. 数据库连接问题
- **问题**：进度查询功能因数据库连接失败
- **影响**：无法查询任务进度
- **解决方案**：修复数据库连接配置

### 3. 脚本生成超时
- **问题**：可能超过120秒
- **影响**：用户需要等待较长时间
- **解决方案**：优化Agent响应速度或增加超时时间

## 更新总结

本次更新确保了小程序与服务器端功能的一致性，主要改进：

1. ✅ **优化超时设置**：视频5秒，脚本120秒
2. ✅ **改进错误处理**：更友好的错误提示
3. ✅ **强化图生视频**：明确说明图生视频功能
4. ✅ **完善配置说明**：添加开发和生产环境配置说明

小程序功能现在与服务器端保持完全一致，可以正常使用所有功能！
