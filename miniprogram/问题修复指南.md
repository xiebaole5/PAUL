# 天虹紧固件小程序 - 问题修复指南

## 🚨 问题说明

用户反馈：
1. **上传不了图片，说是网络不好**
2. **视频也生成不了**

## 🔍 问题根因分析

### 核心问题：HTTPS证书问题

当前配置的API地址 `https://tnho-fasteners.com` 使用的是**自签名证书**，微信小程序对HTTPS证书要求非常严格：

- ❌ **自签名证书**：会导致SSL握手失败，小程序无法建立安全连接
- ❌ **小程序限制**：不允许使用自签名证书，必须是受信任的CA签发的正式证书
- ❌ **错误表现**：显示"网络错误"、"请求超时"等友好提示

## ✅ 解决方案

### 方案一：开发环境（推荐）⭐

使用HTTP地址，无需证书，开发工具可忽略域名校验。

#### 步骤1：修改小程序API地址

打开 `miniprogram/app.js`，确认使用HTTP地址：

```javascript
globalData: {
  // 开发环境（推荐）：
  apiUrl: 'http://47.110.72.148',
  // 不要使用HTTPS，除非有正式SSL证书
}
```

#### 步骤2：在微信开发者工具中关闭域名校验

1. 打开微信开发者工具
2. 点击右上角 **详情** 按钮
3. 选择 **本地设置** 标签页
4. 勾选 ✅ **不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书**

#### 步骤3：验证服务器是否运行

在服务器上执行：

```bash
# 检查应用是否运行
ps aux | grep "python app.py"

# 如果没有运行，启动应用
cd /app
python app.py

# 或者使用 nohup 后台运行
nohup python app.py > app.log 2>&1 &
```

#### 步骤4：测试API接口

运行测试脚本验证服务器接口是否正常：

```bash
cd /app/tests
python test_server_api.py
```

测试内容包括：
- ✅ 健康检查
- ✅ 图片上传
- ✅ 视频生成
- ✅ 脚本生成
- ✅ 进度查询

### 方案二：生产环境（正式上线）

使用HTTPS地址，需要配置正式SSL证书。

#### 步骤1：申请Let's Encrypt正式SSL证书

```bash
# 在服务器上执行（必须使用80端口的HTTP方式验证）
sudo apt update
sudo apt install certbot -y

# 申请证书（确保域名解析到服务器IP）
sudo certbot certonly --standalone -d tnho-fasteners.com --email your-email@example.com --agree-tos

# 证书路径：
# /etc/letsencrypt/live/tnho-fasteners.com/fullchain.pem
# /etc/letsencrypt/live/tnho-fasteners.com/privkey.pem
```

#### 步骤2：配置Nginx使用正式证书

```nginx
server {
    listen 443 ssl http2;
    server_name tnho-fasteners.com;

    ssl_certificate /etc/letsencrypt/live/tnho-fasteners.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tnho-fasteners.com/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 静态文件服务
    location /assets/ {
        alias /app/assets/;
    }
}
```

```bash
# 重启Nginx
sudo systemctl restart nginx
```

#### 步骤3：配置Cloudflare SSL/TLS

1. 登录Cloudflare控制台
2. 选择域名 `tnho-fasteners.com`
3. 进入 **SSL/TLS** 设置
4. 将模式设置为 **Full**（不是 Flexible）
5. 确保边缘证书已启用

#### 步骤4：在小程序后台配置服务器域名

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **开发 > 开发管理 > 服务器域名**
3. 添加以下域名：
   - **request合法域名**：`https://tnho-fasteners.com`
   - **uploadFile合法域名**：`https://tnho-fasteners.com`
   - **downloadFile合法域名**：`https://tnho-fasteners.com`

#### 步骤5：修改小程序API地址

```javascript
globalData: {
  // 生产环境（正式上线时使用）：
  apiUrl: 'https://tnho-fasteners.com',
}
```

## 🔧 常见问题排查

### 1. 图片上传失败，显示"网络错误"

**可能原因**：
- 使用了HTTPS + 自签名证书
- 小程序未关闭域名校验

**解决方法**：
```javascript
// 改用HTTP地址
apiUrl: 'http://47.110.72.148',

// 在开发者工具中关闭域名校验
详情 > 本地设置 > 不校验合法域名...
```

### 2. 视频生成失败

**可能原因**：
- 服务器未启动
- API地址错误
- 网络不通

**解决方法**：
```bash
# 检查服务器状态
curl http://47.110.72.148/health

# 应该返回：{"status":"ok"}

# 如果失败，启动服务器
cd /app
python app.py
```

### 3. 进度查询一直显示"任务等待中"

**可能原因**：
- 数据库未连接
- 后台任务未执行

**解决方法**：
```bash
# 检查PostgreSQL容器是否运行
docker ps | grep postgres

# 如果未运行，启动数据库
cd /app
docker-compose -f docker-compose.db.yml up -d

# 检查数据库连接配置
cat .env | grep PGDATABASE_URL
```

### 4. 真机预览时无法访问服务器

**可能原因**：
- 真机无法访问局域网IP
- 防火墙阻止了8000端口

**解决方法**：
```bash
# 检查防火墙规则
sudo iptables -L -n | grep 8000

# 如果没有规则，开放8000端口
sudo iptables -A INPUT -p tcp --dport 8000 -j ACCEPT

# 或使用云服务器的安全组规则
```

## 📋 验证清单

使用小程序前，请确认以下事项：

### 开发环境
- [ ] 小程序API地址已设置为 `http://47.110.72.148`
- [ ] 微信开发者工具已关闭域名校验
- [ ] 服务器应用正在运行（`python app.py`）
- [ ] 健康检查接口正常（`http://47.110.72.148/health`）
- [ ] PostgreSQL数据库容器正在运行
- [ ] 测试图片上传功能成功
- [ ] 测试视频生成功能成功

### 生产环境
- [ ] 已申请Let's Encrypt正式SSL证书
- [ ] Nginx已配置使用正式证书
- [ ] Cloudflare SSL/TLS模式设置为 Full
- [ ] 小程序后台已配置合法域名
- [ ] 小程序API地址已设置为 `https://tnho-fasteners.com`
- [ ] HTTPS访问正常（`curl https://tnho-fasteners.com/health`）

## 🎯 快速修复步骤（开发环境）

如果只想快速测试，按以下步骤操作：

1. **修改小程序配置**
   ```javascript
   // miniprogram/app.js
   apiUrl: 'http://47.110.72.148'
   ```

2. **关闭域名校验**
   ```
   微信开发者工具 > 详情 > 本地设置 > 不校验合法域名...
   ```

3. **启动服务器**
   ```bash
   ssh root@47.110.72.148
   cd /app
   python app.py
   ```

4. **测试API**
   ```bash
   curl http://47.110.72.148/health
   # 应该返回：{"status":"ok"}
   ```

5. **在小程序中测试**
   - 打开小程序
   - 上传图片测试
   - 生成视频测试

## 📞 获取帮助

如果问题仍未解决：

1. 查看服务器日志：
   ```bash
   tail -f app.log
   ```

2. 查看小程序控制台日志（开发者工具 > Console）

3. 运行API测试脚本：
   ```bash
   cd /app/tests
   python test_server_api.py
   ```

4. 根据测试输出排查问题

## 📝 总结

| 环境类型 | API地址 | SSL证书 | 域名校验 | 适用场景 |
|---------|---------|---------|---------|---------|
| **开发环境** | http://47.110.72.148 | 不需要 | 关闭 | 开发调试、测试 |
| **生产环境** | https://tnho-fasteners.com | 正式证书（Let's Encrypt） | 开启 | 正式上线 |

**建议**：
- 开发阶段使用HTTP地址，快速验证功能
- 正式上线前申请正式SSL证书
- 测试阶段使用开发者工具，真机预览可使用HTTP地址（需在局域网内）

---

**最后更新时间**：2025年1月
**适用版本**：小程序 v1.1.0
