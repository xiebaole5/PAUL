<!--pages/index/index.wxml-->
<view class="container">

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="loading-overlay">
    <view class="loading-content">
      <view class="loading-spinner"></view>
      <text class="loading-text">{{loadingText}}</text>
    </view>
  </view>

  <!-- 错误提示 -->
  <view wx:if="{{error}}" class="error-message">
    <text>{{error}}</text>
  </view>

  <!-- 步骤 0: 输入产品信息 -->
  <view wx:if="{{step === 0}}" class="step-container">
    <view class="step-header">
      <text class="step-title">第 1 步：填写产品信息</text>
      <text class="step-desc">填写产品信息，生成广告脚本</text>
    </view>

    <view class="form-section">
      <!-- 产品名称 -->
      <view class="form-item">
        <text class="form-label">产品名称 *</text>
        <input
          class="form-input"
          placeholder="例如：高强度螺栓"
          value="{{formData.productName}}"
          data-field="productName"
          bindinput="onInputChange"
        />
      </view>

      <!-- 使用场景 -->
      <view class="form-item">
        <text class="form-label">使用场景 *</text>
        <textarea
          class="form-textarea"
          placeholder="例如：用于汽车底盘连接，承受高强度拉力"
          value="{{formData.usageScenario}}"
          data-field="usageScenario"
          bindinput="onInputChange"
          maxlength="200"
        />
      </view>

      <!-- 主题方向 -->
      <view class="form-item">
        <text class="form-label">主题方向 *</text>
        <input
          class="form-input"
          placeholder="例如：品质保证、技术创新"
          value="{{formData.themeDirection}}"
          data-field="themeDirection"
          bindinput="onInputChange"
        />
      </view>

      <!-- 产品图片 -->
      <view class="form-item">
        <text class="form-label">产品图片 *</text>
        <view class="upload-section">
          <image wx:if="{{formData.productImageUrl}}" class="preview-image" src="{{formData.productImageUrl}}" mode="aspectFit" />
          <button wx:else class="upload-btn" bindtap="chooseImage">
            <text class="upload-icon">+</text>
            <text>上传图片</text>
          </button>
        </view>
      </view>

      <!-- 提交按钮 -->
      <button class="submit-btn" bindtap="generateScript" disabled="{{loading}}">
        生成脚本
      </button>
    </view>
  </view>

  <!-- 步骤 1: 查看脚本 -->
  <view wx:if="{{step === 1}}" class="step-container">
    <view class="step-header">
      <text class="step-title">第 2 步：查看生成的脚本</text>
      <text class="step-desc">确认脚本内容后继续</text>
    </view>

    <view class="script-content">
      <text class="script-text">{{script}}</text>
    </view>

    <view class="action-buttons">
      <button class="secondary-btn" bindtap="goBack">返回</button>
      <button class="primary-btn" bindtap="confirmScript">确认并继续</button>
    </view>
  </view>

  <!-- 步骤 2: 选择首尾帧图片 -->
  <view wx:if="{{step === 2}}" class="step-container">
    <view class="step-header">
      <text class="step-title">第 3 步：选择首尾帧图片</text>
      <text class="step-desc">各选择一张图片用于视频开头和结尾</text>
    </view>

    <!-- 首帧图片选择 -->
    <view class="frame-section">
      <text class="frame-title">选择首帧图片（视频开头）</text>
      <view class="image-grid">
        <view
          wx:for="{{firstFrames}}"
          wx:key="index"
          class="image-item {{selectedFirstFrame === item ? 'selected' : ''}}"
          data-url="{{item}}"
          bindtap="selectFirstFrame"
        >
          <image class="frame-image" src="{{item}}" mode="aspectFill" />
          <view wx:if="{{selectedFirstFrame === item}}" class="selected-badge">✓</view>
        </view>
      </view>
    </view>

    <!-- 尾帧图片选择 -->
    <view class="frame-section">
      <text class="frame-title">选择尾帧图片（视频结尾）</text>
      <view class="image-grid">
        <view
          wx:for="{{lastFrames}}"
          wx:key="index"
          class="image-item {{selectedLastFrame === item ? 'selected' : ''}}"
          data-url="{{item}}"
          bindtap="selectLastFrame"
        >
          <image class="frame-image" src="{{item}}" mode="aspectFill" />
          <view wx:if="{{selectedLastFrame === item}}" class="selected-badge">✓</view>
        </view>
      </view>
    </view>

    <view class="action-buttons">
      <button class="secondary-btn" bindtap="goBack">返回</button>
      <button class="primary-btn" bindtap="confirmFrames" disabled="{{!selectedFirstFrame || !selectedLastFrame}}">
        生成视频
      </button>
    </view>
  </view>

  <!-- 步骤 3: 视频生成完成 -->
  <view wx:if="{{step === 3}}" class="step-container">
    <!-- 使用用时注入组件 -->
    <video-result
      videoUrl="{{videoUrl}}"
      bind:sharevideo="onShareVideo"
      bind:reset="reset"
    />
  </view>

</view>
