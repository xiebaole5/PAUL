# 服务器问题诊断与修复指南

## 问题概述

根据服务器日志分析，当前存在以下问题：

1. **Nginx 配置冲突**：多个配置文件定义了相同的 `server_name "tnho-fasteners.com"`
2. **SSL 证书问题**：使用自签名证书而非 Let's Encrypt 正式证书
3. **配置重复**：`sites-enabled` 中有多个配置文件链接

---

## 第一步：查看配置文件内容

### 1.1 查看所有配置文件

```bash
# 查看主配置文件
cat /etc/nginx/sites-available/tnho-fasteners.com

# 查看另一个配置文件（如果存在）
cat /etc/nginx/sites-available/tnho-fasteners

# 查看 nginx.conf 中的 include 语句
cat /etc/nginx/nginx.conf | grep include
```

### 1.2 查看启用的配置

```bash
# 查看 sites-enabled 目录
ls -la /etc/nginx/sites-enabled/

# 查看所有配置冲突
grep -r "server_name.*tnho-fasteners.com" /etc/nginx/
```

---

## 第二步：修复配置冲突

### 2.1 删除重复配置

```bash
# 删除旧的配置文件链接
sudo rm -f /etc/nginx/sites-enabled/tnho-fasteners

# 确认只保留 tnho-fasteners.com
ls -la /etc/nginx/sites-enabled/
```

预期输出：
```
total 8
drwxr-xr-x 2 root root 4096 Jan 13 23:52 .
drwxr-xr-x 9 root root 4096 Jan 13 21:57 ..
lrwxrwxrwx 1 root root 45 Jan 13 23:52 tnho-fasteners.com -> /etc/nginx/sites-available/tnho-fasteners.com
```

### 2.2 检查配置文件内容

```bash
# 确保配置文件内容正确
cat /etc/nginx/sites-available/tnho-fasteners.com
```

配置文件应包含：
```nginx
server {
    listen 80;
    server_name tnho-fasteners.com www.tnho-fasteners.com;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$server_name$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name tnho-fasteners.com www.tnho-fasteners.com;

    # SSL 证书配置
    ssl_certificate /etc/letsencrypt/live/tnho-fasteners.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tnho-fasteners.com/privkey.pem;

    # SSL 配置优化
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 反向代理
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

### 2.3 测试配置

```bash
# 测试 Nginx 配置
sudo nginx -t

# 预期输出：无警告，只有 "successful"
```

---

## 第三步：配置 Let's Encrypt SSL 证书

### 3.1 检查证书是否已存在

```bash
# 检查证书目录
ls -la /etc/letsencrypt/live/

# 如果存在，查看证书信息
sudo certbot certificates
```

### 3.2 申请证书（如果不存在）

```bash
# 使用 DNS 验证方式申请证书
sudo certbot certonly --manual --preferred-challenges dns -d tnho-fasteners.com -d www.tnho-fasteners.com

# 或者使用 HTTP 验证（确保域名已解析到服务器 IP）
sudo certbot certonly --webroot -w /var/www/certbot -d tnho-fasteners.com -d www.tnho-fasteners.com
```

**DNS 验证步骤**：
1. 运行 certbot 命令后，系统会提示你添加 TXT 记录
2. 登录 Cloudflare DNS 管理页面
3. 添加以下 TXT 记录：
   - 名称：`_acme-challenge.tnho-fasteners.com`
   - 类型：`TXT`
   - 内容：certbot 提示的值
4. 等待 DNS 生效后，按回车继续

### 3.3 设置证书自动续期

```bash
# 测试自动续期
sudo certbot renew --dry-run

# 设置 cron 任务
sudo crontab -e
```

添加以下内容：
```
0 0 * * * certbot renew --quiet && systemctl reload nginx
```

---

## 第四步：重启服务并测试

### 4.1 重启 Nginx

```bash
# 重新加载配置
sudo systemctl reload nginx

# 或者重启
sudo systemctl restart nginx

# 查看状态
sudo systemctl status nginx
```

### 4.2 测试访问

```bash
# 测试健康检查
curl https://tnho-fasteners.com/health

# 预期输出：
# {"status":"ok"}

# 测试 HTTPS（检查证书）
curl -vI https://tnho-fasteners.com 2>&1 | grep -E "SSL|certificate"
```

预期输出应显示 Let's Encrypt 证书信息：
```
*  subject: CN=tnho-fasteners.com
*  issuer: C=US; O=Let's Encrypt; CN=R11
```

### 4.3 诊断检查清单

```bash
# 检查端口监听
sudo netstat -tlnp | grep nginx

# 应该看到：
# tcp  0.0.0.0:80    LISTEN  nginx
# tcp  0.0.0.0:443   LISTEN  nginx

# 检查应用服务
curl http://127.0.0.1:8000/health

# 预期输出：
# {"status":"ok"}
```

---

## 第五步：配置 Cloudflare SSL/TLS

### 5.1 登录 Cloudflare

1. 访问 https://dash.cloudflare.com
2. 选择 `tnho-fasteners.com` 域名
3. 进入 **SSL/TLS** 选项卡

### 5.2 设置 SSL/TLS 模式

1. 将 SSL/TLS 加密模式设置为 **Full**
2. **不要**选择 "Full (strict)"（除非你有完整的证书链）

**各模式说明**：
- **Flexible**：Cloudflare 到服务器使用 HTTP（不推荐）
- **Full**：Cloudflare 到服务器使用 HTTPS，不验证证书（推荐）
- **Full (strict)**：Cloudflare 到服务器使用 HTTPS，严格验证证书（需要完整的证书链）

### 5.3 验证 DNS 配置

确保 DNS 记录中：
- A 记录：`tnho-fasteners.com` → `47.110.72.148`（橙色云朵，代理开启）
- A 记录：`www.tnho-fasteners.com` → `47.110.72.148`（橙色云朵，代理开启）

### 5.4 测试 Cloudflare 代理访问

```bash
# 通过域名访问（经过 Cloudflare）
curl -I https://tnho-fasteners.com/health

# 应该看到 Cloudflare 响应头：
# cf-ray: ...
# server: cloudflare
```

---

## 第六步：小程序后台配置

### 6.1 配置服务器域名

1. 登录微信公众平台：https://mp.weixin.qq.com
2. 进入 **开发管理** → **开发设置** → **服务器域名**
3. 配置以下域名：
   - **request 合法域名**：`https://tnho-fasteners.com`
   - **uploadFile 合法域名**：`https://tnho-fasteners.com`
   - **downloadFile 合法域名**：`https://tnho-fasteners.com`

### 6.2 修改小程序代码

确保 `miniprogram/app.js` 中的 API 地址为 HTTPS：
```javascript
globalData: {
  apiBaseUrl: 'https://tnho-fasteners.com'
}
```

### 6.3 测试小程序

1. 使用微信开发者工具打开项目
2. 测试图片上传功能
3. 测试视频生成功能
4. 确保所有请求都使用 HTTPS

---

## 常见问题排查

### Q1: Nginx 启动后出现 "conflicting server name" 警告

**原因**：多个配置文件定义了相同的 `server_name`

**解决**：
```bash
# 查找所有包含该 server_name 的配置
grep -r "server_name.*tnho-fasteners.com" /etc/nginx/

# 删除重复的配置文件
sudo rm -f /etc/nginx/sites-enabled/tnho-fasteners

# 重启 Nginx
sudo systemctl restart nginx
```

### Q2: curl 返回 "SSL certificate problem: self-signed certificate"

**原因**：使用了自签名证书，而不是 Let's Encrypt 证书

**解决**：
```bash
# 检查证书
sudo certbot certificates

# 如果没有证书，申请证书
sudo certbot certonly --webroot -w /var/www/certbot -d tnho-fasteners.com -d www.tnho-fasteners.com

# 重新加载 Nginx
sudo systemctl reload nginx
```

### Q3: 小程序无法上传图片

**原因**：域名未配置到小程序后台，或证书问题

**解决**：
1. 确认小程序后台已配置 `https://tnho-fasteners.com` 为合法域名
2. 确认使用 Let's Encrypt 正式证书
3. 确认 Cloudflare SSL/TLS 模式为 Full

### Q4: Cloudflare 显示 520/521/522 错误

**原因**：服务器 Nginx 或应用服务未正常运行

**解决**：
```bash
# 检查 Nginx 状态
sudo systemctl status nginx

# 检查应用服务
ps aux | grep python

# 检查端口监听
sudo netstat -tlnp | grep -E "80|443|8000"
```

---

## 验证清单

完成以上步骤后，请按顺序验证：

- [ ] Nginx 配置测试通过（无警告）
- [ ] Nginx 服务正常运行
- [ ] HTTPS 证书为 Let's Encrypt
- [ ] `curl https://tnho-fasteners.com/health` 返回 `{"status":"ok"}`
- [ ] Cloudflare SSL/TLS 模式为 Full
- [ ] 小程序后台已配置服务器域名
- [ ] 小程序可以正常上传图片
- [ ] 小程序可以正常生成视频

---

## 附录：完整的 Nginx 配置示例

```nginx
# /etc/nginx/sites-available/tnho-fasteners.com

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name tnho-fasteners.com www.tnho-fasteners.com;

    # Let's Encrypt 验证目录
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 其他请求重定向到 HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS 服务器
server {
    listen 443 ssl http2;
    server_name tnho-fasteners.com www.tnho-fasteners.com;

    # SSL 证书
    ssl_certificate /etc/letsencrypt/live/tnho-fasteners.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tnho-fasteners.com/privkey.pem;

    # SSL 协议和加密套件
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;

    # HSTS
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # 日志
    access_log /var/log/nginx/tnho-fasteners-access.log;
    error_log /var/log/nginx/tnho-fasteners-error.log;

    # 客户端上传大小限制
    client_max_body_size 10M;

    # 反向代理到 FastAPI
    location / {
        proxy_pass http://127.0.0.1:8000;

        # 代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

---

## 联系支持

如果遇到问题无法解决，请提供以下信息：
1. Nginx 错误日志：`sudo tail -n 50 /var/log/nginx/error.log`
2. 应用错误日志
3. curl 测试结果
4. Nginx 配置文件内容
