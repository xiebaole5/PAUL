# 小程序正式发布指南

## 发布前检查清单

在提交小程序审核前，请确保以下所有项目都已完成：

---

## 一、服务器配置检查

### 1.1 Nginx 配置

- [ ] Nginx 配置文件正确，无冲突警告
- [ ] Nginx 服务正在运行：`sudo systemctl status nginx`
- [ ] 监听 80 和 443 端口：`sudo netstat -tlnp | grep nginx`

### 1.2 SSL 证书

- [ ] 已申请 Let's Encrypt 证书
- [ ] 证书未过期（有效期至 2026-04-13）
- [ ] HTTPS 访问正常：`curl https://tnho-fasteners.com/health` 返回 `{"status":"ok"}`

### 1.3 应用服务

- [ ] FastAPI 应用正在运行：`ps aux | grep python`
- [ ] 应用监听 8000 端口：`sudo netstat -tlnp | grep 8000`
- [ ] 数据库连接正常

### 1.4 Cloudflare 配置

- [ ] DNS A 记录正确配置（已代理）
- [ ] SSL/TLS 模式设置为 Full
- [ ] Always Use HTTPS 已开启

---

## 二、小程序代码检查

### 2.1 API 地址配置

**检查文件**：`miniprogram/app.js`

确保 `globalData` 中的 API 地址为生产环境 HTTPS：

```javascript
globalData: {
  apiBaseUrl: 'https://tnho-fasteners.com'
}
```

❌ **不要使用**：
- `http://47.110.72.148:8000`（HTTP + IP）
- `http://tnho-fasteners.com`（HTTP）
- `https://47.110.72.148`（HTTPS + IP，证书不匹配）

### 2.2 AppID 配置

**检查文件**：`miniprogram/project.config.json`

```json
{
  "appid": "wx464504ca7e01b3b1",
  ...
}
```

### 2.3 功能测试

在小程序中完成以下测试：

#### 图片上传测试
- [ ] 上传图片不报错
- [ ] 上传进度显示正常
- [ ] 上传成功后返回图片 URL

#### 视频生成测试
- [ ] 选择视频时长（15/20/25/30秒）
- [ ] 选择主题（品质保证/技术创新/工业应用/品牌形象）
- [ ] 提交生成请求成功
- [ ] 进度轮询正常工作
- [ ] 视频生成成功并返回可访问 URL

#### 错误处理测试
- [ ] 网络错误提示友好
- [ ] 生成失败有明确原因
- [ ] 超时有友好提示

### 2.4 用户体验检查

- [ ] 界面加载流畅
- [ ] 按钮点击响应及时
- [ ] 进度提示清晰
- [ ] 视频播放正常
- [ ] 文字描述清晰易懂

---

## 三、小程序后台配置

### 3.1 登录微信公众平台

访问：https://mp.weixin.qq.com

### 3.2 配置服务器域名

1. 进入 **开发管理** → **开发设置** → **服务器域名**
2. 添加以下合法域名：

| 域名类型 | 域名地址 |
|----------|----------|
| request 合法域名 | `https://tnho-fasteners.com` |
| uploadFile 合法域名 | `https://tnho-fasteners.com` |
| downloadFile 合法域名 | `https://tnho-fasteners.com` |

**注意**：
- 域名必须使用 HTTPS
- 域名必须是备案域名
- 域名必须与小程序 AppID 关联

### 3.3 配置隐私设置

1. 进入 **设置** → **基本设置** → **用户隐私保护指引**
2. 填写隐私指引：

```
本小程序为用户生成天虹紧固件产品宣传短视频，我们需要收集以下信息：

1. 用户上传的产品图片：用于生成视频内容
2. 用户输入的使用场景描述：用于定制视频内容

我们承诺：
- 仅用于生成视频，不会用于其他目的
- 不会向第三方泄露用户信息
- 用户可随时删除上传的图片

联系方式：[填写联系方式]
```

### 3.4 配置客服联系方式

1. 进入 **客服** → **客服人员**
2. 添加客服人员信息

---

## 四、小程序审核准备

### 4.1 准备审核材料

**必需材料**：
1. 小程序截图（3-5 张）
   - 首页截图
   - 图片上传页截图
   - 视频生成页截图
   - 视频预览页截图
   - 成功生成后的结果页截图

2. 测试账号（如需登录）
   - 本小程序无需登录，无需提供

3. 功能说明
   - 简要描述小程序功能
   - 说明使用场景
   - 说明技术实现

### 4.2 功能说明模板

```
小程序名称：天虹紧固件视频助手
AppID：wx464504ca7e01b3b1

功能描述：
本小程序利用AI技术帮助用户快速生成天虹紧固件产品宣传短视频。

主要功能：
1. 图片上传：用户可上传产品图片作为视频参考
2. 场景定制：用户可输入使用场景描述，定制视频内容
3. 视频生成：AI 自动生成 15-30 秒的宣传视频
4. 多主题支持：支持品质保证、技术创新、工业应用、品牌形象等主题

技术实现：
- 前端：微信小程序（云开发）
- 后端：Python FastAPI
- AI 模型：火山方舟 doubao-seedance-1-5-pro-251215
- 视频拼接：moviepy
- 存储：对象存储（阿里云 OSS）

服务器信息：
- API 地址：https://tnho-fasteners.com
- 服务器：阿里云 ECS
- SSL 证书：Let's Encrypt

测试说明：
1. 点击"上传图片"选择产品图片
2. 选择视频时长和主题
3. 输入使用场景描述（可选）
4. 点击"生成视频"按钮
5. 等待 1-2 分钟视频生成完成
6. 预览并下载视频
```

---

## 五、提交审核

### 5.1 上传代码

1. 打开微信开发者工具
2. 点击右上角 **上传** 按钮
3. 填写版本号（如：1.0.0）
4. 填写项目备注（如：正式版本，支持图生视频）

### 5.2 提交审核

1. 登录微信公众平台
2. 进入 **版本管理** → **审核版本**
3. 点击 **提交审核**
4. 填写审核信息：
   - 审核说明：简要描述小程序功能和本次更新内容
   - 上传测试截图（必需）
   - 填写功能说明（必需）

### 5.3 审核说明模板

```
本次提交为小程序正式版本上线申请。

主要功能：
1. 用户可上传产品图片，AI 自动生成 15-30 秒的宣传视频
2. 支持多种主题：品质保证、技术创新、工业应用、品牌形象
3. 支持场景定制，用户可输入使用场景描述
4. 实时显示生成进度，生成完成后可直接预览和下载

技术特点：
- 使用火山方舟视频生成模型（doubao-seedance-1-5-pro-251215）
- 支持图生视频，提升视频精准度
- 异步任务处理，避免超时
- 使用对象存储，视频长期可访问

使用场景：
为天虹紧固件产品快速生成高质量宣传视频，节省制作成本和时间。

测试说明：
1. 点击"上传图片"选择产品图片
2. 选择视频时长和主题
3. 输入使用场景描述（可选）
4. 点击"生成视频"按钮
5. 等待视频生成完成
6. 预览并下载视频

服务器配置：
- API 地址：https://tnho-fasteners.com
- 已配置 Let's Encrypt SSL 证书
- 已配置 Cloudflare CDN 加速

注意事项：
- 小程序无需用户登录
- 上传的图片仅用于视频生成，不会用于其他目的
- 生成的视频会保存到对象存储，用户可下载使用
```

---

## 六、审核流程

### 6.1 审核时间

- **常规审核**：1-7 个工作日
- **加速审核**：1-3 个工作日（需要额外费用）

### 6.2 审核结果

审核结果会通过以下方式通知：
- 微信公众平台消息通知
- 微信开发者工具通知

### 6.3 常见审核拒绝原因

#### 原因1：功能不完整
**问题**：小程序功能未完全实现或无法使用
**解决**：确保所有功能都正常可用，提交前充分测试

#### 原因2：UI/UX 问题
**问题**：界面设计不符合规范或用户体验差
**解决**：参考《微信小程序设计规范》，优化界面设计

#### 原因3：内容违规
**问题**：小程序内容包含违法违规信息
**解决**：检查所有文案和图片，确保内容合法合规

#### 原因4：服务器问题
**问题**：服务器访问失败或响应慢
**解决**：
- 确认服务器正常运行
- 确认 API 访问正常
- 优化服务器响应速度

#### 原因5：隐私问题
**问题**：用户隐私保护不到位
**解决**：
- 完善隐私指引
- 明确说明数据用途
- 提供用户删除数据的方式

---

## 七、审核通过后

### 7.1 发布上线

1. 审核通过后，进入 **版本管理** → **线上版本**
2. 点击 **发布** 按钮
3. 确认发布信息
4. 小程序正式上线

### 7.2 监控和优化

#### 监控指标
- 每日活跃用户数（DAU）
- 视频生成成功率
- 视频生成平均耗时
- 用户反馈和投诉

#### 优化方向
- 优化视频生成速度
- 提升视频质量
- 改善用户体验
- 增加更多主题和功能

### 7.3 数据统计

进入微信公众平台 **统计** 页面查看：
- 用户访问分析
- 用户画像分析
- 功能使用统计

---

## 八、后续维护

### 8.1 证书续期

Let's Encrypt 证书有效期 90 天，建议配置自动续期：

```bash
# 设置自动续期
sudo crontab -e
```

添加：
```
0 0 * * * certbot renew --quiet && systemctl reload nginx
```

### 8.2 版本更新

当需要更新功能时：
1. 修改代码
2. 本地测试
3. 上传新版本
4. 提交审核
5. 审核通过后发布

### 8.3 服务器维护

定期执行：
- 更新系统安全补丁
- 检查磁盘空间
- 清理日志文件
- 备份数据库

---

## 九、应急预案

### 9.1 服务器宕机

**症状**：小程序无法访问服务器

**处理步骤**：
1. 检查服务器状态：`ping tnho-fasteners.com`
2. 检查 Nginx 状态：`sudo systemctl status nginx`
3. 检查应用状态：`ps aux | grep python`
4. 查看错误日志：`sudo tail -f /var/log/nginx/error.log`
5. 重启服务：`sudo systemctl restart nginx`

### 9.2 证书过期

**症状**：浏览器提示证书过期

**处理步骤**：
1. 手动续期证书：`sudo certbot renew`
2. 重载 Nginx：`sudo systemctl reload nginx`
3. 检查证书：`sudo certbot certificates`

### 9.3 视频生成失败

**症状**：用户反馈视频生成失败

**处理步骤**：
1. 检查火山方舟 API 状态
2. 检查 API Key 是否有效
3. 检查服务器磁盘空间
4. 查看应用日志
5. 联系火山方舟技术支持

### 9.4 Cloudflare 故障

**症状**：通过域名无法访问，但 IP 可以访问

**处理步骤**：
1. 检查 Cloudflare 状态：https://www.cloudflarestatus.com/
2. 临时关闭 Cloudflare 代理（DNS 记录改为仅 DNS）
3. 直接通过 IP 访问（需配置 IP 访问支持）

---

## 十、联系信息

### 技术支持
- 服务器：阿里云 ECS (47.110.72.148)
- GitHub 仓库：https://github.com/xiebaole5/PAUL.git

### 官方文档
- 微信小程序官方文档：https://developers.weixin.qq.com/miniprogram/dev/framework/
- Cloudflare 文档：https://developers.cloudflare.com/
- Let's Encrypt 文档：https://letsencrypt.org/docs/

---

## 快速检查命令

在服务器上执行以下命令快速检查：

```bash
#!/bin/bash

echo "=== 服务器状态检查 ==="
echo

echo "1. Nginx 状态："
sudo systemctl status nginx --no-pager | head -n 5
echo

echo "2. 端口监听："
sudo netstat -tlnp | grep -E "80|443|8000"
echo

echo "3. 应用进程："
ps aux | grep "python.*app.py" | grep -v grep
echo

echo "4. HTTPS 测试："
curl -s -o /dev/null -w "%{http_code}" https://tnho-fasteners.com/health
echo

echo "5. 证书有效期："
sudo certbot certificates | grep -A 2 "tnho-fasteners.com"
echo

echo "=== 检查完成 ==="
```

---

## 发布时间表建议

### 最佳发布时间
- **工作日**：周二至周四
- **时段**：上午 10:00 - 11:00 或 下午 14:00 - 16:00
- **避开节假日**：避免在节假日前后发布

### 发布前1天
- 再次测试所有功能
- 检查服务器状态
- 准备审核材料
- 通知相关人员

### 发布当天
- 确认服务器正常运行
- 确认所有配置正确
- 提交审核
- 准备应对审核反馈

### 发布后1周
- 密切监控服务器状态
- 收集用户反馈
- 处理可能出现的问题
- 优化性能和体验

---

**祝发布顺利！** 🎉
