# 小程序端功能测试指南

## 测试准备

### 1. 确保服务器端应用正常运行
```bash
# 在服务器上执行
cd /root/tnho-video
ps aux | grep uvicorn
```

应该看到类似的输出：
```
root  3980  python -m uvicorn src.api.app:app --host 0.0.0.0 --port 8000
```

### 2. 配置小程序服务器域名
在微信小程序后台配置以下域名白名单：
- **request**: `https://tnho-fasteners.com`
- **uploadFile**: `https://tnho-fasteners.com`
- **downloadFile**: `https://tnho-fasteners.com`

### 3. 确认小程序 API 地址
检查小程序代码中的 API 地址配置：

**`miniprogram/app.js`**:
```javascript
App({
  globalData: {
    apiUrl: 'https://tnho-fasteners.com'  // 确保使用 HTTPS
  }
})
```

**`miniprogram/pages/index/index.js`**:
```javascript
const app = getApp();
const apiUrl = app.globalData.apiUrl;
```

---

## 测试用例

### 测试用例 1: 图片上传功能

**测试步骤**:
1. 打开小程序
2. 点击"上传产品图片"按钮
3. 选择一张本地图片
4. 检查返回结果

**预期结果**:
- ✅ 图片上传成功提示
- ✅ 图片预览正常显示
- ✅ 图片 URL 为 HTTPS 地址（https://tnho-fasteners.com/...）

**可能的问题**:
- ❌ "上传图片失败" → 检查服务器是否运行，检查网络连接
- ❌ "Mixed Content 错误" → 确认 API 地址是 HTTPS

---

### 测试用例 2: 视频生成功能（无图片）

**测试步骤**:
1. 输入产品名称：`高强度螺栓`
2. 选择主题：`品质保证`
3. 选择时长：`5秒`
4. 点击"生成视频"按钮
5. 观察进度条和状态提示

**预期结果**:
- ✅ 显示"任务已创建"提示
- ✅ 进度条开始更新（每2秒轮询一次）
- ✅ 状态显示"生成中..."
- ✅ 约20秒后显示"生成完成"
- ✅ 显示视频播放器或下载链接

**可能的问题**:
- ❌ "创建任务失败" → 检查服务器日志，检查数据库连接
- ❌ 进度长时间不更新 → 检查后台任务是否正常执行
- ❌ "任务失败" → 查看错误信息，检查 API Key 配置

---

### 测试用例 3: 视频生成功能（带图片）

**测试步骤**:
1. 点击"上传产品图片"按钮
2. 选择一张产品图片
3. 输入产品名称：`六角螺母`
4. 输入使用场景：`建筑工地重型机械连接`
5. 选择主题：`工业应用`
6. 选择时长：`10秒`
7. 点击"生成视频"按钮

**预期结果**:
- ✅ 图片上传成功
- ✅ 图片预览显示
- ✅ 任务创建成功
- ✅ 生成的视频包含产品图片元素（图生视频功能）
- ✅ 视频内容与"建筑工地"场景相关

**可能的问题**:
- ❌ 图片上传失败 → 检查文件大小是否超过 5MB
- ❌ 视频生成失败 → 检查火山方舟 API 配置

---

### 测试用例 4: 脚本生成功能

**测试步骤**:
1. 输入产品名称：`不锈钢螺丝`
2. 选择主题：`技术创新`
3. 选择时长：`15秒`
4. 点击"生成脚本"按钮

**预期结果**:
- ✅ 直接返回脚本内容（不需要等待）
- ✅ 脚本包含：场景描述、文案/旁白、音效
- ✅ 脚本内容与"技术创新"主题相关
- ✅ 脚本时长为15秒

**可能的问题**:
- ❌ "脚本生成失败" → 检查 LLM API 配置

---

### 测试用例 5: 多段视频拼接（20秒）

**测试步骤**:
1. 输入产品名称：`高强度螺栓`
2. 选择主题：`品质保证`
3. 选择时长：`20秒`
4. 点击"生成视频"按钮

**预期结果**:
- ✅ 任务创建成功（total_parts: 2）
- ✅ 进度显示"正在生成第1段..."
- ✅ 进度显示"正在生成第2段..."
- ✅ 进度显示"正在拼接视频..."
- ✅ 进度显示"正在上传视频..."
- ✅ 最终显示"生成完成"
- ✅ 返回拼接后的视频 URL

**可能的问题**:
- ❌ 拼接失败 → 检查 moviepy 是否正常工作
- ❌ 上传失败 → 检查对象存储配置

---

### 测试用例 6: 错误处理

**测试步骤**:
1. 输入无效的产品名称（留空）
2. 点击"生成视频"按钮

**预期结果**:
- ✅ 显示友好的错误提示
- ✅ 提示具体的问题（如"请输入产品名称"）

**测试步骤**:
1. 在网络断开的情况下操作

**预期结果**:
- ✅ 显示网络错误提示
- ✅ 提示用户检查网络连接

---

## 调试工具

### 1. 查看小程序控制台日志
1. 打开微信开发者工具
2. 点击"调试器"标签
3. 查看 Console 输出

关键日志信息：
- 请求 URL 和参数
- 响应数据
- 错误信息

### 2. 查看服务器日志
```bash
# 在服务器上执行
tail -f /root/tnho-video/logs/app.log
```

### 3. 检查 API 响应
在浏览器中直接访问：
- `https://tnho-fasteners.com/health` - 健康检查
- `https://tnho-fasteners.com/api/progress/{task_id}` - 查询任务进度

---

## 常见问题排查

### 问题 1: Mixed Content 错误

**现象**: 小程序控制台显示"Mixed Content"错误

**原因**: 图片 URL 使用 HTTP 协议

**解决方案**:
- 确认 `EXTERNAL_BASE_URL` 环境变量配置为 `https://tnho-fasteners.com`
- 检查 `src/api/app.py` 中的默认 URL 配置
- 重启服务器应用

---

### 问题 2: 请求超时

**现象**: 小程序提示"请求超时"

**原因**: 请求超时时间设置过短

**解决方案**:
- 确认小程序请求超时时间为 30 秒（`pages/index/index.js`）
- 检查网络连接
- 检查服务器响应时间

---

### 问题 3: 数据库连接失败

**现象**: 服务器日志显示"database connection failed"

**原因**: 数据库配置错误或连接池耗尽

**解决方案**:
- 检查 `.env` 文件中的 `PGDATABASE_URL`
- 重启应用
- 执行 `bash scripts/optimize-db.sh` 优化数据库配置

---

### 问题 4: 视频生成失败

**现象**: 任务状态显示"failed"

**原因**: API Key 错误或火山方舟服务不可用

**解决方案**:
- 检查 `.env` 文件中的 `ARK_API_KEY`
- 查看服务器日志中的详细错误信息
- 测试火山方舟 API 连接

---

## 测试检查清单

完成以下所有测试项后，标记为 [✅]：

- [ ] 图片上传功能正常
- [ ] 图片 URL 为 HTTPS 协议
- [ ] 5秒视频生成成功
- [ ] 20秒视频生成成功（包含拼接）
- [ ] 脚本生成成功
- [ ] 图生视频功能正常
- [ ] 进度查询正常
- [ ] 错误提示友好
- [ ] 所有请求使用 HTTPS 协议
- [ ] 没有 Mixed Content 错误

---

## 联系与反馈

如遇到问题，请提供以下信息：

1. 小程序控制台的完整错误日志
2. 服务器日志（`logs/app.log`）
3. 测试步骤和预期结果
4. 浏览器或小程序版本信息
