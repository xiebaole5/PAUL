# 服务器快速执行脚本

## 修复数据库连接问题

### 步骤1：拉取最新代码
```bash
cd /root/tnho-video
git pull origin main
```

### 步骤2：重启应用
```bash
bash scripts/restart-app.sh
```

### 步骤3：验证修复
```bash
# 进入虚拟环境
source venv/bin/activate

# 测试环境变量加载
python -c "from dotenv import load_dotenv; load_dotenv(); import os; print('EXTERNAL_BASE_URL:', os.getenv('EXTERNAL_BASE_URL')); print('PGDATABASE_URL:', os.getenv('PGDATABASE_URL', 'Not found'))"

# 测试数据库连接
python -c "from storage.database.db import get_session; db = get_session(); print('✓ 数据库连接成功'); db.close()"

# 测试健康检查接口
curl -s https://tnho-fasteners.com/api/health | python -m json.tool
```

### 步骤4：测试图片上传
```bash
# 假设有一个测试图片
curl -X POST https://tnho-fasteners.com/api/upload-image \
  -F "file=@/tmp/test.jpg" \
  | python -m json.tool
```

### 查看日志
```bash
# 查看应用日志
tail -f /root/tnho-video/logs/app.log

# 查看错误日志
tail -f /root/tnho-video/logs/error.log
```

### 检查进程
```bash
ps aux | grep uvicorn
```

## 预期输出

### 环境变量测试
```
EXTERNAL_BASE_URL: https://tnho-fasteners.com
PGDATABASE_URL: postgresql://tnho_user:*****@localhost:5432/tnho_video
```

### 数据库连接测试
```
✓ 数据库连接成功
```

### 健康检查接口
```json
{
  "status": "ok"
}
```

### 图片上传接口
```json
{
  "success": true,
  "message": "图片上传成功",
  "image_url": "https://tnho-fasteners.com/assets/uploads/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.jpg",
  "filename": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx.jpg"
}
```

## 如果遇到问题

### 问题1：虚拟环境未激活
```bash
source /root/tnho-video/venv/bin/activate
```

### 问题2：.env 文件不存在
```bash
cd /root/tnho-video
ls -la .env
```

### 问题3：数据库未启动
```bash
docker ps | grep postgres
docker start tnho-postgres
```

### 问题4：Nginx 未启动
```bash
systemctl status nginx
systemctl start nginx
```

## 完整的一键执行命令

```bash
#!/bin/bash
set -e

echo "=== 修复数据库连接问题 ==="

cd /root/tnho-video
echo "1. 拉取最新代码..."
git pull origin main

echo "2. 重启应用..."
bash scripts/restart-app.sh

echo "3. 验证修复..."
source venv/bin/activate
python -c "from dotenv import load_dotenv; load_dotenv(); import os; print('EXTERNAL_BASE_URL:', os.getenv('EXTERNAL_BASE_URL', 'Not found'))"
python -c "from storage.database.db import get_session; db = get_session(); print('✓ 数据库连接成功'); db.close()"

echo "4. 测试 API..."
curl -s https://tnho-fasteners.com/api/health | python -m json.tool

echo "=== 修复完成 ==="
```

将上述脚本保存为 `fix.sh`，然后执行：
```bash
chmod +x fix.sh
bash fix.sh
```
