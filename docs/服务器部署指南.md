# 天虹紧固件视频生成服务 - 服务器部署指南

## 前提条件

### 服务器配置
- 操作系统：Linux（推荐 Debian/Ubuntu/CentOS）
- 配置：2核CPU，4GB内存
- 已安装：Docker、Python 3.12+
- 网络：公网访问能力（IP: 47.110.72.148）

### 域名配置
- 域名：tnho-fasteners.com
- DNS 解析：A 记录指向 47.110.72.148
- SSL 证书：Let's Encrypt（已配置，有效期至 2026-04-13）

### 微信小程序配置
- AppID：wx464504ca7e01b3b1
- 服务器域名：https://tnho-fasteners.com
- 需要配置的接口类型：request、uploadFile、downloadFile

---

## 快速部署（推荐）

### 步骤 1：克隆部署脚本到服务器

在本地电脑上执行：

```bash
# 下载代码
git clone https://github.com/xiebaole5/PAUL.git
cd PAUL
```

### 步骤 2：上传代码到服务器

将整个项目上传到服务器：

```bash
# 方式1：使用 scp 上传
scp -r PAUL root@47.110.72.148:/root/

# 方式2：在服务器上直接克隆（推荐）
ssh root@47.110.72.148
cd /root
git clone https://github.com/xiebaole5/PAUL.git
cd PAUL
```

### 步骤 3：执行部署脚本

在服务器上执行：

```bash
cd /root/PAUL
chmod +x scripts/*.sh
bash scripts/deploy.sh
```

部署脚本会自动完成以下任务：
1. 克隆代码仓库
2. 创建 Python 虚拟环境
3. 安装依赖包
4. 启动 PostgreSQL 数据库（Docker 容器）
5. 初始化数据库表结构
6. 创建 systemd 服务

### 步骤 4：配置环境变量

编辑 `.env` 文件：

```bash
vim /root/PAUL/.env
```

**必须配置的变量：**

```env
# 数据库配置（默认即可）
PGDATABASE_URL=postgresql://postgres:postgres123@localhost:5432/tnho_video

# 对象存储配置（必须填写正确的密钥）
S3_ENDPOINT=https://s3-cn-north-4.volces.com
S3_ACCESS_KEY_ID=your_access_key_here
S3_SECRET_ACCESS_KEY=your_secret_key_here
S3_BUCKET=your_bucket_name_here
S3_REGION=cn-north-4

# 外部访问 URL
EXTERNAL_BASE_URL=https://tnho-fasteners.com

# API 配置（默认即可）
ARK_API_KEY=39bf20d0-55b5-4957-baa1-02f4529a3076

# 调试模式
DEBUG=False
```

### 步骤 5：启动服务

```bash
# 使用启动脚本
bash /root/PAUL/scripts/start-service.sh

# 或使用 systemctl
systemctl start tnho-api

# 查看服务状态
systemctl status tnho-api

# 查看实时日志
journalctl -u tnho-api -f
```

### 步骤 6：配置 Nginx（如需要）

如果尚未配置 Nginx 反向代理：

```bash
# 创建 Nginx 配置
vim /etc/nginx/conf.d/tnho-api.conf
```

Nginx 配置示例：

```nginx
server {
    listen 80;
    server_name tnho-fasteners.com 47.110.72.148;

    # 上传文件大小限制（100MB）
    client_max_body_size 100M;
    client_body_timeout 300s;

    # 反向代理到 FastAPI 服务
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置（5分钟，用于长时间视频生成）
        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
    }

    # API 文档接口
    location /docs {
        proxy_pass http://127.0.0.1:8000/docs;
        proxy_set_header Host $host;
    }
}

# HTTPS 配置（已配置 Let's Encrypt 证书）
server {
    listen 443 ssl http2;
    server_name tnho-fasteners.com;

    ssl_certificate /etc/letsencrypt/live/tnho-fasteners.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tnho-fasteners.com/privkey.pem;

    client_max_body_size 100M;
    client_body_timeout 300s;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 300;
        proxy_send_timeout 300;
        proxy_read_timeout 300;
    }
}
```

测试并重载 Nginx：

```bash
nginx -t
systemctl reload nginx
```

### 步骤 7：测试 API 服务

```bash
# 测试健康检查接口
curl http://127.0.0.1:8000/health

# 测试外部访问
curl https://tnho-fasteners.com/health

# 查看 API 文档
# 浏览器访问：https://tnho-fasteners.com/docs
```

---

## 手动部署步骤

如果自动部署脚本失败，可以手动执行以下步骤：

### 1. 安装依赖

```bash
# 安装 Docker
curl -fsSL https://get.docker.com | sh
systemctl start docker
systemctl enable docker

# 安装 Python 3.12（如果尚未安装）
apt-get update
apt-get install -y python3.12 python3.12-venv python3-pip
```

### 2. 克隆代码

```bash
cd /root
git clone https://github.com/xiebaole5/PAUL.git
cd PAUL
```

### 3. 创建虚拟环境

```bash
python3.12 -m venv venv
source venv/bin/activate

# 配置国内镜像源
pip config set global.index-url https://mirrors.aliyun.com/pypi/simple/

# 升级 pip
pip install --upgrade pip

# 安装依赖
pip install -r requirements.txt
```

### 4. 启动 PostgreSQL

```bash
docker run -d \
    --name tnho-postgres \
    -e POSTGRES_DB=tnho_video \
    -e POSTGRES_USER=postgres \
    -e POSTGRES_PASSWORD=postgres123 \
    -p 5432:5432 \
    -v tnho-postgres-data:/var/lib/postgresql/data \
    --restart unless-stopped \
    postgres:15

# 等待数据库启动
sleep 10

# 初始化数据库表
python -c "
import asyncio
from src.storage.database.db import get_engine
from src.storage.database.models import Base

engine = get_engine()
Base.metadata.create_all(bind=engine)
print('数据库表创建成功')
"
```

### 5. 配置环境变量

创建 `.env` 文件并填写正确的配置（参考上面的配置示例）。

### 6. 创建 systemd 服务

```bash
cat > /etc/systemd/system/tnho-api.service << 'EOF'
[Unit]
Description=天虹紧固件视频生成 API 服务
After=network.target tnho-postgres.service docker.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/PAUL
Environment="PATH=/root/PAUL/venv/bin"
ExecStart=/root/PAUL/venv/bin/python app.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 重载 systemd
systemctl daemon-reload
```

### 7. 启动服务

```bash
systemctl start tnho-api
systemctl status tnho-api
```

---

## 常用命令

### 服务管理

```bash
# 启动服务
systemctl start tnho-api
bash /root/PAUL/scripts/start-service.sh

# 停止服务
systemctl stop tnho-api
bash /root/PAUL/scripts/stop-service.sh

# 重启服务
systemctl restart tnho-api
bash /root/PAUL/scripts/restart-service.sh

# 查看服务状态
systemctl status tnho-api

# 查看实时日志
journalctl -u tnho-api -f

# 查看最近 50 条日志
journalctl -u tnho-api -n 50

# 查看完整日志
journalctl -u tnho-api --since today
```

### 数据库管理

```bash
# 查看 PostgreSQL 容器状态
docker ps | grep tnho-postgres

# 进入 PostgreSQL 容器
docker exec -it tnho-postgres psql -U postgres -d tnho_video

# 查看数据库连接
docker exec -it tnho-postgres psql -U postgres -d tnho_video -c "SELECT * FROM pg_stat_activity;"

# 查看数据库大小
docker exec -it tnho-postgres psql -U postgres -d tnho_video -c "SELECT pg_size_pretty(pg_database_size('tnho_video'));"

# 备份数据库
docker exec tnho-postgres pg_dump -U postgres tnho_video > backup.sql

# 恢复数据库
docker exec -i tnho-postgres psql -U postgres tnho_video < backup.sql
```

### 日志查看

```bash
# 查看 FastAPI 应用日志
journalctl -u tnho-api -f

# 查看 PostgreSQL 日志
docker logs tnho-postgres -f

# 查看 Nginx 日志
tail -f /var/log/nginx/access.log
tail -f /var/log/nginx/error.log
```

---

## 故障排查

### 问题 1：服务无法启动

**症状：** `systemctl start tnho-api` 后服务立即退出

**排查步骤：**

```bash
# 查看详细日志
journalctl -u tnho-api -n 100 --no-pager

# 常见原因：
# 1. .env 文件不存在或配置错误
ls -la /root/PAUL/.env

# 2. 数据库连接失败
docker ps | grep tnho-postgres

# 3. Python 依赖未安装
cd /root/PAUL
source venv/bin/activate
pip list
```

### 问题 2：数据库连接失败

**症状：** 日志显示 `psycopg2.OperationalError`

**排查步骤：**

```bash
# 1. 检查 PostgreSQL 容器状态
docker ps | grep tnho-postgres

# 2. 检查容器日志
docker logs tnho-postgres

# 3. 测试数据库连接
docker exec -it tnho-postgres psql -U postgres -d tnho_video -c "SELECT 1;"

# 4. 检查 .env 文件中的数据库连接字符串
cat /root/PAUL/.env | grep PGDATABASE_URL
```

**修复方法：**

```bash
# 重启 PostgreSQL 容器
docker restart tnho-postgres

# 如果容器已损坏，重新创建
docker stop tnho-postgres
docker rm tnho-postgres
docker volume rm tnho-postgres-data

# 重新运行部署脚本
bash /root/PAUL/scripts/deploy.sh
```

### 问题 3：API 接口超时

**症状：** 小程序调用 API 超时

**排查步骤：**

```bash
# 1. 检查服务状态
systemctl status tnho-api

# 2. 检查 CPU 和内存使用情况
top

# 3. 检查数据库连接数
docker exec -it tnho-postgres psql -U postgres -d tnho_video -c "SELECT count(*) FROM pg_stat_activity;"

# 4. 查看应用日志
journalctl -u tnho-api -f
```

**优化建议：**

- 降低数据库连接池大小（已优化：pool_size=10, max_overflow=10）
- 缩短 SQL 执行超时时间（已优化：statement_timeout=30s）
- 使用上下文管理器确保连接正确关闭（已实现）

### 问题 4：视频生成失败

**症状：** 任务状态为 `failed`

**排查步骤：**

```bash
# 1. 查看任务错误信息
docker exec -it tnho-postgres psql -U postgres -d tnho_video -c "SELECT task_id, status, error_message FROM video_generation_tasks WHERE status='failed' ORDER BY created_at DESC LIMIT 5;"

# 2. 查看应用日志
journalctl -u tnho-api -f

# 3. 检查对象存储配置
cat /root/PAUL/.env | grep S3_

# 4. 检查 API Key
cat /root/PAUL/.env | grep ARK_API_KEY
```

### 问题 5：Nginx 502 Bad Gateway

**症状：** 访问域名返回 502 错误

**排查步骤：**

```bash
# 1. 检查 FastAPI 服务是否运行
systemctl status tnho-api

# 2. 测试本地访问
curl http://127.0.0.1:8000/health

# 3. 检查 Nginx 配置
nginx -t

# 4. 查看 Nginx 错误日志
tail -f /var/log/nginx/error.log
```

---

## 性能优化

### 数据库连接池配置

当前配置（适配 4GB 内存服务器）：

```python
# src/storage/database/db.py
pool_size=10           # 连接池大小
max_overflow=10       # 最大溢出连接数
pool_timeout=30       # 连接超时（秒）
pool_recycle=1800     # 连接回收时间（30分钟）
connect_timeout=5     # 连接超时（秒）
statement_timeout=30  # SQL 执行超时（秒）
```

最大连接数 = pool_size + max_overflow = 20

内存占用 ≈ 20 × 5MB = 100MB

### Nginx 超时配置

```nginx
client_max_body_size 100M;      # 上传文件大小限制
client_body_timeout 300s;        # 客户端请求体超时
proxy_connect_timeout 300;       # 连接超时
proxy_send_timeout 300;          # 发送超时
proxy_read_timeout 300;          # 读取超时
```

---

## 安全建议

1. **数据库密码**：生产环境请修改默认密码（postgres123）
2. **API Key**：不要将敏感信息提交到 Git
3. **SSL 证书**：确保 HTTPS 正确配置
4. **防火墙**：只开放必要的端口（80, 443, 22）
5. **日志监控**：定期检查日志文件

---

## 更新部署

当代码有更新时：

```bash
cd /root/PAUL

# 拉取最新代码
git pull origin main

# 重新安装依赖（如有变化）
source venv/bin/activate
pip install -r requirements.txt

# 重启服务
systemctl restart tnho-api

# 查看状态
systemctl status tnho-api
```

---

## 小程序配置

### 微信小程序后台配置

登录微信小程序后台（mp.weixin.qq.com）：

1. **开发管理** → **服务器域名**
2. 配置以下域名：
   - request 合法域名：`https://tnho-fasteners.com`
   - uploadFile 合法域名：`https://tnho-fasteners.com`
   - downloadFile 合法域名：`https://tnho-fasteners.com`
3. 保存并生效

### 小程序代码配置

确保 `app.js` 中配置正确的 API 地址：

```javascript
// app.js
App({
  globalData: {
    apiUrl: 'https://tnho-fasteners.com'  // 生产环境
    // apiUrl: 'http://47.110.72.148'     // 开发环境
  },
  onLaunch() {
    console.log('小程序启动');
  }
});
```

---

## 联系支持

如有问题，请参考以下文档：

- 数据库连接问题：`docs/数据库连接问题修复方案-最终版.md`
- 小程序视频生成问题：`docs/小程序视频生成失败排查指南.md`
- 小程序功能测试：`docs/小程序端功能测试指南.md`
