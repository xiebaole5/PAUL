# 小程序视频生成失败 - 问题排查指南

## 快速诊断

### 请提供以下信息

在排查问题之前，请告诉我：

1. **具体错误提示是什么？**
   - 小程序 Toast 提示的文字
   - 小程序控制台（Console）的错误信息
   - 网络请求（Network）的响应内容

2. **具体操作步骤是什么？**
   - 是否上传了图片？
   - 选择的产品名称、主题、时长是什么？
   - 点击"生成视频"后发生了什么？

3. **运行环境是什么？**
   - 微信开发者工具
   - 真机预览（Android 或 iOS）
   - 正式版小程序

---

## 常见错误及解决方案

### 错误 1: "网络错误，生成失败" 或 "服务器连接失败"

**原因**: 小程序无法连接到服务器

**诊断步骤**:

1. **检查 API 地址配置**
   - 打开 `miniprogram/app.js`
   - 确认 `apiUrl` 是否为 `https://tnho-fasteners.com`

2. **检查小程序后台域名配置**
   - 登录微信小程序后台
   - 开发管理 -> 开发设置 -> 服务器域名
   - 确认以下域名已配置：
     - request: `https://tnho-fasteners.com`
     - uploadFile: `https://tnho-fasteners.com`
     - downloadFile: `https://tnho-fasteners.com`

3. **测试服务器是否可访问**
   - 在浏览器中打开：`https://tnho-fasteners.com/health`
   - 应该返回：`{"status":"ok"}`

4. **如果使用微信开发者工具**
   - 详情 -> 本地设置 -> 不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书
   - **注意**: 真机预览不能忽略域名校验

**解决方案**:
```javascript
// miniprogram/app.js
globalData: {
  // 确保使用 HTTPS
  apiUrl: 'https://tnho-fasteners.com'
}
```

---

### 错误 2: "请求超时" 或 "timeout of 10000ms exceeded"

**原因**: 请求超时时间设置过短

**解决方案**:

检查 `miniprogram/pages/index/index.js`:
```javascript
// 确认超时时间为 30 秒（视频生成使用异步，5秒超时是合理的）
const timeout = this.data.generateType === 'video' ? 5000 : 120000

wx.request({
  url: `${app.globalData.apiUrl}/api/generate-video`,
  method: 'POST',
  data: requestData,
  timeout: timeout,  // 确认这里设置了超时时间
  // ...
})
```

如果超时时间仍然是 10 秒，需要修改：
```javascript
timeout: 30000,  // 改为 30 秒
```

---

### 错误 3: "创建任务失败" 或服务器返回错误

**原因**: 服务器端出现问题

**诊断步骤**:

1. **查看服务器日志**
   ```bash
   # 在服务器上执行
   tail -50 /root/tnho-video/logs/app.log
   ```

2. **检查服务器是否运行**
   ```bash
   ps aux | grep uvicorn
   ```

3. **测试 API 接口**
   ```bash
   curl -X POST http://localhost:8000/api/generate-video \
     -H "Content-Type: application/json" \
     -d '{"product_name":"test","theme":"品质保证","duration":5,"type":"video"}'
   ```

**常见服务器问题**:

1. **数据库连接失败**
   - 错误信息：`database connection failed`
   - 解决方案：执行 `bash /root/tnho-video/scripts/optimize-db.sh`

2. **Agent 构建失败**
   - 错误信息：`build_agent failed`
   - 解决方案：检查 `config/agent_llm_config.json` 格式

3. **模块导入错误**
   - 错误信息：`ModuleNotFoundError`
   - 解决方案：确认 `src/` 目录结构完整

---

### 错误 4: "查询进度失败" 或进度长时间不更新

**原因**: 进度查询接口失败或任务执行失败

**诊断步骤**:

1. **检查任务 ID 是否正确**
   - 小程序控制台应该打印 `task_id`
   - 使用 task_id 查询：
     ```bash
     curl https://tnho-fasteners.com/api/progress/<task_id>
     ```

2. **检查任务状态**
   - 如果 `status` 为 `failed`，查看 `error_message`

3. **常见失败原因**:
   - `火山方舟 API 调用失败`：检查 `ARK_API_KEY`
   - `视频生成失败`：检查火山方舟服务状态
   - `数据库错误`：检查数据库连接

**解决方案**:

1. **重试任务**
   - 重新点击"生成视频"按钮
   - 使用不同的产品名称和主题

2. **检查 API Key**
   ```bash
   # 在服务器上检查
   cat /root/tnho-video/.env | grep ARK_API_KEY
   ```

---

### 错误 5: 图片上传失败

**原因**: 图片上传接口返回错误

**诊断步骤**:

1. **检查图片大小**
   - 小程序限制：5MB
   - 如果超过 5MB，压缩后重新上传

2. **检查文件格式**
   - 支持格式：JPG、PNG
   - 如果是其他格式，转换后重新上传

3. **检查上传 URL**
   - 应该为：`https://tnho-fasteners.com/api/upload-image`
   - 不能是：`http://47.110.72.148/api/upload-image`

**解决方案**:

确认图片上传成功：
```javascript
// miniprogram/pages/index/index.js
uploadImage(filePath) {
  wx.uploadFile({
    url: `${app.globalData.apiUrl}/api/upload-image`,
    filePath: filePath,
    name: 'file',
    success(res) {
      console.log('上传响应:', res.data)
      // 应该返回: {"success":true,"image_url":"https://tnho-fasteners.com/assets/uploads/..."}
    }
  })
}
```

---

### 错误 6: Mixed Content 错误

**原因**: 页面使用 HTTPS，但某些资源使用 HTTP

**症状**:
- 浏览器控制台显示 "Mixed Content" 警告
- 小程序请求被浏览器或微信拦截

**解决方案**:

1. **确认所有 URL 都是 HTTPS**
   - API 地址：`https://tnho-fasteners.com`
   - 图片 URL：`https://tnho-fasteners.com/assets/uploads/...`

2. **检查环境变量**
   ```bash
   # 在服务器上检查
   cat /root/tnho-video/.env | grep EXTERNAL_BASE_URL
   # 应该为: EXTERNAL_BASE_URL=https://tnho-fasteners.com
   ```

3. **重启应用**
   ```bash
   cd /root/tnho-video
   pkill -f "uvicorn app:app"
   sleep 2
   nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 &
   ```

---

## 完整诊断流程

### 第一步：检查小程序配置

```javascript
// 打开 miniprogram/app.js，确认以下配置：
globalData: {
  apiUrl: 'https://tnho-fasteners.com'  // 必须是 HTTPS
}
```

### 第二步：检查服务器状态

```bash
# 1. 检查应用是否运行
ps aux | grep uvicorn

# 2. 检查健康状态
curl https://tnho-fasteners.com/health

# 3. 检查最新日志
tail -50 /root/tnho-video/logs/app.log
```

### 第三步：测试 API 接口

```bash
# 1. 测试创建任务
curl -X POST https://tnho-fasteners.com/api/generate-video \
  -H "Content-Type: application/json" \
  -d '{"product_name":"高强度螺栓","theme":"品质保证","duration":5,"type":"video"}'

# 2. 复制返回的 task_id，查询进度
curl https://tnho-fasteners.com/api/progress/<task_id>
```

### 第四步：检查小程序控制台

1. 打开微信开发者工具
2. 点击"调试器"标签
3. 查看 Console 输出
4. 查看 Network 请求

### 第五步：检查小程序后台域名配置

1. 登录微信小程序后台
2. 开发管理 -> 开发设置 -> 服务器域名
3. 确认以下域名已配置：
   - request: `https://tnho-fasteners.com`
   - uploadFile: `https://tnho-fasteners.com`
   - downloadFile: `https://tnho-fasteners.com`

---

## 快速修复命令

```bash
# 在服务器上执行以下命令，重新部署应用

cd /root/tnho-video

# 1. 拉取最新代码
git pull origin main

# 2. 重启应用
pkill -f "uvicorn app:app"
sleep 2
nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 &

# 3. 运行验证测试
bash scripts/full-verify.sh
```

---

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：

1. **小程序控制台完整错误日志**
   ```javascript
   // 在 miniprogram/pages/index/index.js 中添加更多日志
   console.log('请求URL:', url)
   console.log('请求数据:', requestData)
   console.log('响应数据:', res.data)
   ```

2. **服务器日志**
   ```bash
   tail -100 /root/tnho-video/logs/app.log > app_log.txt
   ```

3. **网络请求详情**
   - 小程序 Network 标签中的请求 URL
   - 请求头
   - 响应头
   - 响应内容

4. **具体操作步骤**
   - 产品名称
   - 主题
   - 时长
   - 是否上传图片
   - 图片 URL（如果有）
