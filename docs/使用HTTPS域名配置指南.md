# 使用 HTTPS 域名配置指南

## 📌 前提条件

你已拥有：
- ✅ HTTPS 证书的域名
- ✅ 已配置的服务器域名

---

## 🔧 配置步骤

### 第一步：确认后端服务已部署到你的域名

**检查方法**：
在浏览器访问你的域名：
```
https://your-domain.com/health
```

**预期结果**：
```json
{
  "status": "healthy"
}
```

---

### 第二步：在微信公众平台配置服务器域名

1. 登录 [微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **"开发"** → **"开发管理"** → **"开发设置"**
3. 找到 **"服务器域名"** 配置项
4. 配置以下域名（替换为你的域名）：

**request 合法域名**：
```
https://your-domain.com
```

**uploadFile 合法域名**：
```
https://your-domain.com
```

**downloadFile 合法域名**：
```
https://your-domain.com
```

5. 点击 **"保存"** 或 **"确定"**

---

### 第三步：修改小程序 API 地址配置

#### 1. 打开配置文件

编辑 `C:\PAUL\miniprogram\app.js`

#### 2. 修改 apiBaseUrl

```javascript
// app.js
App({
  globalData: {
    // 修改为你的 HTTPS 域名
    apiBaseUrl: 'https://your-domain.com'
  }
})
```

**示例**：
```javascript
apiBaseUrl: 'https://api.example.com'
```

---

### 第四步：微信开发者工具配置

#### 1. 取消勾选"不校验合法域名"

在微信开发者工具中：
1. 点击右上角 **"详情"**
2. 切换到 **"本地设置"** 标签
3. **取消勾选**：**"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

#### 2. 重新编译项目

点击 **"编译"** 按钮

---

### 第五步：测试上传图片

1. 点击上传图片按钮
2. 选择一张图片
3. 查看是否上传成功

---

## 🐛 可能遇到的问题

### 问题 1：配置域名后仍然失败

**原因**：域名配置需要 5-10 分钟生效

**解决**：
- 等待 10 分钟后重试
- 确认域名拼写正确（包括 https://）

---

### 问题 2：提示"不在以下域名白名单中"

**原因**：域名未在微信公众平台配置

**解决**：
1. 重新检查微信公众平台配置
2. 确认域名格式正确（带 https://）
3. 保存后等待生效

---

### 问题 3：提示"TLS 版本错误"

**原因**：服务器 TLS 版本不符合微信要求

**解决**：
- 微信要求 TLS 1.2 及以上
- 检查服务器 SSL/TLS 配置
- 确保使用有效的 HTTPS 证书

---

## 📋 域名配置检查清单

在微信公众平台配置前，确认：

- [ ] 域名使用 HTTPS 协议
- [ ] 域名有有效的 SSL/TLS 证书
- [ ] 证书未过期
- [ ] 域名已备案（中国大陆服务器）
- [ ] 域名可以正常访问
- [ ] 后端服务已部署到该域名
- [ ] TLS 版本为 1.2 或以上

---

## 🔍 验证域名配置

### 1. 检查域名是否可以访问

在浏览器访问：
```
https://your-domain.com/health
```

### 2. 检查 SSL 证书

使用在线工具检查：
- [SSL Labs](https://www.ssllabs.com/ssltest/)
- 输入你的域名
- 查看证书是否有效

### 3. 检查 TLS 版本

```bash
# 使用 openssl 检查
openssl s_client -connect your-domain.com:443 -tls1_2
```

---

## 🚀 完整配置流程

### 如果你的后端服务已部署到域名

1. **微信公众平台配置域名**
   - 添加到 request 合法域名
   - 添加到 uploadFile 合法域名
   - 添加到 downloadFile 合法域名

2. **修改小程序配置**
   ```javascript
   apiBaseUrl: 'https://your-domain.com'
   ```

3. **微信开发者工具配置**
   - 取消勾选"不校验合法域名"
   - 重新编译

4. **测试上传图片**

---

### 如果你的后端服务还在本地开发

**方案 1：使用本地开发模式**
- 保持开启"不校验合法域名"
- 使用 `http://localhost:8000`

**方案 2：使用内网穿透工具**
- 使用 ngrok、frp 等工具
- 将本地服务映射到公网域名
- 配置 HTTPS 证书

---

## 💡 最佳实践

### 开发阶段
- 使用 `http://localhost:8000`
- 开启"不校验合法域名"
- 不在微信公众平台配置域名

### 测试阶段
- 部署到测试服务器
- 使用测试域名
- 配置测试域名到微信公众平台
- 取消勾选"不校验合法域名"

### 生产阶段
- 部署到生产服务器
- 使用正式域名
- 配置正式域名到微信公众平台
- 取消勾选"不校验合法域名"

---

## ❓ 常见问题

### Q1：我配置了域名，但还是失败

**检查**：
1. 域名是否正确（包括 https://）
2. 配置是否已生效（等待 5-10 分钟）
3. 后端服务是否正常运行
4. 控制台是否有错误信息

### Q2：我的域名有证书，但还是提示错误

**检查**：
1. 证书是否过期
2. 证书链是否完整
3. TLS 版本是否符合要求（1.2+）
4. 域名是否在微信公众平台配置

### Q3：可以同时配置多个域名吗？

**答**：可以
- request 合法域名：最多 20 个
- uploadFile 合法域名：最多 20 个
- downloadFile 合法域名：最多 20 个

---

## 📞 需要帮助？

如果配置后仍然失败，请提供：

1. 你的域名（可以隐藏中间部分，如 `https://api.***.com`）
2. 微信公众平台配置截图（遮盖敏感信息）
3. 控制台错误信息
4. 后端日志

---

**祝你配置成功！** 🎉
