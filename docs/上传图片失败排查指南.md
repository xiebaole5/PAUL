# 微信小程序上传图片失败排查指南

## 🐛 问题现象

在微信开发者工具中，普通编译模式下上传图片失败。

---

## 🔍 排查步骤

### 第一步：检查后端服务是否启动

#### 1. 检查后端服务状态

打开 **CMD** 或 **PowerShell**，执行：

```bash
# 检查后端服务是否运行
netstat -ano | findstr :8000
```

**如果没有任何输出**，说明后端服务没有启动。

#### 2. 启动后端服务

```bash
# 进入项目目录
cd C:\PAUL

# 启动 FastAPI 服务
python src\main.py
```

**启动成功后会显示**：
```
🚀 启动 FastAPI 服务...
📡 服务地址: http://0.0.0.0:8000
📚 API 文档: http://0.0.0.0:8000/docs
INFO:     Started server process
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8000
```

#### 3. 验证后端服务

在浏览器中访问：
- **健康检查**: http://localhost:8000/health
- **API 文档**: http://localhost:8000/docs

**预期结果**：
```json
{
  "status": "healthy"
}
```

---

### 第二步：检查小程序 API 地址配置

#### 1. 打开配置文件

打开 `miniprogram/app.js`，查看 `apiBaseUrl` 配置：

```javascript
// app.js
App({
  globalData: {
    // 确保这里是本地地址
    apiBaseUrl: 'http://localhost:8000'
  }
})
```

#### 2. 修改配置（如果需要）

如果 `apiBaseUrl` 不是 `http://localhost:8000`，请修改：

```javascript
apiBaseUrl: 'http://localhost:8000'
```

**注意**：
- ✅ 本地开发：使用 `http://localhost:8000`
- ❌ 不要使用 `https://`（本地开发不需要）
- ❌ 不要使用 `127.0.0.1`（在某些情况下可能有问题）

#### 3. 重新编译项目

在微信开发者工具中：
1. 点击 **"编译"** 按钮
2. 重新加载项目

---

### 第三步：检查微信开发者工具网络配置

#### 1. 开启本地调试

在微信开发者工具中：
1. 点击右上角 **"详情"**
2. 切换到 **"本地设置"** 标签
3. 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

**重要**：本地开发时必须勾选这个选项，否则无法访问 `localhost:8000`

#### 2. 关闭 ES6 转 ES5

在 **"本地设置"** 中：
1. 取消勾选 **"ES6 转 ES5"**
2. 取消勾选 **"增强编译"**

#### 3. 重新编译

点击 **"编译"** 按钮

---

### 第四步：查看控制台错误信息

#### 1. 打开控制台

在微信开发者工具中：
1. 点击底部 **"调试器"** 标签
2. 切换到 **"Console"** 标签

#### 2. 上传图片并查看错误

1. 点击上传图片按钮
2. 选择一张图片
3. 在控制台中查看错误信息

**常见错误信息**：

##### 错误 1：`request:fail`

```
request:fail url not in domain list
```

**原因**：没有开启"不校验合法域名"

**解决**：
- 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

---

##### 错误 2：`request:fail connection refused`

```
request:fail connection refused
```

**原因**：后端服务没有启动

**解决**：
- 启动后端服务：`python src\main.py`

---

##### 错误 3：`request:fail net::ERR_CONNECTION_REFUSED`

```
request:fail net::ERR_CONNECTION_REFUSED
```

**原因**：后端服务端口被占用或服务未启动

**解决**：
```bash
# 检查端口占用
netstat -ano | findstr :8000

# 如果有进程占用，关闭它
taskkill /PID <进程ID> /F

# 重新启动后端服务
python src\main.py
```

---

##### 错误 4：`request:fail timeout`

```
request:fail timeout
```

**原因**：后端服务响应超时

**解决**：
- 检查后端服务日志
- 确认没有错误
- 可能是环境变量配置问题

---

##### 错误 5：`{"code": 500, "message": "图片上传失败"}`

**原因**：后端上传图片接口失败

**解决**：
- 检查后端日志
- 确认对象存储配置正确
- 检查环境变量

---

### 第五步：检查环境变量配置

#### 1. 创建 .env 文件

在项目根目录 `C:\PAUL\` 创建 `.env` 文件：

```env
# 对象存储配置
COZE_BUCKET_ENDPOINT_URL=https://your-bucket-endpoint
COZE_BUCKET_NAME=your-bucket-name

# 火山方舟 API 配置
ARK_API_KEY=your-ark-api-key
ARK_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
ARK_VIDEO_API_KEY=your-video-api-key
```

#### 2. 配置环境变量（Windows CMD）

```bash
# 设置环境变量
set COZE_BUCKET_ENDPOINT_URL=https://your-bucket-endpoint
set COZE_BUCKET_NAME=your-bucket-name
set ARK_API_KEY=your-ark-api-key
set ARK_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
set ARK_VIDEO_API_KEY=your-video-api-key

# 启动后端服务
python src\main.py
```

#### 3. 配置环境变量（PowerShell）

```powershell
# 设置环境变量
$env:COZE_BUCKET_ENDPOINT_URL="https://your-bucket-endpoint"
$env:COZE_BUCKET_NAME="your-bucket-name"
$env:ARK_API_KEY="your-ark-api-key"
$env:ARK_BASE_URL="https://ark.cn-beijing.volces.com/api/v3"
$env:ARK_VIDEO_API_KEY="your-video-api-key"

# 启动后端服务
python src\main.py
```

**注意**：如果环境变量配置不正确，后端服务可能会启动失败或上传失败。

---

### 第六步：测试接口

#### 1. 使用 API 文档测试

在浏览器中访问 http://localhost:8000/docs

1. 找到 `POST /api/v1/upload-image` 接口
2. 点击 **"Try it out"**
3. 选择一张图片上传
4. 点击 **"Execute"**

**预期结果**：
```json
{
  "code": 0,
  "message": "图片上传成功",
  "data": {
    "image_url": "https://...",
    "file_key": "miniprogram_images/..."
  }
}
```

**如果失败**：
- 查看响应错误信息
- 检查后端日志

---

## 🛠️ 快速解决方案

### 方案 1：最常见的问题（未开启本地调试）

**问题**：没有勾选"不校验合法域名"

**解决**：
1. 打开微信开发者工具
2. 点击右上角 **"详情"**
3. 切换到 **"本地设置"** 标签
4. 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**
5. 重新编译项目

---

### 方案 2：后端服务未启动

**问题**：后端服务没有运行

**解决**：
```bash
# 打开一个新的 CMD 窗口
cd C:\PAUL
python src\main.py
```

**确认服务启动成功**：
- 看到 `INFO: Uvicorn running on http://0.0.0.0:8000`
- 在浏览器访问 http://localhost:8000/health 返回 `{"status": "healthy"}`

---

### 方案 3：API 地址配置错误

**问题**：`apiBaseUrl` 配置不正确

**解决**：
1. 打开 `miniprogram/app.js`
2. 确认配置为：
```javascript
apiBaseUrl: 'http://localhost:8000'
```
3. 重新编译项目

---

## 📝 完整的启动流程

### 步骤 1：启动后端服务

打开 **CMD**：
```bash
cd C:\PAUL
python src\main.py
```

**保持这个窗口打开**，不要关闭！

### 步骤 2：配置微信开发者工具

1. 打开微信开发者工具
2. 导入项目：`C:\PAUL\miniprogram`
3. 点击右上角 **"详情"**
4. 切换到 **"本地设置"** 标签
5. 勾选 **"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"**

### 步骤 3：测试上传图片

1. 点击 **"编译"** 按钮
2. 点击上传图片按钮
3. 选择一张图片
4. 查看是否上传成功

---

## 🐛 调试技巧

### 1. 添加调试日志

在 `miniprogram/pages/index/index.js` 中找到 `uploadImage` 方法，添加日志：

```javascript
uploadImage(filePath) {
  wx.showLoading({
    title: '上传中...'
  })

  const app = getApp()
  const token = wx.getStorageSync('token') || ''

  // 添加调试日志
  console.log('上传图片，URL:', `${app.globalData.apiBaseUrl}/api/v1/upload-image`)
  console.log('文件路径:', filePath)

  wx.uploadFile({
    url: `${app.globalData.apiBaseUrl}/api/v1/upload-image`,
    filePath: filePath,
    name: 'file',
    header: {
      'Authorization': token
    },
    success: (res) => {
      console.log('上传成功，响应:', res)
      wx.hideLoading()
      const data = JSON.parse(res.data)

      if (data.code === 0) {
        this.setData({
          'formData.productImageUrl': data.data.image_url
        })
        wx.showToast({
          title: '上传成功',
          icon: 'success'
        })
      } else {
        console.error('上传失败，错误信息:', data)
        wx.showToast({
          title: data.message || '上传失败',
          icon: 'error'
        })
      }
    },
    fail: (err) => {
      console.error('上传失败，错误:', err)
      wx.hideLoading()
      wx.showToast({
        title: '上传失败',
        icon: 'error'
      })
    }
  })
}
```

### 2. 查看后端日志

在后端服务的 CMD 窗口中，查看日志输出：

```bash
INFO:     Started server process
INFO:     127.0.0.1:xxxx - "POST /api/v1/upload-image HTTP/1.1" 200 OK
```

如果看到错误信息，根据错误信息排查问题。

---

## ❓ 常见问题

### Q1：上传图片时一直显示"上传中..."

**原因**：后端服务没有响应

**解决**：
1. 检查后端服务是否启动
2. 查看后端日志
3. 确认环境变量配置正确

### Q2：上传成功但图片无法显示

**原因**：图片 URL 无效或签名已过期

**解决**：
1. 检查图片 URL 是否有效
2. 查看对象存储配置
3. 可能需要延长签名有效期

### Q3：提示"网络错误"

**原因**：网络请求失败

**解决**：
1. 检查后端服务是否运行
2. 检查防火墙设置
3. 确认端口 8000 没有被占用

---

## 📞 需要帮助？

如果以上方法都无法解决问题，请提供以下信息：

1. 后端服务日志（CMD 窗口中的输出）
2. 微信开发者工具控制台错误信息
3. 具体的错误提示

---

## ✅ 成功的标志

上传成功后，你应该看到：

1. **控制台日志**：
```javascript
上传图片，URL: http://localhost:8000/api/v1/upload-image
文件路径: wxfile://tmp_xxxxx
上传成功，响应: {statusCode: 200, data: "{\"code\":0,\"message\":\"图片上传成功\",...}"}
```

2. **界面显示**：
   - Toast 提示："上传成功"
   - 显示上传的图片预览

3. **后端日志**：
```bash
INFO:     127.0.0.1:xxxx - "POST /api/v1/upload-image HTTP/1.1" 200 OK
```

---

**祝你排查成功！** 🎉
