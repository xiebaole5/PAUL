# 小程序正式发布 - 域名配置指南

## 一、小程序后台域名配置

### 1. 登录微信公众平台
- 访问：https://mp.weixin.qq.com
- 使用小程序管理员账号登录
- AppID: `wx464504ca7e01b3b1`

### 2. 配置服务器域名

**位置**：开发 > 开发管理 > 开发设置 > 服务器域名

需要配置以下三类域名：

#### 2.1 request 合法域名
```
https://tnho-fasteners.com
```
**用途**：API 请求接口
- `/api/generate-video`
- `/api/generate-script`
- `/api/progress/{task_id}`

#### 2.2 uploadFile 合法域名
```
https://tnho-fasteners.com
```
**用途**：图片上传接口
- `/api/upload-image`

#### 2.3 downloadFile 合法域名
```
https://tnho-fasteners.com
https://*.tos-s3-cn-beijing.volces.com
```
**用途**：
- 视频播放（本地生成的视频）
- 对象存储视频资源

### 3. 注意事项

#### 域名类型要求
- ✅ 必须使用 HTTPS 协议
- ✅ 证书必须有效（当前使用 Let's Encrypt，有效期至 2026-04-13）
- ❌ 不能使用 IP 地址
- ❌ 不能使用端口号

#### Cloudflare SSL/TLS 模式
- 当前模式：**Full** ✅
- 不要设置为 Flexible（会导致证书验证失败）
- 不要设置为 Full (strict)（需要自签名证书，不适用于 Let's Encrypt）

#### 配置生效时间
- 域名配置通常在 15 分钟内生效
- 建议配置后等待 15-30 分钟再测试

## 二、验证配置是否生效

### 1. 测试小程序图片上传
在微信开发者工具中测试图片上传功能：

**步骤**：
1. 打开微信开发者工具
2. 点击"上传图片"按钮
3. 选择一张图片
4. 查看 Console 和 Network 标签

**预期结果**：
- Console: 无红色错误信息
- Network: `/api/upload-image` 请求返回 200 状态码
- 图片显示成功

**常见问题**：
- ❌ `request:fail url not in domain list` → 检查 uploadFile 合法域名
- ❌ `request:fail -2 net::ERR_NAME_NOT_RESOLVED` → 检查 DNS 解析
- ❌ `request:fail -2 net::ERR_CONNECTION_REFUSED` → 检查服务器运行状态

### 2. 测试小程序视频生成
**步骤**：
1. 选择视频主题和时长
2. （可选）上传产品图片
3. 点击"生成视频"按钮
4. 等待进度条完成

**预期结果**：
- 进度条正常显示（每 2 秒更新一次）
- 视频生成成功，显示视频播放器
- 可以正常播放视频

## 三、小程序版本管理

### 1. 开发版本
- 使用微信开发者工具开发
- 可以直接在开发者工具中预览
- 可以生成预览二维码供测试

### 2. 体验版本
- 点击"上传"按钮上传代码
- 在"版本管理"中选择"体验版"
- 生成体验版二维码，供内部测试

### 3. 审核版本
- 代码审核通过后，可以发布为体验版
- 提交审核：管理后台 > 版本管理 > 提交审核
- 审核通过后可以发布为正式版

### 4. 正式版本
- 审核通过后，点击"发布"按钮
- 版号规则：主版本.次版本.修订版（如 1.0.0）
- 发布后所有用户可访问

## 四、发布检查清单

### 发布前检查
- [ ] 域名配置完成且生效
- [ ] 所有功能测试通过
  - [ ] 图片上传功能
  - [ ] 视频生成功能
  - [ ] 脚本生成功能
  - [ ] 视频播放功能
  - [ ] 进度查询功能
- [ ] 错误处理完善（用户友好的错误提示）
- [ ] 界面美观（符合主题色 #D32F2F）
- [ ] 小程序信息完整
  - [ ] 名称：TNHO 紧固件视频生成器
  - [ ] 图标：已上传
  - [ ] 简介：已填写
  - [ ] 服务类目：工具 > 视频编辑

### 发布流程
1. **上传代码**
   - 微信开发者工具 > 上传
   - 填写版本号（如 1.0.0）
   - 填写项目备注

2. **提交审核**
   - 微信公众平台 > 版本管理 > 开发版本
   - 点击"提交审核"
   - 填写审核信息

3. **等待审核**
   - 审核时间：1-7 个工作日
   - 可以在"审核列表"中查看进度

4. **发布上线**
   - 审核通过后，点击"发布"
   - 确认发布信息
   - 发布成功！

## 五、维护和更新

### 日志监控
服务器日志位置：`/root/tnho-video/logs/app.log`

常用命令：
```bash
# 查看最新日志
tail -f /root/tnho-video/logs/app.log

# 查看最近 100 行
tail -n 100 /root/tnho-video/logs/app.log

# 搜索错误
grep "ERROR" /root/tnho-video/logs/app.log
```

### 服务重启
```bash
# 重启应用
cd /root/tnho-video
./restart_server.sh

# 重启 Nginx
sudo systemctl restart nginx

# 检查服务状态
sudo systemctl status nginx
```

### 代码更新
```bash
# 拉取最新代码
cd /root/tnho-video
git pull

# 重启服务
./restart_server.sh
```

## 六、常见问题

### Q1: 小程序提示"不在以下 request 合法域名列表中"
**原因**：域名配置未生效或配置错误

**解决**：
1. 检查域名配置是否正确（必须使用 HTTPS）
2. 等待 15-30 分钟让配置生效
3. 检查 Cloudflare SSL/TLS 模式是否为 Full

### Q2: 图片上传失败
**原因**：uploadFile 域名未配置或证书问题

**解决**：
1. 检查 uploadFile 合法域名
2. 检查 Let's Encrypt 证书是否有效
3. 测试 API 接口：`curl -X POST https://tnho-fasteners.com/api/upload-image`

### Q3: 视频生成失败
**原因**：后端服务异常或 API Key 问题

**解决**：
1. 查看服务器日志：`tail -f /root/tnho-video/logs/app.log`
2. 检查火山方舟 API Key 是否有效
3. 检查数据库连接是否正常

### Q4: 视频播放失败
**原因**：downloadFile 域名未配置或视频 URL 无效

**解决**：
1. 检查 downloadFile 合法域名
2. 检查视频 URL 是否有效（可以在浏览器中打开）
3. 确保视频格式为 MP4 且编码为 H.264

### Q5: Cloudflare SSL/TLS 配置警告
**原因**：SSL/TLS 模式设置不正确

**解决**：
1. 登录 Cloudflare 控制台
2. 进入 SSL/TLS 设置
3. 确保模式为 **Full**（不是 Flexible 或 Full (strict)）

## 七、联系支持

如遇到问题，可以：
1. 查看服务器日志：`/root/tnho-video/logs/app.log`
2. 查看 Nginx 日志：`/var/log/nginx/error.log`
3. 查看 GitHub 仓库：https://github.com/xiebaole5/PAUL
4. 查看项目文档：`docs/` 目录

---

**配置日期**：2026-01-14
**最后更新**：2026-01-14
