# 数据库连接问题修复总结

## 问题描述
小程序图片上传和视频生成功能失败，服务器日志显示数据库连接错误：
```
password authentication failed for user "postgres"
```

## 根因分析
1. **环境变量未加载**: `src/api/app.py` 文件中没有导入和调用 `load_dotenv()`
2. **数据库配置缺失**: 由于环境变量未加载，导致 `PGDATABASE_URL` 等数据库连接参数无法读取
3. **Mixed Content 错误**: 图片上传接口返回 HTTP 协议的 IP 地址，导致小程序无法访问

## 修复方案

### 1. 添加环境变量加载（已完成）
**文件**: `src/api/app.py`

在文件开头添加：
```python
from dotenv import load_dotenv
load_dotenv()  # 加载 .env 文件中的环境变量
```

**修复位置**: 第 4-5 行（在其他导入之前）

### 2. 修复图片上传接口返回 URL（已完成）
**文件**: `src/api/app.py`

**修改前**:
```python
base_url = os.getenv("EXTERNAL_BASE_URL", "http://47.110.72.148")
```

**修改后**:
```python
base_url = os.getenv("EXTERNAL_BASE_URL", "https://tnho-fasteners.com")
```

**修复位置**: `/api/upload-image` 接口（约第 226 行）

## 执行步骤

### 服务器端操作
1. **重启应用以加载环境变量**
   ```bash
   cd /root/tnho-video
   bash scripts/restart-app.sh
   ```

2. **验证环境变量加载**
   ```bash
   source venv/bin/activate
   python -c "from dotenv import load_dotenv; load_dotenv(); import os; print('DATABASE_URL:', os.getenv('PGDATABASE_URL'))"
   ```

3. **测试数据库连接**
   ```bash
   python -c "from storage.database.db import get_session; from dotenv import load_dotenv; load_dotenv(); db = get_session(); print('数据库连接成功'); db.close()"
   ```

4. **测试 API 接口**
   ```bash
   # 健康检查
   curl https://tnho-fasteners.com/api/health

   # 图片上传测试
   curl -X POST https://tnho-fasteners.com/api/upload-image -F "file=@/path/to/test.jpg"
   ```

### 小程序端操作
1. **检查配置**
   - 确认 `app.js` 中的 `apiUrl` 配置为 `https://tnho-fasteners.com`
   - 确认 `pages/index/index.js` 中的 `apiUrl` 配置一致

2. **检查服务器域名配置**
   - 登录微信小程序后台
   - 进入「开发」->「开发管理」->「开发设置」
   - 检查「服务器域名」配置：
     - request: `https://tnho-fasteners.com`
     - uploadFile: `https://tnho-fasteners.com`
     - downloadFile: `https://tnho-fasteners.com`

3. **测试图片上传功能**
   - 在小程序中上传产品图片
   - 检查返回的 URL 是否为 HTTPS 协议的域名

4. **测试视频生成功能**
   - 输入产品名称和主题
   - 可选上传产品图片
   - 提交生成任务
   - 查看进度轮询是否正常

## 预期结果

### 修复前
- ❌ 图片上传失败：ECONNRESET（连接被重置）
- ❌ 视频生成失败：数据库连接失败
- ❌ Mixed Content 错误：图片 URL 使用 HTTP 协议

### 修复后
- ✅ 图片上传成功：返回 HTTPS URL
- ✅ 数据库连接正常：可以创建任务记录
- ✅ 视频生成成功：异步执行，进度查询正常

## 验证清单

- [ ] 应用已重启，环境变量已加载
- [ ] 数据库连接测试通过
- [ ] `/api/health` 接口返回正常
- [ ] `/api/upload-image` 接口返回 HTTPS URL
- [ ] `/api/generate-video` 接口可以创建任务
- [ ] `/api/progress/{task_id}` 接口可以查询进度
- [ ] 小程序图片上传功能正常
- [ ] 小程序视频生成功能正常
- [ ] 无 Mixed Content 错误
- [ ] 无数据库连接错误

## 文件变更列表

### 修改的文件
1. `src/api/app.py`
   - 添加 `from dotenv import load_dotenv` 导入
   - 添加 `load_dotenv()` 调用
   - 修改 `/api/upload-image` 接口的默认 URL 为 HTTPS 域名

### 新增的文件
1. `docs/数据库连接问题修复总结.md`（本文档）
2. `docs/小程序-Mixed-Content错误修复指南.md`
3. `docs/服务器-Mixed-Content错误修复-执行步骤.md`

### 已存在的文件
1. `scripts/restart-app.sh`（应用重启脚本）

## 后续建议

1. **监控日志**
   - 定期查看 `logs/app.log` 和 `logs/error.log`
   - 关注数据库连接错误和网络错误

2. **性能优化**
   - 考虑添加数据库连接池监控
   - 考虑添加 API 响应时间监控

3. **安全加固**
   - 确保 `.env` 文件权限正确（仅 root 可读）
   - 定期更新 SSL 证书

4. **备份策略**
   - 定期备份数据库
   - 定期备份小程序代码

## 故障排查

### 如果重启后仍有数据库连接错误
1. 检查 `.env` 文件是否存在：
   ```bash
   ls -la /root/tnho-video/.env
   ```

2. 检查 `.env` 文件内容：
   ```bash
   cat /root/tnho-video/.env | grep PGDATABASE_URL
   ```

3. 测试数据库连接：
   ```bash
   docker exec -it tnho-postgres psql -U tnho_user -d tnho_video -c "SELECT 1;"
   ```

### 如果仍有 Mixed Content 错误
1. 检查 Nginx 配置：
   ```bash
   nginx -t
   ```

2. 检查 SSL 证书：
   ```bash
   certbot certificates
   ```

3. 检查 Cloudflare SSL/TLS 设置：
   - 确保为「Full」模式
   - 确保 DNS 记录正确

## 联系方式
- GitHub: https://github.com/xiebaole5/PAUL
- 小程序AppID: wx464504ca7e01b3b1
- API地址: https://tnho-fasteners.com

---
**修复日期**: 2025-02-06
**修复人员**: Coze Coding Assistant
