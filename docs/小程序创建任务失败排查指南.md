# 小程序创建任务失败排查指南

## 问题现象
用户反馈：小程序提示"创建任务失败"

## 可能原因分析

### 1. 服务器应用未重启（最可能）
**原因**：代码已更新，但服务器上的应用仍在运行旧版本，没有加载环境变量

**检查方法**：
```bash
# SSH 登录服务器
ssh root@47.110.72.148

# 检查进程启动时间
ps aux | grep uvicorn
```

如果进程启动时间早于代码更新时间，说明应用未重启。

**解决方案**：
```bash
cd /root/tnho-video
git pull origin main
bash scripts/restart-app.sh
```

### 2. 数据库连接失败
**原因**：虽然添加了 `load_dotenv()`，但可能 `.env` 文件配置不正确

**检查方法**：
```bash
cd /root/tnho-video
source venv/bin/activate
python -c "from dotenv import load_dotenv; load_dotenv(); import os; print('PGDATABASE_URL:', os.getenv('PGDATABASE_URL', 'Not found'))"
```

**解决方案**：
检查 `.env` 文件是否存在且配置正确：
```bash
cat /root/tnho-video/.env | grep PGDATABASE_URL
```

如果不存在或配置错误，需要创建/修改 `.env` 文件：
```bash
PGDATABASE_URL=postgresql://tnho_user:your_password@localhost:5432/tnho_video
```

### 3. 小程序端错误处理不完善
**原因**：小程序没有正确显示服务器返回的错误信息

**检查方法**：
在微信开发者工具的控制台中查看是否有网络请求错误

**解决方案**：
修改 `tnho-miniprogram/pages/index/index.js`，添加更详细的错误日志：
```javascript
generateVideo() {
  wx.showLoading({ title: '创建任务中...' });

  console.log('开始请求:', this.data.apiUrl + '/api/generate-video');
  console.log('请求参数:', this.data);

  wx.request({
    url: this.data.apiUrl + '/api/generate-video',
    method: 'POST',
    data: {
      product_name: this.data.productName,
      theme: this.data.theme,
      duration: this.data.duration,
      type: 'video',
      scenario: this.data.scenario,
      product_image_url: this.data.productImageUrl
    },
    header: {
      'content-type': 'application/json'
    },
    timeout: 30000,  // 30秒超时
    success: (res) => {
      console.log('响应成功:', res);
      wx.hideLoading();

      if (res.data.success) {
        // 成功创建任务
        wx.showToast({
          title: '任务已创建',
          icon: 'success'
        });

        // 开始轮询进度
        this.startProgressPolling(res.data.task_id);
      } else {
        // 服务器返回错误
        console.error('服务器错误:', res.data.message);
        wx.showModal({
          title: '创建任务失败',
          content: res.data.message || '未知错误',
          showCancel: false
        });
      }
    },
    fail: (err) => {
      console.error('请求失败:', err);
      wx.hideLoading();

      wx.showModal({
        title: '请求失败',
        content: err.errMsg || '网络请求失败，请检查网络连接',
        showCancel: false
      });
    }
  });
}
```

### 4. 服务器域名未配置或配置错误
**原因**：微信小程序后台没有配置或配置了错误的服务器域名

**检查方法**：
1. 登录微信小程序后台
2. 进入「开发」->「开发管理」->「开发设置」
3. 查看「服务器域名」配置

**解决方案**：
在服务器域名中添加：
- request: `https://tnho-fasteners.com`
- uploadFile: `https://tnho-fasteners.com`
- downloadFile: `https://tnho-fasteners.com`

### 5. API 地址配置错误
**原因**：小程序中的 API 地址配置不正确

**检查方法**：
查看 `tnho-miniprogram/app.js` 中的 `apiUrl` 配置：
```javascript
globalData: {
  apiUrl: 'https://tnho-fasteners.com'  // 确保是 HTTPS 协议
}
```

**解决方案**：
确保 `apiUrl` 配置为 `https://tnho-fasteners.com`

## 详细排查步骤

### 步骤1：检查服务器状态
```bash
# SSH 登录服务器
ssh root@47.110.72.148

# 检查应用进程
ps aux | grep uvicorn

# 查看应用日志
tail -n 50 /root/tnho-video/logs/app.log
```

**预期结果**：
- 进程存在且启动时间较新
- 日志中没有错误

### 步骤2：测试 API 接口
```bash
# 测试健康检查
curl -s https://tnho-fasteners.com/api/health

# 测试视频生成接口（创建测试任务）
curl -X POST https://tnho-fasteners.com/api/generate-video \
  -H "Content-Type: application/json" \
  -d '{
    "product_name": "测试产品",
    "theme": "品质保证",
    "duration": 20,
    "type": "video"
  }'
```

**预期结果**：
```json
{
  "success": true,
  "message": "视频生成任务已创建，任务ID: xxx...",
  "task_id": "xxx...",
  "session_id": null,
  "type": "video"
}
```

### 步骤3：测试数据库连接
```bash
cd /root/tnho-video
source venv/bin/activate
python -c "from storage.database.db import get_session; db = get_session(); print('✓ 数据库连接成功'); db.close()"
```

**预期结果**：
```
✓ 数据库连接成功
```

### 步骤4：检查小程序日志
在微信开发者工具的控制台中查看：
- 网络请求是否发送
- 请求参数是否正确
- 响应内容是什么
- 是否有错误信息

### 步骤5：检查网络请求
在微信开发者工具的「Network」标签页中查看：
- 请求的 URL 是否正确
- 请求方法是否为 POST
- 请求体是否包含正确的数据
- 响应状态码是什么
- 响应内容是什么

## 常见错误及解决方案

### 错误1：`request:fail url not in domain list`
**原因**：服务器域名未在微信小程序后台配置

**解决方案**：
在微信小程序后台添加服务器域名

### 错误2：`request:fail timeout`
**原因**：请求超时

**解决方案**：
1. 检查服务器是否正常运行
2. 增加请求超时时间（小程序代码中已设置为 30 秒）
3. 检查网络连接

### 错误3：`request:fail -2 net::ERR_NAME_NOT_RESOLVED`
**原因**：域名解析失败

**解决方案**：
1. 检查域名是否正确
2. 检查 DNS 解析
3. 检查网络连接

### 错误4：`{"success": false, "message": "创建任务失败: ..."}`
**原因**：服务器端处理失败

**解决方案**：
1. 查看服务器日志：`tail -n 100 /root/tnho-video/logs/app.log`
2. 根据错误信息排查具体原因
3. 检查数据库连接是否正常

### 错误5：Mixed Content 错误
**原因**：HTTPS 页面请求了 HTTP 资源

**解决方案**：
这个错误是关于微信公共图片资源的，不影响功能。但如果是因为我们上传的图片使用了 HTTP，需要：
1. 确保服务器返回的图片 URL 是 HTTPS
2. 检查 `src/api/app.py` 中的 `EXTERNAL_BASE_URL` 配置

## 快速修复命令

如果确认是服务器应用未重启，执行以下命令：

```bash
#!/bin/bash
set -e

echo "=== 快速修复小程序创建任务失败 ==="

cd /root/tnho-video

# 1. 拉取最新代码
echo "1. 拉取最新代码..."
git pull origin main

# 2. 重启应用
echo "2. 重启应用..."
bash scripts/restart-app.sh

# 3. 验证服务
echo "3. 验证服务..."
sleep 3

if curl -s https://tnho-fasteners.com/api/health > /dev/null; then
    echo "✓ 服务正常运行"
else
    echo "✗ 服务异常"
    exit 1
fi

# 4. 测试数据库连接
echo "4. 测试数据库连接..."
source venv/bin/activate
python -c "from storage.database.db import get_session; db = get_session(); print('✓ 数据库连接成功'); db.close()"

# 5. 测试任务创建
echo "5. 测试任务创建..."
curl -X POST https://tnho-fasteners.com/api/generate-video \
  -H "Content-Type: application/json" \
  -d '{"product_name":"测试","theme":"品质保证","duration":20,"type":"video"}' \
  | python -m json.tool

echo "=== 修复完成 ==="
```

保存为 `fix-tasks.sh`，然后执行：
```bash
chmod +x fix-tasks.sh
bash fix-tasks.sh
```

## 联系方式
- GitHub: https://github.com/xiebaole5/PAUL
- 服务器: 47.110.72.148
- API地址: https://tnho-fasteners.com

---
**创建日期**: 2025-02-06
