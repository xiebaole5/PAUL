# 服务器紧急修复步骤

## 问题分析

### 错误1：本地修改冲突
```
error: Your local changes to the following files would be overwritten by merge:
        miniprogram/app.js
        src/api/app.js
```

### 错误2：脚本文件不存在
```
bash: scripts/restart-app.sh: No such file or directory
```

### 错误3：模块导入失败
```
ModuleNotFoundError: No module named 'storage'
```

## 解决方案

### 步骤1：检查本地修改并决定处理方式

```bash
cd /root/tnho-video

# 查看本地修改的内容
git diff miniprogram/app.js
git diff src/api/app.py
```

**选项A：如果本地修改不重要，直接丢弃**
```bash
git checkout -- miniprogram/app.js src/api/app.js
```

**选项B：如果本地修改重要，先保存**
```bash
git stash
```

### 步骤2：拉取最新代码

```bash
git pull origin main
```

### 步骤3：创建必要的目录和脚本

```bash
# 创建 scripts 目录
mkdir -p scripts

# 确保 src/storage 目录存在
mkdir -p src/storage/database
mkdir -p src/storage/memory
```

### 步骤4：检查并恢复 storage 模块

如果 `src/storage` 目录不存在或内容缺失，需要手动创建：

```bash
cd /root/tnho-video

# 检查 storage 目录
ls -la src/storage/

# 如果不存在，从 GitHub 查看并手动创建缺失的文件
# 或者直接使用之前备份的代码
```

### 步骤5：创建重启脚本

```bash
cat > scripts/restart-app.sh << 'EOF'
#!/bin/bash

# 小程序应用重启脚本

set -e

PROJECT_DIR="/root/tnho-video"

echo "=== 重启应用 ==="
cd "$PROJECT_DIR"

# 停止旧进程
echo "停止旧进程..."
pkill -f "uvicorn app:app" || true
sleep 2

# 启动新进程
echo "启动新进程..."
source venv/bin/activate
nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 &

sleep 3

# 检查进程
if ps aux | grep -v grep | grep "uvicorn app:app" > /dev/null; then
    echo "✓ 应用启动成功"
else
    echo "✗ 应用启动失败"
    exit 1
fi
EOF

chmod +x scripts/restart-app.sh
```

### 步骤6：重启应用

```bash
bash scripts/restart-app.sh
```

### 步骤7：测试服务

```bash
# 测试健康检查
curl -s https://tnho-fasteners.com/api/health

# 查看日志
tail -n 50 logs/app.log
```

## 一键执行脚本

将以下脚本保存为 `emergency-fix.sh` 并执行：

```bash
#!/bin/bash

set -e

COLOR_GREEN='\033[0;32m'
COLOR_RED='\033[0;31m'
COLOR_BLUE='\033[0;34m'
COLOR_RESET='\033[0m'

print_success() {
    echo -e "${COLOR_GREEN}✓ $1${COLOR_RESET}"
}

print_error() {
    echo -e "${COLOR_RED}✗ $1${COLOR_RESET}"
}

print_info() {
    echo -e "${COLOR_BLUE}ℹ $1${COLOR_RESET}"
}

print_header() {
    echo ""
    echo -e "${COLOR_BLUE}========================================${COLOR_RESET}"
    echo -e "${COLOR_BLUE}$1${COLOR_RESET}"
    echo -e "${COLOR_BLUE}========================================${COLOR_RESET}"
}

PROJECT_DIR="/root/tnho-video"

print_header "服务器紧急修复"
print_info "开始时间: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""

cd "$PROJECT_DIR" || exit 1

# 1. 处理本地修改
print_header "1. 处理本地修改"
print_info "检查本地修改..."

if git diff --quiet miniprogram/app.js src/api/app.py; then
    print_info "没有本地修改"
else
    print_warning "发现本地修改，将使用 stash 保存"
    git stash push -m "本地修改备份 $(date '+%Y%m%d_%H%M%S')" miniprogram/app.js src/api/app.py || true
    print_success "本地修改已保存到 stash"
fi

# 2. 拉取最新代码
print_header "2. 拉取最新代码"
if git pull origin main; then
    print_success "代码拉取成功"
else
    print_error "代码拉取失败"
    exit 1
fi

# 3. 检查必要目录
print_header "3. 检查必要目录"

mkdir -p scripts src/storage/database src/storage/memory
print_success "必要目录已创建"

# 4. 检查 storage 模块
print_header "4. 检查 storage 模块"

if [ -f "src/storage/database/db.py" ] && [ -f "src/storage/database/video_task_manager.py" ]; then
    print_success "storage 模块文件存在"
else
    print_error "storage 模块文件缺失，需要手动创建"
    print_info "请检查以下文件："
    echo "  - src/storage/database/db.py"
    echo "  - src/storage/database/video_task_manager.py"
    echo "  - src/storage/memory/memory_saver.py"
    exit 1
fi

#end

# 5. 创建重启脚本
print_header "5. 创建重启脚本"

cat > scripts/restart-app.sh << 'EOF'
#!/bin/bash

# 小程序应用重启脚本

set -e

PROJECT_DIR="/root/tnho-video"

echo "=== 重启应用 ==="
cd "$PROJECT_DIR"

# 停止旧进程
echo "停止旧进程..."
pkill -f "uvicorn app:app" || true
sleep 2

# 启动新进程
echo "启动新进程..."
source venv/bin/activate
nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 &

sleep 3

# 检查进程
if ps aux | grep -v grep | grep "uvicorn app:app" > /dev/null; then
    echo "✓ 应用启动成功"
else
    echo "✗ 应用启动失败"
    exit 1
fi
EOF

chmod +x scripts/restart-app.sh
print_success "重启脚本已创建"

# 6. 重启应用
print_header "6. 重启应用"
bash scripts/restart-app.sh

# 7. 测试服务
print_header "7. 测试服务"

sleep 2

if curl -s https://tnho-fasteners.com/api/health > /dev/null; then
    print_success "HTTPS 服务正常"
else
    print_warning "HTTPS 服务异常，尝试 HTTP..."
    if curl -s http://localhost:8000/api/health > /dev/null; then
        print_success "HTTP 服务正常"
    else
        print_error "服务异常"
    fi
fi

# 8. 查看日志
print_header "8. 查看最新日志"
print_info "最近 10 行日志："
echo ""
tail -n 10 logs/app.log || echo "日志文件不存在"

# 9. 完成
print_header "修复完成"
print_info "完成时间: $(date '+%Y-%m-%d %H:%M:%S')"
echo ""
print_success "修复已完成"
echo ""
print_info "如果问题仍然存在，请查看："
echo "  1. 完整日志: tail -f logs/app.log"
echo "  2. 错误日志: tail -f logs/error.log"
echo "  3. Python 路径: python -c 'import sys; print(sys.path)'"
echo ""
print_info "如果 storage 模块仍然缺失，可能需要："
echo "  1. 从备份恢复代码"
echo "  2. 手动创建缺失的文件"
echo "  3. 检查 GitHub 仓库的完整代码"
```

## 执行步骤

### 方法1：使用一键脚本（推荐）

```bash
cd /root/tnho-video

# 创建脚本
cat > emergency-fix.sh << 'EOF'
# [复制上面的完整脚本内容]
EOF

# 执行脚本
chmod +x emergency-fix.sh
bash emergency-fix.sh
```

### 方法2：手动执行

```bash
cd /root/tnho-video

# 1. 保存本地修改
git stash

# 2. 拉取代码
git pull origin main

# 3. 创建必要目录
mkdir -p scripts src/storage/database src/storage/memory

# 4. 检查 storage 模块
ls -la src/storage/database/

# 5. 创建重启脚本
# [使用上面的脚本内容]

# 6. 重启应用
bash scripts/restart-app.sh

# 7. 测试
curl -s https://tnho-fasteners.com/api/health
```

## 如果 storage 模块仍然缺失

检查以下文件是否存在：

```bash
# 数据库模块
ls -la src/storage/database/db.py
ls -la src/storage/database/video_task_manager.py

# 记忆模块
ls -la src/storage/memory/memory_saver.py

# 如果不存在，需要从 GitHub 恢复或手动创建
```

从 GitHub 查看完整代码：
https://github.com/xiebaole5/PAUL

或者检查是否有备份：
```bash
git stash list
```

## 检查 Python 路径

```bash
source venv/bin/activate
python -c "import sys; print('\n'.join(sys.path))"
```

确保 `/root/tnho-video/src` 在 Python 路径中。

## 联系方式
- GitHub: https://github.com/xiebaole5/PAUL
- 服务器: 47.110.72.148
- API地址: https://tnho-fasteners.com

---
**创建日期**: 2025-02-06
