# 小程序正式发布 - 快速测试指南

## 一、测试前准备

### 1. 检查服务器状态
```bash
# SSH 登录服务器
ssh root@47.110.72.148

# 检查服务状态
sudo systemctl status nginx
ps aux | grep uvicorn
docker ps | grep postgres
```

### 2. 检查域名配置
```bash
# 测试域名解析
ping tnho-fasteners.com

# 测试 HTTPS 连接
curl -I https://tnho-fasteners.com
```

### 3. 检查 Cloudflare 配置
- 登录 Cloudflare：https://dash.cloudflare.com
- 选择域名：tnho-fasteners.com
- 检查 SSL/TLS 模式：必须为 **Full**
- 检查 DNS 记录：A 记录指向 47.110.72.148，代理状态为"已代理"

---

## 二、API 接口测试

### 方法 1：使用自动化测试脚本（推荐）

```bash
# 在服务器上运行
cd /root/tnho-video
bash scripts/test-all-apis.sh
```

**预期输出**：
```
========================================
测试结果汇总
========================================
总测试数: 10
通过: 10
失败: 0

✓ 所有测试通过！小程序可以正常使用。
```

### 方法 2：手动测试各个接口

#### 测试 1：健康检查
```bash
curl https://tnho-fasteners.com/api/health
```

**预期结果**：
```json
{
  "status": "healthy",
  "timestamp": "2026-01-14T..."
}
```

#### 测试 2：图片上传
```bash
# 创建测试文件
echo "Test content" > /tmp/test.txt

# 测试上传
curl -X POST https://tnho-fasteners.com/api/upload-image \
  -F "file=@/tmp/test.txt"
```

**预期结果**：
```json
{
  "status": "success",
  "url": "https://tos-s3-cn-beijing.volces.com/...",
  "message": "图片上传成功"
}
```

#### 测试 3：脚本生成
```bash
curl -X POST https://tnho-fasteners.com/api/generate-script \
  -H "Content-Type: application/json" \
  -d '{"theme": "品质保证", "duration": 20}'
```

**预期结果**：
```json
{
  "status": "success",
  "script": "场景描述：展示产品质量检测...",
  "scenes": [...]
}
```

#### 测试 4：视频生成
```bash
curl -X POST https://tnho-fasteners.com/api/generate-video \
  -H "Content-Type: application/json" \
  -d '{"theme": "品质保证", "duration": 20}'
```

**预期结果**：
```json
{
  "status": "success",
  "task_id": "uuid-xxxx-xxxx",
  "message": "视频生成任务已启动，请查询进度"
}
```

#### 测试 5：进度查询
```bash
# 替换 {task_id} 为实际返回的任务 ID
curl https://tnho-fasteners.com/api/progress/{task_id}
```

**预期结果**：
```json
{
  "status": "processing",
  "progress": 30,
  "current_stage": "生成第1段视频",
  "message": "正在生成视频片段"
}
```

---

## 三、小程序功能测试

### 1. 准备测试环境

#### 打开微信开发者工具
1. 打开微信开发者工具
2. 导入项目：`C:\Users\12187\Desktop\tnho-miniprogram`
3. AppID: `wx464504ca7e01b3b1`
4. 点击"编译"

#### 关闭域名校验（仅开发阶段）
- 位置：右上角 > 详情 > 本地设置
- 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"

### 2. 测试图片上传

**测试步骤**：
1. 点击"上传图片"按钮
2. 选择一张图片
3. 观察结果

**预期结果**：
- ✅ 图片预览显示
- ✅ Console 显示"图片上传成功"
- ✅ Network 标签显示请求成功（200 状态码）

**检查 Console**：
```javascript
// 成功示例
图片上传成功: {
  "status": "success",
  "url": "https://tos-s3-cn-beijing.volces.com/..."
}

// 失败示例
上传图片失败: request:fail url not in domain list
```

**检查 Network**：
- 请求 URL：`https://tnho-fasteners.com/api/upload-image`
- 状态码：`200`
- 响应：`{"status": "success", "url": "..."}`

### 3. 测试视频生成

**测试步骤**：
1. 选择视频主题：如"品质保证"
2. 选择视频时长：如"20 秒"
3. （可选）上传产品图片
4. 点击"生成视频"按钮
5. 等待生成完成（约 1-2 分钟）

**预期结果**：
- ✅ 进度条正常显示
- ✅ Console 显示进度更新
- ✅ 生成完成后显示视频播放器
- ✅ 视频可以正常播放

**检查 Console**：
```javascript
// 开始生成
开始生成视频: {"theme": "品质保证", "duration": 20}

// 任务创建成功
视频生成任务已创建: {
  "status": "success",
  "task_id": "uuid-xxxx-xxxx"
}

// 进度更新
当前进度: 30, 阶段: 生成第1段视频
当前进度: 60, 阶段: 生成第2段视频
当前进度: 80, 阶段: 拼接视频

// 生成完成
视频生成完成: {
  "status": "completed",
  "progress": 100,
  "video_url": "https://tos-s3-cn-beijing.volces.com/..."
}
```

### 4. 测试脚本生成

**测试步骤**：
1. 选择主题：如"工业应用"
2. 选择时长：如"30 秒"
3. 点击"生成脚本"按钮
4. 等待生成完成

**预期结果**：
- ✅ 显示完整的脚本内容
- ✅ 包含场景描述、文案、音效
- ✅ 脚本内容与主题相关

---

## 四、小程序后台域名配置

### 配置步骤

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 使用小程序管理员账号登录
   - AppID: `wx464504ca7e01b3b1`

2. **配置服务器域名**
   - 位置：开发 > 开发管理 > 开发设置 > 服务器域名

3. **添加以下域名**：
   - **request 合法域名**：`https://tnho-fasteners.com`
   - **uploadFile 合法域名**：`https://tnho-fasteners.com`
   - **downloadFile 合法域名**：
     - `https://tnho-fasteners.com`
     - `https://*.tos-s3-cn-beijing.volces.com`

4. **保存配置**
   - 点击"保存"按钮
   - 等待 15-30 分钟让配置生效

### 验证配置

1. 取消勾选"不校验合法域名"
2. 重新编译小程序
3. 测试图片上传功能
4. 如果出现"不在以下 request 合法域名列表中"错误，说明配置未生效，请等待更长时间

---

## 五、问题排查

### 问题 1：图片上传失败

**错误信息**：`request:fail url not in domain list`

**原因**：小程序后台域名未配置或未生效

**解决方法**：
1. 检查 uploadFile 合法域名是否包含 `https://tnho-fasteners.com`
2. 等待 15-30 分钟让配置生效
3. 检查 Cloudflare SSL/TLS 模式是否为 Full

### 问题 2：SSL 证书错误

**错误信息**：`request:fail -2 net::ERR_SSL_PROTOCOL_ERROR`

**原因**：SSL 证书配置问题

**解决方法**：
1. 检查 Let's Encrypt 证书是否有效：`sudo certbot certificates`
2. 检查 Cloudflare SSL/TLS 模式是否为 Full（不能是 Flexible）
3. 测试 HTTPS 连接：`curl -I https://tnho-fasteners.com`

### 问题 3：视频生成失败

**错误信息**：视频生成失败

**原因**：后端服务异常或 API Key 问题

**解决方法**：
1. 查看服务器日志：`tail -f /root/tnho-video/logs/app.log`
2. 检查 Python 应用是否运行：`ps aux | grep uvicorn`
3. 检查火山方舟 API Key 是否有效

### 问题 4：视频播放失败

**错误信息**：video error

**原因**：视频格式不支持或 downloadFile 域名未配置

**解决方法**：
1. 检查 downloadFile 合法域名
2. 在浏览器中测试视频 URL 是否可以访问
3. 确保视频为 MP4 格式，H.264 编码

---

## 六、发布前检查清单

### 服务器端
- [ ] Nginx 运行正常
- [ ] Python 应用运行正常
- [ ] PostgreSQL 容器运行正常
- [ ] SSL 证书有效（有效期 > 30 天）
- [ ] Cloudflare SSL/TLS 模式为 Full
- [ ] 所有 API 接口测试通过

### 小程序端
- [ ] 图片上传功能正常
- [ ] 视频生成功能正常
- [ ] 脚本生成功能正常
- [ ] 视频播放功能正常
- [ ] 进度查询功能正常
- [ ] 错误提示友好

### 配置检查
- [ ] 小程序后台域名配置完成
  - [ ] request 合法域名：`https://tnho-fasteners.com`
  - [ ] uploadFile 合法域名：`https://tnho-fasteners.com`
  - [ ] downloadFile 合法域名：`https://tnho-fasteners.com` 和 `https://*.tos-s3-cn-beijing.volces.com`
- [ ] "不校验合法域名"选项已关闭
- [ ] AppID 配置正确（`wx464504ca7e01b3b1`）
- [ ] API 地址配置正确（`https://tnho-fasteners.com`）

---

## 七、发布流程

### 1. 上传代码
- 微信开发者工具 > 上传
- 版本号：`1.0.0`
- 项目备注：首次正式发布

### 2. 提交审核
- 微信公众平台 > 版本管理 > 开发版本
- 点击"提交审核"
- 填写审核信息

### 3. 等待审核
- 审核时间：1-7 个工作日
- 可以在"审核列表"中查看进度

### 4. 发布上线
- 审核通过后，点击"发布"
- 确认发布信息
- 发布成功！

---

## 八、联系方式

- **服务器**：47.110.72.148
- **域名**：tnho-fasteners.com
- **AppID**：wx464504ca7e01b3b1
- **GitHub**：https://github.com/xiebaole5/PAUL.git

---

**文档版本**：1.0
**最后更新**：2026-01-14
**适用版本**：v1.0.0
