# 服务器正确执行步骤（重要！）

## ⚠️ 重要提醒
**必须先进入项目目录 `/root/tnho-video`，否则所有命令都会失败！**

## 正确的执行步骤

### 步骤1：进入项目目录
```bash
cd /root/tnho-video
```

### 步骤2：查看当前目录
```bash
pwd
# 应该输出: /root/tnho-video
```

### 步骤3：查看项目结构
```bash
ls -la
```

您应该看到：
```
total xx
drwxr-xr-x  x root root  .git
drwxr-xr-x  x root root  .env
drwxr-xr-x  x root root  app.py
drwxr-xr-x  x root root  assets
drwxr-xr-x  x root root  config
drwxr-xr-x  x root root  docs
drwxr-xr-x  x root root  logs
drwxr-xr-x  x root root  miniprogram
drwxr-xr-x  x root root  requirements.txt
drwxr-xr-x  x root root  scripts
drwxr-xr-x  x root root  src
drwxr-xr-x  x root root  venv
```

### 步骤4：保存本地修改
```bash
git stash
```

### 步骤5：拉取最新代码
```bash
git pull origin main
```

### 步骤6：创建必要目录
```bash
mkdir -p scripts src/storage/database src/storage/memory
mkdir -p logs assets/uploads
```

### 步骤7：检查 storage 模块
```bash
ls -la src/storage/
ls -la src/storage/database/
```

**如果 storage 目录为空或不存在，需要从 GitHub 恢复：**
```bash
# 克隆完整代码到临时目录
git clone https://github.com/xiebaole5/PAUL.git /tmp/paul-full

# 复制 storage 模块
cp -r /tmp/paul-full/src/storage/* src/storage/

# 删除临时目录
rm -rf /tmp/paul-full

# 验证
ls -la src/storage/
ls -la src/storage/database/
```

### 步骤8：激活虚拟环境
```bash
source venv/bin/activate
```

验证虚拟环境已激活：
```bash
which python
# 应该输出: /root/tnho-video/venv/bin/python
```

### 步骤9：测试数据库连接
```bash
python -c "from storage.database.db import get_session; db = get_session(); print('✓ 数据库连接成功'); db.close()"
```

### 步骤10：重启应用

先停止旧进程：
```bash
pkill -f "uvicorn app:app"
sleep 2
```

启动新进程：
```bash
nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 &
```

检查进程：
```bash
ps aux | grep uvicorn
```

### 步骤11：测试服务
```bash
# 本地测试
curl -s http://localhost:8000/api/health

# HTTPS 测试
curl -s https://tnho-fasteners.com/api/health
```

### 步骤12：查看日志
```bash
tail -n 50 logs/app.log
```

## 一键执行脚本（在项目目录中执行）

```bash
#!/bin/bash

# 一键修复脚本

# 1. 进入项目目录
cd /root/tnho-video

echo "=== 开始修复 ==="

# 2. 保存本地修改
echo "2. 保存本地修改..."
git stash || true

# 3. 拉取最新代码
echo "3. 拉取最新代码..."
git pull origin main || git reset --hard origin/main

# 4. 创建必要目录
echo "4. 创建必要目录..."
mkdir -p scripts src/storage/database src/storage/memory
mkdir -p logs assets/uploads

# 5. 检查并恢复 storage 模块
echo "5. 检查 storage 模块..."
if [ ! -f "src/storage/database/db.py" ]; then
    echo "storage 模块缺失，从 GitHub 恢复..."
    git clone https://github.com/xiebaole5/PAUL.git /tmp/paul-full
    cp -r /tmp/paul-full/src/storage/* src/storage/
    rm -rf /tmp/paul-full
fi

# 6. 激活虚拟环境
echo "6. 激活虚拟环境..."
source venv/bin/activate

# 7. 测试数据库连接
echo "7. 测试数据库连接..."
python -c "from storage.database.db import get_session; db = get_session(); print('✓ 数据库连接成功'); db.close()"

# 8. 重启应用
echo "8. 重启应用..."
pkill -f "uvicorn app:app"
sleep 2
nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 &
sleep 3

# 9. 测试服务
echo "9. 测试服务..."
curl -s http://localhost:8000/api/health || curl -s https://tnho-fasteners.com/api/health

# 10. 查看日志
echo "10. 查看日志..."
tail -n 20 logs/app.log

echo "=== 修复完成 ==="
```

保存为 `fix-all.sh` 并执行：
```bash
cd /root/tnho-video
cat > fix-all.sh << 'EOF'
# [复制上面的脚本内容]
EOF

chmod +x fix-all.sh
bash fix-all.sh
```

## 常见错误

### 错误1：bash: scripts/emergency-fix.sh: No such file or directory
**原因**：当前目录不在项目目录中

**解决**：
```bash
cd /root/tnho-video
pwd  # 确认当前目录
```

### 错误2：Command '、git' not found
**原因**：命令前面有中文标点符号 `、`

**解决**：复制命令时不要包含中文标点符号

### 错误3：cp: cannot stat '/tmp/paul-full/src/storage/*'
**原因**：Git clone 失败或命令前面有 `、`

**解决**：确保先成功执行 `git clone` 命令

### 错误4：tail: cannot open 'logs/app.log' for reading
**原因**：当前目录不在项目目录中

**解决**：
```bash
cd /root/tnho-video
tail -n 50 logs/app.log
```

### 错误5：-bash: venv/bin/activate: No such file or directory
**原因**：当前目录不在项目目录中

**解决**：
```bash
cd /root/tnho-video
source venv/bin/activate
```

### 错误6：Command 'python' not found
**原因**：虚拟环境未激活

**解决**：
```bash
cd /root/tnho-video
source venv/bin/activate
python --version
```

## 最简单的方法（推荐）

直接复制粘贴以下命令到服务器终端：

```bash
cd /root/tnho-video && git stash && git pull origin main && mkdir -p scripts src/storage/database src/storage/memory logs assets/uploads && git clone https://github.com/xiebaole5/PAUL.git /tmp/paul-full && cp -r /tmp/paul-full/src/storage/* src/storage/ && rm -rf /tmp/paul-full && source venv/bin/activate && python -c "from storage.database.db import get_session; db = get_session(); print('✓ 数据库连接成功'); db.close()" && pkill -f "uvicorn app:app" && sleep 2 && nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 & && sleep 3 && curl -s http://localhost:8000/api/health && tail -n 20 logs/app.log
```

这条命令会自动完成所有修复步骤！

## 验证修复

修复成功后，您应该看到：

1. ✓ storage 模块文件存在
2. ✓ 数据库连接成功
3. ✓ 应用启动成功
4. ✓ 健康检查返回 `{"status":"ok"}` 或 `{"status":"running"}`
5. ✓ 日志中没有错误

## 测试小程序

修复完成后，在微信开发者工具中测试：
1. 图片上传功能
2. 视频生成功能
3. 进度查询功能

## 联系方式
- GitHub: https://github.com/xiebaole5/PAUL
- 服务器: 47.110.72.148
- API地址: https://tnho-fasteners.com

---
**创建日期**: 2025-02-06
