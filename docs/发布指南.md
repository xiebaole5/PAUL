# 小程序正式发布完整指南

## 📋 发布前准备

### 硬件和软件环境

- **服务器**：阿里云 ECS (47.110.72.148)
- **操作系统**：Linux (Debian/Ubuntu)
- **Python版本**：3.12.3
- **Nginx**：待安装
- **SSL证书**：Let's Encrypt（已申请）✅

### 已完成的工作

- [x] Let's Encrypt证书已成功申请
- [x] 证书路径：`/etc/letsencrypt/live/tnho-fasteners.com/`
- [x] 小程序代码已更新API地址为HTTPS
- [x] 服务器应用正常运行在8000端口

---

## 第一步：安装和配置Nginx

### 1.1 安装Nginx

```bash
# 更新软件包列表
sudo apt update

# 安装Nginx
sudo apt install nginx -y

# 验证安装
nginx -v
```

### 1.2 创建Nginx配置文件

```bash
# 创建站点配置文件
sudo nano /etc/nginx/sites-available/tnho-fasteners.com
```

**复制以下内容**：

```nginx
# HTTP重定向到HTTPS
server {
    listen 80;
    server_name tnho-fasteners.com;

    # Let's Encrypt验证使用的路径
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 其他请求重定向到HTTPS
    location / {
        return 301 https://$server_name$request_uri;
    }
}

# HTTPS虚拟主机
server {
    listen 443 ssl http2;
    server_name tnho-fasteners.com;

    # SSL证书配置
    ssl_certificate /etc/letsencrypt/live/tnho-fasteners.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/tnho-fasteners.com/privkey.pem;

    # SSL协议和加密套件
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers on;

    # SSL会话缓存
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # HSTS（可选，增强安全性）
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 日志配置
    access_log /var/log/nginx/tnho-fasteners-access.log;
    error_log /var/log/nginx/tnho-fasteners-error.log;

    # 客户端最大上传大小
    client_max_body_size 10M;

    # API代理
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }

    # 静态文件服务
    location /assets/ {
        alias /app/assets/;
        expires 7d;
        add_header Cache-Control "public, immutable";
    }
}
```

保存文件：按 `Ctrl+O`，然后按 `Enter`，最后按 `Ctrl+X` 退出

### 1.3 启用站点配置

```bash
# 创建符号链接
sudo ln -s /etc/nginx/sites-available/tnho-fasteners.com /etc/nginx/sites-enabled/

# 删除默认配置（可选）
sudo rm /etc/nginx/sites-enabled/default

# 创建certbot目录（用于证书验证）
sudo mkdir -p /var/www/certbot
sudo chown -R www-data:www-data /var/www/certbot

# 测试Nginx配置
sudo nginx -t

# 如果显示 "syntax is ok" 和 "test is successful"，继续下一步
```

### 1.4 启动Nginx

```bash
# 重启Nginx
sudo systemctl restart nginx

# 设置开机自启
sudo systemctl enable nginx

# 检查Nginx状态
sudo systemctl status nginx
```

### 1.5 配置防火墙（如果启用）

```bash
# 如果使用UFW
sudo ufw allow 'Nginx Full'
sudo ufw status

# 如果使用iptables
sudo iptables -A INPUT -p tcp --dport 80 -j ACCEPT
sudo iptables -A INPUT -p tcp --dport 443 -j ACCEPT
sudo service iptables save
```

---

## 第二步：配置Cloudflare SSL/TLS

### 2.1 登录Cloudflare

访问 https://dash.cloudflare.com/ 并登录

### 2.2 配置SSL/TLS模式

1. 选择域名 `tnho-fasteners.com`
2. 进入 **SSL/TLS > Overview**
3. 将模式设置为 **Full** 或 **Full (strict)**
4. 确保以下选项已启用：
   - ✅ Always Use HTTPS
   - ✅ Automatic HTTPS Rewrites

### 2.3 配置缓存规则（推荐）

进入 **Caching** 页面：
- 设置 **Caching Level** 为 **Standard**
- 创建缓存规则（可选，优化静态资源加载）

### 2.4 配置安全设置（推荐）

进入 **Security** 页面：
- 启用 **Bot Fight Mode**
- 配置防火墙规则防止滥用

---

## 第三步：测试HTTPS访问

### 3.1 测试API健康检查

```bash
# 测试HTTPS访问
curl https://tnho-fasteners.com/health

# 应该返回：{"status":"ok"}
```

### 3.2 测试图片上传

```bash
# 使用API测试脚本
cd /app/tests
python test_server_api.py
```

### 3.3 检查SSL证书

访问 https://www.ssllabs.com/ssltest/analyze.html?d=tnho-fasteners.com

应该看到：
- Grade: A 或 A+
- Certificate: Valid
- Chain: Complete

---

## 第四步：配置小程序后台

### 4.1 获取AppID

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **设置 > 基本设置**
3. 查看并记录 **AppID**

### 4.2 配置小程序基本信息

在 **设置 > 基本设置** 中完善：

- **小程序名称**：天虹紧固件
- **小程序简介**：AI视频生成系统，为紧固件产品生成宣传视频
- **服务类目**：工具 > 其他工具
- **上传头像**：红色TNHO Logo

### 4.3 配置服务器域名（重要）

进入 **开发 > 开发管理 > 服务器域名**，添加以下域名：

| 类型 | 域名 |
|------|------|
| request合法域名 | `https://tnho-fasteners.com` |
| uploadFile合法域名 | `https://tnho-fasteners.com` |
| downloadFile合法域名 | `https://tnho-fasteners.com` |

保存并等待审核（通常1-2小时）

### 4.4 配置业务域名（可选）

如果需要使用 `<web-view>` 组件，在 **业务域名** 中添加：
- `https://tnho-fasteners.com`

---

## 第五步：上传小程序代码

### 5.1 配置小程序

使用微信开发者工具：

1. 打开微信开发者工具
2. 导入项目：选择 `miniprogram` 目录
3. 填写 **AppID**（从第四步获取）
4. 点击"导入"

### 5.2 检查配置

确认 `miniprogram/app.js` 中的API地址：

```javascript
globalData: {
  // 生产环境（正式上线）：
  apiUrl: 'https://tnho-fasteners.com',
}
```

### 5.3 开启域名校验

在微信开发者工具中：
1. 点击右上角 **详情**
2. 进入 **本地设置**
3. **取消勾选**"不校验合法域名..."（正式上线需要）

### 5.4 测试小程序

1. 点击"编译"运行小程序
2. 测试图片上传功能
3. 测试视频生成功能
4. 测试脚本生成功能
5. 确认所有功能正常

---

## 第六步：提交审核

### 6.1 上传代码

在微信开发者工具中：

1. 点击 **上传** 按钮
2. 填写版本号：`1.0.0`
3. 填写项目备注：初始版本，支持AI视频生成
4. 点击"确定"

### 6.2 提交审核

登录[微信公众平台](https://mp.weixin.qq.com/)：

1. 进入 **管理 > 版本管理**
2. 找到刚上传的版本（1.0.0）
3. 点击"提交审核"
4. 填写审核信息：
   - **测试账号**：无需填写（本小程序不需要登录）
   - **功能页面**：首页（视频生成）
   - **服务类目**：工具 > 其他工具
   - **标签**：AI、视频生成、工具
5. 点击"提交"

### 6.3 等待审核

- 审核时间：1-7个工作日（通常1-2天）
- 审核通过后会收到微信通知
- 可以在"版本管理"中查看审核进度

---

## 第七步：发布上线

### 7.1 检查审核结果

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入 **管理 > 版本管理**
3. 查看审核状态

### 7.2 发布小程序

审核通过后：

1. 在版本管理中找到已审核通过的版本
2. 点击"发布"按钮
3. 确认发布信息
4. 点击"确定"

### 7.3 验证发布

发布成功后：

1. 在微信中搜索"天虹紧固件"
2. 找到小程序并打开
3. 测试所有功能是否正常

---

## 发布后维护

### 日常监控

```bash
# 检查Nginx状态
sudo systemctl status nginx

# 查看Nginx访问日志
sudo tail -f /var/log/nginx/tnho-fasteners-access.log

# 查看Nginx错误日志
sudo tail -f /var/log/nginx/tnho-fasteners-error.log

# 检查应用状态
ps aux | grep "python app.py"

# 检查服务器资源
htop
```

### 证书自动续期

Let's Encrypt证书已配置自动续期，可通过以下命令查看：

```bash
# 查看续期任务
sudo systemctl status certbot.timer

# 手动测试续期
sudo certbot renew --dry-run
```

### 版本更新

发布新版本时：

1. 更新小程序代码
2. 修改版本号（如1.1.0）
3. 上传代码
4. 提交审核
5. 审核通过后发布

### 错误处理

如果遇到问题：

1. 查看服务器日志
2. 查看小程序控制台日志
3. 运行API测试脚本
4. 根据错误信息排查问题

---

## 配置清单

发布前请确认以下项目：

### 服务器配置
- [ ] Nginx已安装并启动
- [ ] Nginx配置文件已创建
- [ ] SSL证书路径正确
- [ ] 应用正在运行（8000端口）
- [ ] 防火墙已开放80和443端口
- [ ] HTTPS访问正常（`https://tnho-fasteners.com/health`）

### Cloudflare配置
- [ ] DNS记录已配置并代理
- [ ] SSL/TLS模式设置为Full
- [ ] Always Use HTTPS已启用
- [ ] 缓存规则已配置
- [ ] 安全规则已配置

### 小程序配置
- [ ] 小程序已注册并获取AppID
- [ ] 小程序基本信息已完善
- [ ] 服务器域名已配置（request/uploadFile/downloadFile）
- [ ] API地址已更新为HTTPS
- [ ] 小程序代码已上传
- [ ] 已提交审核
- [ ] 审核通过并发布

---

## 常见问题

### 1. Nginx启动失败

```bash
# 查看错误日志
sudo tail -f /var/log/nginx/error.log

# 检查配置
sudo nginx -t

# 常见原因：
# - 证书路径错误
# - 端口被占用
# - 配置语法错误
```

### 2. HTTPS访问失败

```bash
# 检查证书
sudo ls -la /etc/letsencrypt/live/tnho-fasteners.com/

# 检查Nginx配置
sudo grep ssl_certificate /etc/nginx/sites-available/tnho-fasteners.com

# 直接测试服务器
curl -kI https://47.110.72.148/health
```

### 3. 小程序无法连接服务器

- 检查服务器域名是否已配置
- 检查API地址是否正确
- 检查HTTPS证书是否有效
- 检查Cloudflare配置

### 4. 审核被拒绝

常见原因：
- 服务器域名未配置或配置错误
- 使用了自签名证书（已解决，使用Let's Encrypt）
- 功能描述与实际不符
- 存在明显Bug
- 违反小程序运营规范

解决方法：
- 修改问题项
- 重新提交审核
- 联系微信客服（必要时）

---

## 参考资料

- [微信小程序官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [Let's Encrypt官方文档](https://letsencrypt.org/docs/)
- [Nginx官方文档](https://nginx.org/en/docs/)
- [Cloudflare官方文档](https://developers.cloudflare.com/)

---

**发布时间**：2025年1月
**适用版本**：小程序 v1.0.0
**配置文件**：
- Nginx配置：`docs/nginx-ssl-config.md`
- Cloudflare配置：`docs/cloudflare-config.md`
- 问题修复指南：`miniprogram/问题修复指南.md`

---

**祝你发布顺利！🎉**
