# 小程序功能测试与诊断指南

## 一、诊断环境检查

### 1. 服务器状态检查

#### 检查 Nginx 运行状态
```bash
sudo systemctl status nginx --no-pager
```

**预期结果**：
```
● nginx.service - A high performance web server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled)
   Active: active (running) since ...
```

#### 检查 Python 应用运行状态
```bash
ps aux | grep uvicorn
```

**预期结果**：
```
root     XXXXX  0.2 11.0 634956 182888 ?       Sl   ... python -m uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1
```

#### 检查端口监听
```bash
sudo netstat -tlnp | grep -E ':(80|443|8000)'
```

**预期结果**：
```
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      XXXXX/nginx
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      XXXXX/nginx
tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN      XXXXX/python
```

### 2. SSL 证书检查

#### 检查 Let's Encrypt 证书
```bash
sudo certbot certificates
```

**预期结果**：
```
- Certificate Name: tnho-fasteners.com
  Domains: tnho-fasteners.com www.tnho-fasteners.com
  Expiry Date: 2026-04-13
  VALID: True
```

#### 测试 HTTPS 连接
```bash
curl -I https://tnho-fasteners.com 2>&1 | grep -E "(HTTP|SSL|certificate)"
```

**预期结果**：
```
HTTP/2 200
server: nginx/1.24.0 (Ubuntu)
strict-transport-security: max-age=31536000
```

### 3. Cloudflare 配置检查

#### 访问 Cloudflare 控制台
- 登录：https://dash.cloudflare.com
- 选择域名：tnho-fasteners.com
- 进入 **SSL/TLS** 设置

**检查项**：
- SSL/TLS 加密模式：必须是 **Full**（不是 Flexible 或 Full (strict)）
- Universal SSL：必须已启用

#### DNS 配置检查
**位置**：DNS > Records

| 类型 | 名称 | 内容 | 代理状态 |
|------|------|------|---------|
| A | @ | 47.110.72.148 | 已代理（橙色云） ✅ |

**注意**：
- 代理状态必须是"已代理"（橙色云），不能是"仅DNS"（灰色云）
- TTL 可以设置为自动

---

## 二、API 功能测试

### 1. 测试图片上传接口

#### 准备测试图片
```bash
# 创建一个测试图片（如果还没有）
cd /root/tnho-video
echo "Test image content" > test.txt
```

#### 使用 curl 测试上传
```bash
# 方法 1：直接上传文本文件测试
curl -X POST https://tnho-fasteners.com/api/upload-image \
  -F "file=@/root/tnho-video/test.txt" \
  -v 2>&1 | tee /tmp/upload_test.log
```

**预期结果**：
```json
{
  "status": "success",
  "url": "https://tos-s3-cn-beijing.volces.com/...",
  "message": "图片上传成功"
}
```

#### 查看测试日志
```bash
cat /tmp/upload_test.log | grep -E "(HTTP|< HTTP)"
```

#### 常见错误及原因

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `curl: (60) SSL certificate problem` | SSL 证书问题 | 检查 Let's Encrypt 证书 |
| `HTTP/2 405` | 方法不允许（测试 HEAD 请求） | 这是正常的，使用 POST 请求 |
| `HTTP/2 500` | 服务器内部错误 | 查看应用日志 |
| `Connection refused` | 服务未运行 | 重启 Python 应用 |
| `timeout` | 请求超时 | 检查网络和防火墙 |

### 2. 测试视频生成接口

#### 测试脚本生成
```bash
curl -X POST https://tnho-fasteners.com/api/generate-script \
  -H "Content-Type: application/json" \
  -d '{"theme": "品质保证", "duration": 20}' \
  -v 2>&1 | tee /tmp/script_test.log
```

**预期结果**：
```json
{
  "status": "success",
  "script": "场景描述：展示产品质量检测...",
  "scenes": [...]
}
```

#### 测试视频生成（异步）
```bash
curl -X POST https://tnho-fasteners.com/api/generate-video \
  -H "Content-Type: application/json" \
  -d '{"theme": "品质保证", "duration": 20}' \
  -v 2>&1 | tee /tmp/video_test.log
```

**预期结果**：
```json
{
  "status": "success",
  "task_id": "uuid-xxxx-xxxx",
  "message": "视频生成任务已启动，请查询进度"
}
```

#### 查询任务进度
```bash
# 替换 {task_id} 为实际返回的任务 ID
curl https://tnho-fasteners.com/api/progress/uuid-xxxx-xxxx \
  -v 2>&1 | tee /tmp/progress_test.log
```

**预期结果**：
```json
{
  "status": "processing",
  "progress": 30,
  "current_stage": "生成第1段视频",
  "message": "正在生成视频片段"
}
```

### 3. 查看应用日志

#### 实时查看日志
```bash
tail -f /root/tnho-video/logs/app.log
```

#### 查看最近 100 行
```bash
tail -n 100 /root/tnho-video/logs/app.log
```

#### 搜索错误信息
```bash
grep -i "error" /root/tnho-video/logs/app.log | tail -n 20
```

#### 搜索 API 请求
```bash
grep "/api/upload-image" /root/tnho-video/logs/app.log | tail -n 10
grep "/api/generate-video" /root/tnho-video/logs/app.log | tail -n 10
```

---

## 三、小程序功能测试

### 1. 测试环境准备

#### 微信开发者工具设置
1. 打开微信开发者工具
2. 导入小程序项目（`C:\Users\12187\Desktop\tnho-miniprogram`）
3. AppID: `wx464504ca7e01b3b1`
4. 点击"编译"

#### 关闭域名校验（仅开发阶段）
**位置**：右上角 > 详情 > 本地设置
- 勾选"不校验合法域名、web-view（业务域名）、TLS 版本以及 HTTPS 证书"
- ⚠️ **注意**：正式发布前必须关闭此选项

### 2. 图片上传功能测试

#### 测试步骤
1. 打开小程序首页
2. 点击"上传图片"按钮
3. 选择一张图片
4. 观察控制台输出

#### 检查点
✅ **成功表现**：
- 图片预览显示
- Console 无红色错误
- Network 标签显示 `/api/upload-image` 请求成功（状态码 200）

❌ **失败表现及原因**：

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `request:fail url not in domain list` | 域名未配置 | 配置 uploadFile 合法域名 |
| `request:fail -2 net::ERR_SSL_PROTOCOL_ERROR` | SSL 证书问题 | 检查 Cloudflare SSL/TLS 模式 |
| `request:fail -2 net::ERR_CONNECTION_REFUSED` | 服务器连接失败 | 检查 Nginx 和 Python 应用状态 |
| `request:fail timeout` | 请求超时 | 检查网络和防火墙 |

#### Console 日志示例

**成功**：
```javascript
图片上传成功: {
  "status": "success",
  "url": "https://tos-s3-cn-beijing.volces.com/..."
}
```

**失败**：
```javascript
上传图片失败: {
  "errMsg": "uploadFile:fail url not in domain list"
}
```

#### Network 标签检查
**请求信息**：
- 请求 URL：`https://tnho-fasteners.com/api/upload-image`
- 请求方法：`POST`
- 请求头：`Content-Type: multipart/form-data`

**响应信息**：
- 状态码：`200`
- 响应类型：`application/json`
- 响应体：`{"status": "success", "url": "..."}`

### 3. 视频生成功能测试

#### 测试步骤
1. 选择视频主题（如"品质保证"）
2. 选择视频时长（如 20 秒）
3. （可选）上传产品图片
4. 点击"生成视频"按钮
5. 观察进度条和结果

#### 检查点
✅ **成功表现**：
- 进度条正常显示
- Console 显示进度更新
- 视频生成完成后显示视频播放器
- 可以正常播放视频

❌ **失败表现及原因**：

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `request:fail url not in domain list` | 域名未配置 | 配置 request 合法域名 |
| `视频生成失败` | 后端 API 错误 | 查看服务器日志 |
| `进度查询失败` | 进度查询 API 错误 | 检查 task_id 是否正确 |

#### Console 日志示例

**开始生成**：
```javascript
开始生成视频: {
  "theme": "品质保证",
  "duration": 20
}
```

**任务创建成功**：
```javascript
视频生成任务已创建: {
  "status": "success",
  "task_id": "uuid-xxxx-xxxx"
}
```

**进度更新**：
```javascript
当前进度: 30, 阶段: 生成第1段视频
当前进度: 60, 阶段: 生成第2段视频
当前进度: 80, 阶段: 拼接视频
```

**生成完成**：
```javascript
视频生成完成: {
  "status": "completed",
  "progress": 100,
  "video_url": "https://tos-s3-cn-beijing.volces.com/..."
}
```

#### Network 标签检查

**生成视频请求**：
- 请求 URL：`https://tnho-fasteners.com/api/generate-video`
- 请求方法：`POST`
- 请求头：`Content-Type: application/json`
- 响应：`{"status": "success", "task_id": "uuid-xxxx-xxxx"}`

**查询进度请求**（多个）：
- 请求 URL：`https://tnho-fasteners.com/api/progress/uuid-xxxx-xxxx`
- 请求方法：`GET`
- 响应：`{"status": "processing", "progress": 30, ...}`

### 4. 视频播放功能测试

#### 测试步骤
1. 等待视频生成完成
2. 点击视频播放器
3. 观察视频播放情况

#### 检查点
✅ **成功表现**：
- 视频播放器正常显示
- 视频可以流畅播放
- 声音正常

❌ **失败表现及原因**：

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| `video error` | 视频格式不支持 | 确保视频为 MP4 格式，H.264 编码 |
| `network error` | 视频下载失败 | 检查 downloadFile 合法域名 |
| `playback failed` | 视频损坏 | 重新生成视频 |

---

## 四、常见问题排查流程

### 问题 1：图片上传失败

#### 诊断流程
```
1. 检查小程序后台域名配置
   ↓
2. 检查 Cloudflare SSL/TLS 模式（必须为 Full）
   ↓
3. 测试 API 接口（curl 命令）
   ↓
4. 查看服务器日志
   ↓
5. 检查网络和防火墙
```

#### 详细排查步骤

**步骤 1：检查小程序后台域名配置**
- 登录：https://mp.weixin.qq.com
- 位置：开发 > 开发管理 > 开发设置 > 服务器域名
- 检查 `uploadFile 合法域名` 是否包含 `https://tnho-fasteners.com`

**步骤 2：检查 Cloudflare SSL/TLS 模式**
- 登录：https://dash.cloudflare.com
- 选择域名：tnho-fasteners.com
- 进入 SSL/TLS 设置
- 确保模式为 **Full**（不是 Flexible）

**步骤 3：测试 API 接口**
```bash
# 使用 curl 测试
curl -X POST https://tnho-fasteners.com/api/upload-image \
  -F "file=@test.txt" \
  -v
```

**步骤 4：查看服务器日志**
```bash
# 实时查看日志
tail -f /root/tnho-video/logs/app.log

# 搜索上传相关错误
grep "upload" /root/tnho-video/logs/app.log
```

**步骤 5：检查网络和防火墙**
```bash
# 检查防火墙状态
sudo ufw status

# 允许必要端口
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 8000/tcp
```

### 问题 2：视频生成失败

#### 诊断流程
```
1. 检查 Python 应用运行状态
   ↓
2. 检查火山方舟 API Key
   ↓
3. 查看服务器日志（详细错误信息）
   ↓
4. 测试脚本生成接口
   ↓
5. 检查数据库连接
```

#### 详细排查步骤

**步骤 1：检查 Python 应用运行状态**
```bash
ps aux | grep uvicorn
sudo systemctl status python-app
```

**步骤 2：检查火山方舟 API Key**
```bash
cat /root/tnho-video/.env | grep ARK_API_KEY
```

**步骤 3：查看服务器日志**
```bash
tail -n 100 /root/tnho-video/logs/app.log
grep "ERROR" /root/tnho-video/logs/app.log
```

**步骤 4：测试脚本生成接口**
```bash
curl -X POST https://tnho-fasteners.com/api/generate-script \
  -H "Content-Type: application/json" \
  -d '{"theme": "品质保证", "duration": 20}'
```

**步骤 5：检查数据库连接**
```bash
# 检查 PostgreSQL 容器
docker ps | grep postgres

# 进入数据库
docker exec -it tnho-postgres psql -U tnho_user -d tnho_video

# 检查任务表
SELECT * FROM video_generation_tasks ORDER BY created_at DESC LIMIT 5;
```

### 问题 3：视频播放失败

#### 诊断流程
```
1. 检查视频 URL 是否有效
   ↓
2. 检查小程序 downloadFile 域名配置
   ↓
3. 在浏览器中测试视频 URL
   ↓
4. 检查视频格式和编码
   ↓
5. 检查对象存储权限
```

#### 详细排查步骤

**步骤 1：检查视频 URL 是否有效**
- 从 Network 标签获取视频 URL
- 确保以 `https://` 开头

**步骤 2：检查小程序 downloadFile 域名配置**
- 登录微信公众平台
- 检查 `downloadFile 合法域名` 是否包含：
  - `https://tnho-fasteners.com`
  - `https://*.tos-s3-cn-beijing.volces.com`

**步骤 3：在浏览器中测试视频 URL**
- 复制视频 URL 到浏览器地址栏
- 尝试直接播放或下载

**步骤 4：检查视频格式和编码**
```bash
# 在服务器上查看视频信息
ffprobe /tmp/generated_video.mp4
```

**预期输出**：
```
Video: h264 (High), yuv420p, 1280x720
Audio: aac, 48000 Hz, stereo
```

**步骤 5：检查对象存储权限**
- 确保视频文件已正确上传到对象存储
- 确保文件权限设置为公开访问（或使用签名 URL）

---

## 五、测试检查清单

### 发布前必测项

#### 服务器端
- [ ] Nginx 运行正常（端口 80/443 监听）
- [ ] Python 应用运行正常（端口 8000 监听）
- [ ] SSL 证书有效（Let's Encrypt 有效期 > 30 天）
- [ ] Cloudflare SSL/TLS 模式为 Full
- [ ] 数据库连接正常（PostgreSQL 容器运行）
- [ ] API 接口正常（所有接口返回 200 状态码）
- [ ] 日志无错误信息（app.log 无 ERROR）

#### 小程序端
- [ ] 图片上传功能正常
- [ ] 视频生成功能正常
- [ ] 脚本生成功能正常
- [ ] 视频播放功能正常
- [ ] 进度查询功能正常
- [ ] 错误提示友好（用户能理解错误原因）
- [ ] 界面美观（符合主题色 #D32F2F）

#### 配置检查
- [ ] 小程序后台域名配置完成且生效
  - [ ] request 合法域名：`https://tnho-fasteners.com`
  - [ ] uploadFile 合法域名：`https://tnho-fasteners.com`
  - [ ] downloadFile 合法域名：`https://tnho-fasteners.com` 和 `https://*.tos-s3-cn-beijing.volces.com`
- [ ] 小程序 AppID 配置正确（`wx464504ca7e01b3b1`）
- [ ] API 地址配置正确（`https://tnho-fasteners.com`）
- [ ] 小程序"不校验合法域名"选项已关闭（正式发布前）

### 测试用例

#### 用例 1：图片上传 - 成功
**前置条件**：已登录小程序，网络正常

**测试步骤**：
1. 点击"上传图片"按钮
2. 选择一张 JPG/PNG 图片
3. 等待上传完成

**预期结果**：
- 图片预览显示
- 提示"图片上传成功"
- Console 无错误信息
- Network 显示 200 状态码

**实际结果**：_______

#### 用例 2：视频生成 - 成功（无图片）
**前置条件**：已登录小程序，网络正常

**测试步骤**：
1. 选择主题"品质保证"
2. 选择时长"20 秒"
3. 点击"生成视频"按钮
4. 等待生成完成（约 1-2 分钟）

**预期结果**：
- 进度条正常显示
- 提示生成进度
- 生成完成后显示视频播放器
- 视频可以正常播放

**实际结果**：_______

#### 用例 3：视频生成 - 成功（有图片）
**前置条件**：已登录小程序，网络正常，已上传图片

**测试步骤**：
1. 选择主题"技术创新"
2. 选择时长"25 秒"
3. 确认已上传产品图片
4. 点击"生成视频"按钮
5. 等待生成完成

**预期结果**：
- 进度条正常显示
- 生成的视频中包含产品元素
- 视频显示红色 TNHO 商标
- 视频可以正常播放

**实际结果**：_______

#### 用例 4：脚本生成 - 成功
**前置条件**：已登录小程序，网络正常

**测试步骤**：
1. 选择主题"工业应用"
2. 选择时长"30 秒"
3. 点击"生成脚本"按钮
4. 等待生成完成

**预期结果**：
- 显示完整的脚本内容
- 包含场景描述、文案、音效
- 脚本内容与主题相关

**实际结果**：_______

#### 用例 5：错误处理 - 网络异常
**前置条件**：断开网络连接

**测试步骤**：
1. 点击"生成视频"按钮
2. 观察错误提示

**预期结果**：
- 显示友好的错误提示
- 提示用户检查网络连接
- Console 显示详细的错误信息

**实际结果**：_______

---

## 六、性能和压力测试

### 1. 并发上传测试

```bash
# 使用 Apache Bench 测试并发上传
ab -n 10 -c 5 -p test.txt -T multipart/form-data \
  https://tnho-fasteners.com/api/upload-image
```

**预期结果**：
- 成功率 > 90%
- 平均响应时间 < 3 秒

### 2. 视频生成性能测试

```bash
# 测试多个视频生成任务
for i in {1..3}; do
  curl -X POST https://tnho-fasteners.com/api/generate-video \
    -H "Content-Type: application/json" \
    -d "{\"theme\": \"品质保证\", \"duration\": 20}" &
done
wait
```

**预期结果**：
- 所有任务都能正常完成
- 服务器资源占用正常（CPU < 80%，内存 < 1.2GB）

### 3. 进度查询测试

```bash
# 模拟小程序轮询（每 2 秒一次）
task_id="your-task-id"
for i in {1..90}; do
  response=$(curl -s https://tnho-fasteners.com/api/progress/$task_id)
  status=$(echo $response | jq -r '.status')
  progress=$(echo $response | jq -r '.progress')

  echo "[$i] Status: $status, Progress: $progress%"

  if [ "$status" == "completed" ] || [ "$status" == "failed" ]; then
    break
  fi

  sleep 2
done
```

---

## 七、问题报告模板

如果遇到问题，请按以下模板收集信息：

### 问题描述
请详细描述遇到的问题

### 环境信息
- **服务器 IP**: 47.110.72.148
- **域名**: tnho-fasteners.com
- **小程序 AppID**: wx464504ca7e01b3b1
- **测试时间**: YYYY-MM-DD HH:MM:SS

### 复现步骤
1. 步骤 1
2. 步骤 2
3. ...

### 期望结果
描述你期望看到的结果

### 实际结果
描述实际发生的情况

### 错误信息
```
粘贴错误信息或日志
```

### 相关日志
```bash
# 服务器日志
tail -n 50 /root/tnho-video/logs/app.log

# Nginx 日志
tail -n 50 /var/log/nginx/error.log
```

### 已尝试的解决方法
列出你已经尝试过的解决方法

---

**文档版本**：1.0
**最后更新**：2026-01-14
**适用版本**：v1.0.0
