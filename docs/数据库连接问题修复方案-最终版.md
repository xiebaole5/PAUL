# 数据库连接问题修复方案

## 问题描述

小程序创建视频生成任务时出现错误：
```
psycopg2.OperationalError
```

## 问题分析

可能的原因：
1. **连接池耗尽**: 连接未正确释放，导致连接池中的可用连接不足
2. **连接泄漏**: 数据库会话未正确关闭
3. **并发压力**: 连接池配置过大，超出数据库服务器承载能力
4. **超时设置**: 连接和 SQL 执行超时设置过长，导致连接占用时间过长

## 修复方案

### 1. 优化连接池配置

**文件**: `src/storage/database/db.py`

**修改前**:
```python
size = 20           # 连接池大小
overflow = 30      # 最大溢出连接数
recycle = 3600     # 连接回收时间（1小时）
timeout = 60       # 连接超时（60秒）

engine = create_engine(
    url,
    pool_size=size,
    max_overflow=overflow,
    pool_pre_ping=True,
    pool_recycle=recycle,
    pool_timeout=timeout,
    connect_args={
        "connect_timeout": 10,
        "options": "-c statement_timeout=60000"  # 60秒
    },
)
```

**修改后**:
```python
size = 10           # 连接池大小（降低）
overflow = 10      # 最大溢出连接数（降低）
recycle = 1800     # 连接回收时间（30分钟，缩短）
timeout = 30       # 连接超时（30秒，缩短）

engine = create_engine(
    url,
    pool_size=size,
    max_overflow=overflow,
    pool_pre_ping=True,
    pool_recycle=recycle,
    pool_timeout=timeout,
    connect_args={
        "connect_timeout": 5,  # 5秒
        "options": "-c statement_timeout=30000"  # 30秒
    },
)
```

**效果**:
- 最大连接数从 50 降至 20，减少数据库压力
- 连接占用时间从 60 秒降至 30 秒，快速回收连接
- 更快的失败检测，避免长时间等待

---

### 2. 使用上下文管理器确保连接正确关闭

**新建文件**: `src/storage/database/session.py`

```python
"""
数据库会话上下文管理器
确保数据库会话正确关闭，避免连接泄漏
"""
from contextlib import contextmanager
from typing import Generator

from storage.database.db import get_session


@contextmanager
def get_db_session() -> Generator:
    """
    数据库会话上下文管理器
    
    使用方式:
        with get_db_session() as db:
            db.execute("SELECT * FROM table")
        # 会话自动关闭
    """
    session = get_session()
    try:
        yield session
    finally:
        session.close()


__all__ = ["get_db_session"]
```

**效果**:
- 使用 `with` 语句自动关闭会话
- 即使发生异常也能正确关闭连接
- 避免连接泄漏

---

### 3. 修改 API 接口使用上下文管理器

**文件**: `src/api/app.py`

**修改前**:
```python
# 创建任务记录
db = get_session()
try:
    mgr = VideoTaskManager()
    task_create = VideoTaskCreate(...)
    mgr.create_task(db, task_create, total_parts=total_parts)
except Exception as e:
    print(f"创建任务记录失败: {e}")
finally:
    db.close()
```

**修改后**:
```python
# 创建任务记录
with get_db_session() as db:
    try:
        mgr = VideoTaskManager()
        task_create = VideoTaskCreate(...)
        mgr.create_task(db, task_create, total_parts=total_parts)
    except Exception as e:
        print(f"创建任务记录失败: {e}")
```

**修改的接口**:
1. `/api/generate-video` - 创建任务记录
2. `/api/progress/{task_id}` - 查询任务进度
3. `process_video_generation_task` - 后台任务处理
4. 进度更新回调函数

**效果**:
- 所有数据库会话都使用上下文管理器
- 确保连接正确释放
- 避免连接泄漏

---

## 部署步骤

### 1. 拉取最新代码

```bash
cd /root/tnho-video
git pull origin main
```

### 2. 重启应用（清理现有连接池）

```bash
# 停止应用
pkill -f "uvicorn app:app"

# 等待 3 秒
sleep 3

# 强制终止（如果还有进程）
pkill -9 -f "uvicorn app:app"

# 等待 2 秒
sleep 2

# 启动应用
nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 &
```

### 3. 运行诊断脚本

```bash
bash scripts/fix-db-connection.sh
```

这个脚本会：
- 测试数据库连接
- 检查连接池配置
- 检查活跃任务
- 提供修复建议

### 4. 测试视频生成

```bash
# 测试创建任务
curl -X POST http://localhost:8000/api/generate-video \
  -H "Content-Type: application/json" \
  -d '{
    "product_name": "高强度螺栓",
    "theme": "品质保证",
    "duration": 5,
    "type": "video"
  }'

# 复制返回的 task_id，查询进度
curl http://localhost:8000/api/progress/<task_id>
```

---

## 监控建议

### 1. 监控连接池状态

```python
from storage.database.db import get_engine

engine = get_engine()
pool = engine.pool

print(f"连接池大小: {pool.size()}")
print(f"已用连接: {pool.checkedout()}")
print(f"空闲连接: {pool.checkedin()}")
```

### 2. 监控活跃任务

```sql
SELECT
    status,
    COUNT(*) as count,
    MAX(created_at) as latest
FROM video_generation_tasks
WHERE created_at > NOW() - INTERVAL '1 hour'
GROUP BY status;
```

### 3. 检查长时间运行的任务

```sql
SELECT
    task_id,
    status,
    created_at,
    EXTRACT(EPOCH FROM (NOW() - created_at)) as seconds_since_creation
FROM video_generation_tasks
WHERE status IN ('generating', 'merging', 'uploading')
AND created_at < NOW() - INTERVAL '10 minutes';
```

---

## 故障排查

### 问题: 仍然出现 psycopg2.OperationalError

**排查步骤**:

1. **检查数据库服务**
   ```bash
   # 测试数据库连接
   python3 << 'EOF'
   from storage.database.db import get_session
   from sqlalchemy import text
   
   db = get_session()
   result = db.execute(text("SELECT 1"))
   print(result.fetchone())
   db.close()
   EOF
   ```

2. **查看详细错误日志**
   ```bash
   tail -100 /root/tnho-video/logs/app.log
   ```

3. **检查连接池状态**
   ```bash
   python3 << 'EOF'
   from storage.database.db import get_engine
   engine = get_engine()
   pool = engine.pool
   print(f"连接池: {pool.size()}/{pool.checkedout()}/{pool.checkedin()}")
   EOF
   ```

4. **重启应用**
   ```bash
   cd /root/tnho-video
   pkill -f "uvicorn app:app"
   sleep 3
   nohup uvicorn app:app --host 0.0.0.0 --port 8000 --workers 1 --log-level info >> logs/app.log 2>&1 &
   ```

---

## 预期效果

1. **数据库连接稳定**: 不再出现 OperationalError
2. **连接池占用降低**: 最大连接数从 50 降至 20
3. **响应速度提升**: 连接和 SQL 执行超时缩短
4. **连接泄漏消除**: 所有会话使用上下文管理器

---

## 总结

通过以下三个方面的优化，解决了数据库连接问题：

1. **优化连接池配置**: 降低连接数和超时时间
2. **使用上下文管理器**: 确保连接正确关闭
3. **改进错误处理**: 更快的失败检测

这些优化可以显著提高系统的稳定性和性能，特别是在资源受限的服务器环境下。
