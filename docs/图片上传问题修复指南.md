# 图片上传问题修复指南

本文档帮助你诊断和修复小程序图片上传失败的问题。

---

## 问题诊断

### 常见错误现象

1. **上传失败 - 网络错误**
   - 小程序提示"网络错误，上传失败"
   - 原因：服务器未重启，代码修改未生效

2. **上传失败 - 文件格式错误**
   - 小程序提示"仅支持 JPG、PNG 格式的图片"
   - 原因：图片格式确实不符合要求

3. **上传失败 - 文件过大**
   - 小程序提示"图片大小不能超过 5MB"
   - 原因：图片超过 5MB 限制

4. **上传成功但无法预览**
   - 上传显示成功，但无法预览图片
   - 原因：图片 URL 配置错误（使用 localhost）

---

## 已修复的问题

### 1. 后端返回 URL 错误

**问题：** 后端返回 `http://localhost:8000`，小程序无法访问

**修复：**
- ✅ 修改 `src/api/app.py`，使用环境变量 `EXTERNAL_BASE_URL`
- ✅ 在 `docker-compose.yml` 中添加环境变量配置
- ✅ 默认值为 `http://47.110.72.148`

**修改文件：**
```python
# src/api/app.py
import os
base_url = os.getenv("EXTERNAL_BASE_URL", "http://47.110.72.148")
image_url = f"{base_url}/assets/uploads/{unique_filename}"
```

```yaml
# docker-compose.yml
environment:
  - EXTERNAL_BASE_URL=http://47.110.72.148
```

### 2. 上传目录不存在

**问题：** `/workspace/projects/assets/uploads` 目录不存在

**修复：**
```bash
mkdir -p /workspace/projects/assets/uploads
chmod 755 /workspace/projects/assets/uploads
```

### 3. Nginx 文件大小限制

**问题：** Nginx 默认文件大小限制较小

**状态：** ✅ 已配置为 10MB（在 `nginx/nginx.conf` 中）

```nginx
client_max_body_size 10M;
```

---

## 快速修复步骤

### 步骤 1：重启服务

```bash
# 在服务器上执行
cd /workspace/projects

# 重启服务
docker compose down
docker compose up -d

# 等待服务启动
sleep 10

# 检查服务状态
docker compose ps
```

### 步骤 2：运行诊断脚本

```bash
# 运行诊断脚本
bash scripts/diagnose-upload.sh
```

这个脚本会检查：
- ✅ 后端服务状态
- ✅ 上传目录权限
- ✅ Nginx 配置
- ✅ 后端代码配置
- ✅ 环境变量
- ✅ 小程序配置

### 步骤 3：测试上传功能

```bash
# 运行测试脚本
bash scripts/test-upload.sh
```

这个脚本会：
- ✅ 测试图片上传
- ✅ 验证返回的 URL
- ✅ 测试图片访问
- ✅ 检查上传目录

### 步骤 4：在小程序中测试

1. **打开微信开发者工具**
2. **配置本地设置**（重要）
   - 右上角 → 详情 → 本地设置
   - ✅ 勾选"不校验合法域名"
   - ✅ 勾选"不校验域名 TLS 版本"
   - ✅ 勾选"不校验 web-view（业务域名）"

3. **测试上传**
   - 点击上传区域
   - 选择一张 JPG 或 PNG 图片（小于 5MB）
   - 等待上传完成
   - 查看是否显示预览

---

## 小程序端配置

### 确保小程序配置正确

**文件：** `miniprogram/pages/index/index.js`

检查上传 API 地址：
```javascript
// 开发环境（当前使用）
wx.uploadFile({
  url: `${app.globalData.apiUrl}/api/upload-image`,
  // ...
})

// app.js 中的配置
globalData: {
  apiUrl: 'http://47.110.72.148'  // 开发环境
}
```

### 微信开发者工具设置

**重要：** 必须配置本地设置，否则无法访问 HTTP 接口

```
右上角 → 详情 → 本地设置

✅ 不校验合法域名
✅ 不校验域名 TLS 版本
✅ 不校验 web-view（业务域名）
```

---

## 常见问题排查

### 问题 1：上传后提示"网络错误"

**原因：**
- 服务器未重启
- 代码修改未生效
- 网络连接问题

**解决方法：**
```bash
# 重启服务
docker compose restart

# 查看日志
docker compose logs -f api

# 查看错误信息
docker compose logs --tail=100 api | grep -i error
```

### 问题 2：上传成功但无法预览

**原因：**
- 图片 URL 使用了 localhost
- 静态文件路径配置错误

**解决方法：**
```bash
# 检查环境变量
docker compose exec api env | grep EXTERNAL

# 检查上传的文件
ls -lh /workspace/projects/assets/uploads/

# 测试图片访问
curl -I http://47.110.72.148/assets/uploads/xxx.png
```

### 问题 3：提示"文件格式错误"

**原因：**
- 图片格式不符合要求
- 文件后缀名错误

**支持格式：**
- ✅ JPG (image/jpeg)
- ✅ PNG (image/png)
- ❌ GIF、WebP、BMP 等不支持

**解决方法：**
- 使用系统相册或其他工具转换图片格式
- 确保文件后缀名正确（.jpg 或 .png）

### 问题 4：提示"文件过大"

**原因：**
- 图片大小超过 5MB 限制

**解决方法：**
- 使用图片压缩工具
- 降低图片分辨率
- 重新选择较小的图片

---

## 测试上传功能

### 方法 1：使用测试脚本

```bash
bash scripts/test-upload.sh
```

### 方法 2：手动测试

```bash
# 上传测试图片
curl -X POST http://47.110.72.148/api/upload-image \
  -F "file=@assets/image.png"

# 应返回类似：
{
  "success": true,
  "message": "图片上传成功",
  "image_url": "http://47.110.72.148/assets/uploads/xxx-xxx-xxx.png",
  "filename": "xxx-xxx-xxx.png"
}
```

### 方法 3：在小程序中测试

1. 打开微信开发者工具
2. 点击上传区域
3. 选择图片
4. 查看控制台输出
5. 查看是否显示预览

---

## 生产环境配置

### 切换到 HTTPS 环境

当域名备案完成后，需要：

1. **更新环境变量**
```yaml
# docker-compose.yml
environment:
  - EXTERNAL_BASE_URL=https://tnho-fasteners.com
```

2. **重启服务**
```bash
docker compose restart
```

3. **更新小程序配置**
```javascript
// miniprogram/app.js
globalData: {
  apiUrl: 'https://tnho-fasteners.com'
}
```

---

## 日志查看

### 查看后端日志

```bash
# 实时查看日志
docker compose logs -f api

# 查看最近 100 行
docker compose logs --tail=100 api

# 查看错误日志
docker compose logs api | grep -i error
```

### 查看小程序错误

1. 打开微信开发者工具
2. 点击 **"调试器"** 标签
3. 点击 **"Console"**
4. 查看红色错误信息

---

## 性能优化建议

### 1. 图片压缩

在前端上传前进行压缩：

```javascript
// 小程序中压缩图片
wx.compressImage({
  src: filePath,
  quality: 80,
  success(res) {
    // 上传压缩后的图片
    that.uploadImage(res.tempFilePath)
  }
})
```

### 2. 使用 CDN

将上传的图片同步到 CDN：

```python
# 上传成功后，同步到 CDN
# 使用对象存储集成服务
```

---

## 总结

### 检查清单

- [ ] 服务已重启（docker compose restart）
- [ ] 上传目录存在且有写权限
- [ ] 环境变量已配置（EXTERNAL_BASE_URL）
- [ ] 微信开发者工具已勾选"不校验合法域名"
- [ ] 图片格式正确（JPG/PNG）
- [ ] 图片大小小于 5MB
- [ ] 网络连接正常
- [ ] 后端日志无错误

### 快速命令

```bash
# 一键修复
docker compose restart && \
sleep 10 && \
bash scripts/diagnose-upload.sh && \
bash scripts/test-upload.sh
```

---

## 技术支持

如果以上方法都无法解决问题，请提供以下信息：

1. 小程序控制台错误截图
2. 后端服务日志：`docker compose logs api`
3. 测试脚本输出：`bash scripts/diagnose-upload.sh`
4. 小程序开发者工具版本号

---

**最后更新：** 2025-01-13
