# å¤©è™¹ç´§å›ºä»¶è§†é¢‘ç”Ÿæˆç³»ç»Ÿ - é˜¿é‡Œäº‘éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•
- [ç³»ç»Ÿè¦æ±‚](#ç³»ç»Ÿè¦æ±‚)
- [å¿«é€Ÿéƒ¨ç½²](#å¿«é€Ÿéƒ¨ç½²)
- [æ‰‹åŠ¨éƒ¨ç½²](#æ‰‹åŠ¨éƒ¨ç½²)
- [é…ç½®è¯´æ˜](#é…ç½®è¯´æ˜)
- [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [å®‰å…¨é…ç½®](#å®‰å…¨é…ç½®)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)

---

## ç³»ç»Ÿè¦æ±‚

### æœåŠ¡å™¨é…ç½®
- **æ“ä½œç³»ç»Ÿ**: Ubuntu 22.04 LTS (æ¨è)
- **CPU**: 2 æ ¸å¿ƒåŠä»¥ä¸Š
- **å†…å­˜**: 4GB åŠä»¥ä¸Š
- **ç£ç›˜**: 20GB åŠä»¥ä¸Š
- **ç½‘ç»œ**: å…¬ç½‘ IPï¼Œå¸¦å®½å»ºè®® 5Mbps åŠä»¥ä¸Š

### è½¯ä»¶è¦æ±‚
- Docker 20.10 åŠä»¥ä¸Š
- Docker Compose 2.0 åŠä»¥ä¸Š
- SSH è®¿é—®æƒé™

---

## å¿«é€Ÿéƒ¨ç½²

### æ–¹å¼ä¸€ï¼šä½¿ç”¨è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ï¼ˆæ¨èï¼‰

#### 1. è¿æ¥æœåŠ¡å™¨
```bash
ssh root@your-server-ip
```

#### 2. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶
å°†ä»¥ä¸‹æ–‡ä»¶ä¸Šä¼ åˆ°æœåŠ¡å™¨ `/opt/tnho-video-generator/` ç›®å½•ï¼š
```
/opt/tnho-video-generator/
â”œâ”€â”€ Dockerfile
â”œâ”€â”€ docker-compose.yml
â”œâ”€â”€ .env.example
â”œâ”€â”€ requirements.txt
â”œâ”€â”€ deploy.sh
â”œâ”€â”€ src/
â”œâ”€â”€ config/
â””â”€â”€ nginx/
    â””â”€â”€ nginx.conf
```

ä¸Šä¼ æ–¹å¼ï¼ˆåœ¨æœ¬åœ°æ‰§è¡Œï¼‰ï¼š
```bash
# ä½¿ç”¨ scp ä¸Šä¼ 
scp -r . root@your-server-ip:/opt/tnho-video-generator/

# æˆ–ä½¿ç”¨ rsync
rsync -avz --progress ./ root@your-server-ip:/opt/tnho-video-generator/
```

#### 3. è¿è¡Œéƒ¨ç½²è„šæœ¬
```bash
cd /opt/tnho-video-generator
chmod +x deploy.sh
sudo ./deploy.sh
```

è„šæœ¬ä¼šè‡ªåŠ¨å®Œæˆä»¥ä¸‹æ“ä½œï¼š
1. å®‰è£… Docker å’Œ Docker Compose
2. åˆ›å»ºé¡¹ç›®ç›®å½•
3. é…ç½®ç¯å¢ƒå˜é‡
4. æ„å»ºå¹¶å¯åŠ¨æœåŠ¡

#### 4. éªŒè¯éƒ¨ç½²
```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
curl http://your-server-ip/health

# æˆ–ä½¿ç”¨æµè§ˆå™¨è®¿é—®
http://your-server-ip
```

---

### æ–¹å¼äºŒï¼šæ‰‹åŠ¨éƒ¨ç½²

#### 1. å®‰è£… Docker

```bash
# æ›´æ–°è½¯ä»¶åŒ…
apt-get update

# å®‰è£…ä¾èµ–
apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# æ·»åŠ  Docker å®˜æ–¹ GPG å¯†é’¥
install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
chmod a+r /etc/apt/keyrings/docker.gpg

# æ·»åŠ  Docker APT æº
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null

# å®‰è£… Docker Engine
apt-get update
apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# å¯åŠ¨ Docker
systemctl start docker
systemctl enable docker
```

#### 2. å®‰è£… Docker Compose

```bash
curl -SL https://github.com/docker/compose/releases/download/v2.23.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker-compose --version
```

#### 3. åˆ›å»ºé¡¹ç›®ç›®å½•

```bash
mkdir -p /opt/tnho-video-generator
cd /opt/tnho-video-generator

# åˆ›å»ºå­ç›®å½•
mkdir -p nginx/logs
mkdir -p assets/uploads
mkdir -p logs
```

#### 4. ä¸Šä¼ é¡¹ç›®æ–‡ä»¶

å°†é¡¹ç›®æ–‡ä»¶ä¸Šä¼ åˆ° `/opt/tnho-video-generator/` ç›®å½•

#### 5. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡ç¤ºä¾‹æ–‡ä»¶
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶
nano .env
```

ç¼–è¾‘å†…å®¹ï¼š
```env
ARK_API_KEY=e1533511-efae-4131-aea9-b573a1be4ecf
ARK_BASE_URL=https://ark.cn-beijing.volces.com/api/v3
COZE_WORKSPACE_PATH=/app
API_PORT=8000
NGINX_PORT=80
LOG_LEVEL=INFO
```

#### 6. å¯åŠ¨æœåŠ¡

```bash
# æ„å»ºé•œåƒ
docker-compose build

# å¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f
```

---

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡è¯´æ˜

| å˜é‡å | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|
| `ARK_API_KEY` | ç«å±±æ–¹èˆŸ API å¯†é’¥ | `e1533511-efae-4131-aea9-b573a1be4ecf` |
| `ARK_BASE_URL` | ç«å±±æ–¹èˆŸ API åœ°å€ | `https://ark.cn-beijing.volces.com/api/v3` |
| `COZE_WORKSPACE_PATH` | å·¥ä½œç©ºé—´è·¯å¾„ | `/app` |
| `API_PORT` | API æœåŠ¡ç«¯å£ | `8000` |
| `NGINX_PORT` | Nginx ç«¯å£ | `80` |
| `LOG_LEVEL` | æ—¥å¿—çº§åˆ« | `INFO` |

### Nginx é…ç½®

Nginx é…ç½®æ–‡ä»¶ä½ç½®ï¼š`nginx/nginx.conf`

ä¸»è¦åŠŸèƒ½ï¼š
- åå‘ä»£ç† API è¯·æ±‚
- é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå›¾ç‰‡ã€è§†é¢‘ï¼‰
- Gzip å‹ç¼©
- è¶…æ—¶è®¾ç½®ï¼ˆè§†é¢‘ç”Ÿæˆå¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´ï¼‰
- æ”¯æŒ HTTPSï¼ˆéœ€é…ç½®è¯ä¹¦ï¼‰

### Docker Compose é…ç½®

æœåŠ¡è¯´æ˜ï¼š
- **api**: FastAPI åç«¯æœåŠ¡ï¼ˆç«¯å£ 8000ï¼‰
- **nginx**: Nginx åå‘ä»£ç†ï¼ˆç«¯å£ 80ã€443ï¼‰

---

## æœåŠ¡ç®¡ç†

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€
```bash
docker-compose ps
```

### æŸ¥çœ‹æ—¥å¿—
```bash
# æŸ¥çœ‹æ‰€æœ‰æœåŠ¡æ—¥å¿—
docker-compose logs -f

# åªæŸ¥çœ‹ API æœåŠ¡æ—¥å¿—
docker-compose logs -f api

# æŸ¥çœ‹æœ€è¿‘ 100 è¡Œæ—¥å¿—
docker-compose logs --tail=100
```

### é‡å¯æœåŠ¡
```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose restart api
```

### åœæ­¢æœåŠ¡
```bash
docker-compose stop
```

### å¯åŠ¨æœåŠ¡
```bash
docker-compose start
```

### æ›´æ–°æœåŠ¡
```bash
# æ‹‰å–æœ€æ–°ä»£ç å
docker-compose down
docker-compose build
docker-compose up -d
```

### æ¸…ç†æœåŠ¡
```bash
# åœæ­¢å¹¶åˆ é™¤å®¹å™¨
docker-compose down

# åœæ­¢å¹¶åˆ é™¤å®¹å™¨ã€å·ã€é•œåƒ
docker-compose down -v --rmi all
```

---

## æ•…éšœæ’æŸ¥

### æœåŠ¡æ— æ³•å¯åŠ¨

#### æ£€æŸ¥å®¹å™¨çŠ¶æ€
```bash
docker-compose ps
docker-compose logs
```

#### å¸¸è§é—®é¢˜

**1. ç«¯å£è¢«å ç”¨**
```bash
# æ£€æŸ¥ç«¯å£å ç”¨
netstat -tlnp | grep 80
netstat -tlnp | grep 8000

# ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£æ˜ å°„
ports:
  - "8001:8000"  # æ”¹ä¸ºå…¶ä»–ç«¯å£
```

**2. ç¯å¢ƒå˜é‡æœªé…ç½®**
```bash
# æ£€æŸ¥ .env æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la .env

# æ£€æŸ¥ç¯å¢ƒå˜é‡å€¼
cat .env
```

**3. Docker é•œåƒæ„å»ºå¤±è´¥**
```bash
# æ¸…ç† Docker ç¼“å­˜åé‡æ–°æ„å»º
docker-compose build --no-cache
```

### API è°ƒç”¨å¤±è´¥

#### æ£€æŸ¥ API æœåŠ¡
```bash
# æœ¬åœ°æµ‹è¯•
curl http://localhost:8000/health

# æµ‹è¯• Nginx ä»£ç†
curl http://localhost/health
```

#### æ£€æŸ¥é˜²ç«å¢™
```bash
# æŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€
ufw status

# å¼€æ”¾ç«¯å£
ufw allow 80
ufw allow 443
ufw allow 8000
```

#### æ£€æŸ¥é˜¿é‡Œäº‘å®‰å…¨ç»„
åœ¨é˜¿é‡Œäº‘æ§åˆ¶å°é…ç½®å®‰å…¨ç»„è§„åˆ™ï¼š
- å…¥æ–¹å‘ï¼šå¼€æ”¾ TCP 80ã€443 ç«¯å£
- å…è®¸è®¿é—® IPï¼š0.0.0.0/0

### è§†é¢‘ç”Ÿæˆå¤±è´¥

#### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
```bash
docker-compose logs -f api | grep -i error
```

#### æ£€æŸ¥ç«å±±æ–¹èˆŸ API å¯†é’¥
```bash
# æ£€æŸ¥ç¯å¢ƒå˜é‡
docker-compose exec api env | grep ARK

# æµ‹è¯• API è¿æ¥
docker-compose exec api python -c "import os; print(os.getenv('ARK_API_KEY'))"
```

#### æ£€æŸ¥ç½‘ç»œè¿æ¥
```bash
# æµ‹è¯•ç«å±±æ–¹èˆŸ API è¿æ¥
docker-compose exec api curl -I https://ark.cn-beijing.volces.com/api/v3
```

---

## å®‰å…¨é…ç½®

### 1. é…ç½®é˜²ç«å¢™
```bash
# å¯ç”¨é˜²ç«å¢™
ufw enable

# åªå¼€æ”¾å¿…è¦ç«¯å£
ufw allow 22/tcp    # SSH
ufw allow 80/tcp    # HTTP
ufw allow 443/tcp   # HTTPS
ufw deny 8000/tcp   # å…³é—­ API ç›´æ¥è®¿é—®ï¼Œåªé€šè¿‡ Nginx
```

### 2. é…ç½® SSL/HTTPSï¼ˆæ¨èï¼‰

#### ä½¿ç”¨ Let's Encrypt å…è´¹è¯ä¹¦

```bash
# å®‰è£… certbot
apt-get install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
certbot renew --dry-run
```

#### ä¿®æ”¹ Nginx é…ç½®

å–æ¶ˆæ³¨é‡Š `nginx/nginx.conf` ä¸­çš„ HTTPS é…ç½®éƒ¨åˆ†ï¼š

```nginx
server {
    listen 443 ssl http2;
    server_name your-domain.com;

    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;

    # å…¶ä»–é…ç½®...
}
```

### 3. é™åˆ¶ API è®¿é—®

åœ¨ Nginx é…ç½®ä¸­æ·»åŠ  IP ç™½åå•ï¼š
```nginx
location /api/ {
    allow 123.45.67.89;  # å…è®¸çš„ IP
    allow 10.0.0.0/8;     # å…è®¸çš„å†…ç½‘æ®µ
    deny all;            # æ‹’ç»å…¶ä»–æ‰€æœ‰ IP

    proxy_pass http://api_backend;
    # ... å…¶ä»–é…ç½®
}
```

### 4. é…ç½® Fail2Ban

```bash
# å®‰è£… Fail2Ban
apt-get install fail2ban

# åˆ›å»ºé…ç½®æ–‡ä»¶
cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local

# é…ç½® SSH ä¿æŠ¤
nano /etc/fail2ban/jail.local
```

æ·»åŠ ä»¥ä¸‹é…ç½®ï¼š
```ini
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
```

é‡å¯æœåŠ¡ï¼š
```bash
systemctl enable fail2ban
systemctl start fail2ban
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. è°ƒæ•´ Docker èµ„æºé™åˆ¶

åœ¨ `docker-compose.yml` ä¸­æ·»åŠ èµ„æºé™åˆ¶ï¼š
```yaml
services:
  api:
    # ... å…¶ä»–é…ç½®
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '1.0'
          memory: 2G
```

### 2. é…ç½® Nginx ç¼“å­˜

åœ¨ `nginx/nginx.conf` ä¸­æ·»åŠ ç¼“å­˜é…ç½®ï¼š
```nginx
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=1g inactive=60m;

server {
    location /api/ {
        proxy_cache my_cache;
        proxy_cache_valid 200 10m;
        proxy_cache_key "$scheme$request_method$host$request_uri";

        proxy_pass http://api_backend;
        # ... å…¶ä»–é…ç½®
    }
}
```

### 3. å¯ç”¨ Gzip å‹ç¼©

å·²åœ¨é…ç½®æ–‡ä»¶ä¸­å¯ç”¨ï¼Œè°ƒæ•´å‹ç¼©çº§åˆ«ï¼š
```nginx
gzip_comp_level 6;  # 1-9ï¼Œè¶Šå¤§å‹ç¼©ç‡è¶Šé«˜
```

### 4. é…ç½®æ—¥å¿—è½®è½¬

åˆ›å»º `/etc/logrotate.d/tnho-video`ï¼š
```
/opt/tnho-video-generator/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0640 root root
}
```

---

## ç›‘æ§å’Œç»´æŠ¤

### ç³»ç»Ÿç›‘æ§

#### å®‰è£…ç›‘æ§å·¥å…·
```bash
# htop - è¿›ç¨‹ç›‘æ§
apt-get install htop

# iotop - IO ç›‘æ§
apt-get install iotop

# nethogs - ç½‘ç»œç›‘æ§
apt-get install nethogs
```

#### å®šæœŸæ£€æŸ¥
```bash
# æŸ¥çœ‹ç£ç›˜ä½¿ç”¨
df -h

# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# æŸ¥çœ‹å®¹å™¨èµ„æºä½¿ç”¨
docker stats
```

### æ—¥å¿—ç®¡ç†

```bash
# æŸ¥çœ‹ API æ—¥å¿—
tail -f logs/app.log

# æŸ¥çœ‹ Nginx è®¿é—®æ—¥å¿—
tail -f nginx/logs/access.log

# æŸ¥çœ‹ Nginx é”™è¯¯æ—¥å¿—
tail -f nginx/logs/error.log
```

### å¤‡ä»½

```bash
# å¤‡ä»½é…ç½®æ–‡ä»¶
tar -czf backup-$(date +%Y%m%d).tar.gz config/ .env nginx/

# å¤‡ä»½æ•°æ®
tar -czf data-backup-$(date +%Y%m%d).tar.gz assets/
```

---

## å¾®ä¿¡å°ç¨‹åºé…ç½®

æ›´æ–°å°ç¨‹åºä¸­çš„ API åœ°å€ï¼š

```javascript
// miniprogram/pages/index/index.js
const API_BASE_URL = 'http://your-server-ip';  // æˆ– https://your-domain.com

// ç”Ÿæˆè§†é¢‘
async generateVideo() {
  const res = await wx.request({
    url: `${API_BASE_URL}/api/generate-video`,
    method: 'POST',
    data: {
      product_name: this.data.productName,
      theme: this.data.theme,
      duration: this.data.duration,
      type: this.data.generateType,
      scenario: this.data.scenario,
      product_image_url: this.data.productImageUrl
    }
  });
  // ...
}
```

---

## å¸¸è§é—®é¢˜

### Q1: å¦‚ä½•æ›´æ–°ä»£ç ï¼Ÿ
```bash
# 1. ä¸Šä¼ æ–°ä»£ç åˆ°æœåŠ¡å™¨
# 2. é‡æ–°æ„å»ºå’Œéƒ¨ç½²
docker-compose down
docker-compose build
docker-compose up -d
```

### Q2: å¦‚ä½•æŸ¥çœ‹æœåŠ¡å ç”¨èµ„æºï¼Ÿ
```bash
docker stats
```

### Q3: å¦‚ä½•å¤‡ä»½æ•°æ®ï¼Ÿ
```bash
# å¤‡ä»½é…ç½®
tar -czf backup-config.tar.gz config/ .env nginx/

# å¤‡ä»½æ•°æ®
tar -czf backup-data.tar.gz assets/
```

### Q4: å¦‚ä½•æ¢å¤æœåŠ¡ï¼Ÿ
```bash
# æ¢å¤é…ç½®
tar -xzf backup-config.tar.gz

# æ¢å¤æ•°æ®
tar -xzf backup-data.tar.gz

# é‡å¯æœåŠ¡
docker-compose down
docker-compose up -d
```

### Q5: å¦‚ä½•æŸ¥çœ‹å®¹å™¨å†…éƒ¨ï¼Ÿ
```bash
# è¿›å…¥ API å®¹å™¨
docker-compose exec api bash

# è¿›å…¥ Nginx å®¹å™¨
docker-compose exec nginx sh
```

---

## è”ç³»æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒã€‚

---

**éƒ¨ç½²å®Œæˆåï¼Œè¯·è®¿é—® `http://your-server-ip/health` æ£€æŸ¥æœåŠ¡çŠ¶æ€ã€‚**
