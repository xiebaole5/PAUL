# 小程序测试指南

## ✅ 前置条件检查

在开始测试前，请确认以下条件已满足：

- [x] 域名已配置（request、uploadFile、downloadFile）
- [x] 服务器服务正常运行（active running）
- [x] HTTPS 证书有效
- [x] API 接口可以访问
- [x] 小程序代码已下载到本地（`C:\Users\12187\Desktop\tnho-miniprogram`）

## 📱 测试环境准备

### 1. 打开微信开发者工具

1. 打开微信开发者工具
2. 选择 **小程序** 项目类型
3. 导入项目：选择项目目录 `C:\Users\12187\Desktop\tnho-miniprogram`
4. AppID：`wx464504ca7e01b3b1`

### 2. 配置项目信息

- **项目名称**：天虹紧固件视频生成
- **AppID**：wx464504ca7e01b3b1
- **开发模式**：小程序

## 🧪 测试步骤

### 测试 1：小程序启动

**目标**：验证小程序可以正常启动

**步骤**：
1. 点击微信开发者工具的 **编译** 按钮
2. 观察编译结果
3. 检查模拟器是否正常显示

**预期结果**：
- ✅ 编译成功，无错误
- ✅ 模拟器显示小程序首页
- ✅ 无网络请求错误

**如果失败**：
- 检查 `app.js` 中的 `apiUrl` 配置是否正确
- 查看控制台错误信息
- 检查网络连接

---

### 测试 2：健康检查接口

**目标**：验证小程序可以正常调用服务器 API

**步骤**：
1. 在小程序首页点击任意按钮
2. 打开微信开发者工具的 **调试器**（Console）
3. 观察网络请求

**预期结果**：
- ✅ 健康检查接口返回成功
- ✅ 控制台无网络错误
- ✅ 响应状态码：200

**验证命令**（服务器端）：
```bash
curl https://tnho-fasteners.com/health
```

**预期输出**：
```json
{"status":"ok"}
```

---

### 测试 3：图片上传功能

**目标**：验证图片上传功能正常

**步骤**：
1. 在小程序中点击 **上传图片** 按钮
2. 选择一张本地图片
3. 观察上传进度
4. 检查是否返回图片 URL

**预期结果**：
- ✅ 图片选择成功
- ✅ 上传进度显示正常
- ✅ 返回图片 URL
- ✅ 图片预览显示

**验证方法**：
1. 查看小程序控制台的 Network 标签
2. 找到 `/api/upload-image` 请求
3. 检查响应：
```json
{
  "url": "https://tnho-video.oss-cn-hangzhou.aliyuncs.com/...",
  "message": "图片上传成功"
}
```

**如果失败**：
- 检查 `uploadFile` 合法域名是否配置
- 查看服务器日志：`journalctl -u tnho-api -f`
- 检查图片大小是否超过限制（小程序限制 10MB）

---

### 测试 4：视频生成功能（文生视频）

**目标**：验证文本生成视频功能正常

**步骤**：
1. 在小程序中输入产品描述（如："高品质紧固件，工业应用场景"）
2. 选择视频时长（15秒/20秒/25秒/30秒）
3. 选择主题（品质保证/技术创新/工业应用/品牌形象）
4. 点击 **生成视频** 按钮
5. 观察进度提示
6. 等待视频生成完成

**预期结果**：
- ✅ 提交成功
- ✅ 显示进度提示
- ✅ 视频生成完成
- ✅ 可以预览视频
- ✅ 可以下载或分享

**验证方法**：
1. 查看控制台的 Network 标签
2. 找到 `/api/generate-video` 请求
3. 检查响应：
```json
{
  "task_id": "xxx",
  "status": "pending",
  "message": "视频生成任务已提交"
}
```

4. 查看进度查询请求 `/api/progress/{task_id}`
5. 检查最终响应：
```json
{
  "task_id": "xxx",
  "status": "completed",
  "video_url": "https://tnho-video.oss-cn-hangzhou.aliyuncs.com/..."
}
```

**如果失败**：
- 检查 `request` 合法域名是否配置
- 查看服务器日志：`journalctl -u tnho-api -f`
- 检查火山方舟 API Key 是否正确

---

### 测试 5：视频生成功能（图生视频）

**目标**：验证图片生成视频功能正常

**步骤**：
1. 在小程序中点击 **上传产品图片** 按钮
2. 选择一张产品图片
3. 输入使用场景描述
4. 选择视频时长
5. 点击 **生成视频** 按钮
6. 观察进度和结果

**预期结果**：
- ✅ 图片上传成功
- ✅ 视频生成成功
- ✅ 视频中包含产品图片元素

---

### 测试 6：进度查询功能

**目标**：验证进度查询功能正常

**步骤**：
1. 提交一个视频生成任务
2. 观察小程序是否自动轮询进度
3. 检查进度更新是否及时

**预期结果**：
- ✅ 每 2 秒自动查询一次进度
- ✅ 进度显示准确（pending/processing/completed）
- ✅ 最多轮询 3 分钟
- ✅ 超时后显示提示信息

---

### 测试 7：视频预览和下载

**目标**：验证视频预览和下载功能正常

**步骤**：
1. 等待视频生成完成
2. 点击视频播放预览
3. 测试下载功能
4. 测试分享功能

**预期结果**：
- ✅ 视频可以正常播放
- ✅ 下载功能正常
- ✅ 分享功能正常

---

## 📊 测试检查清单

### 基础功能测试

- [ ] 小程序可以正常启动
- [ ] 健康检查接口调用成功
- [ ] 无网络请求错误
- [ ] 页面显示正常

### 图片上传测试

- [ ] 图片选择功能正常
- [ ] 图片上传成功
- [ ] 返回图片 URL
- [ ] 图片预览显示

### 视频生成测试（文生视频）

- [ ] 文本输入正常
- [ ] 时长选择正常
- [ ] 主题选择正常
- [ ] 提交任务成功
- [ ] 进度查询正常
- [ ] 视频生成完成
- [ ] 视频可以播放

### 视频生成测试（图生视频）

- [ ] 图片上传成功
- [ ] 场景描述输入正常
- [ ] 视频生成成功
- [ ] 视频包含图片元素

### 进度查询测试

- [ ] 进度轮询正常
- [ ] 进度更新及时
- [ ] 超时处理正常

### 视频操作测试

- [ ] 视频可以播放
- [ ] 下载功能正常
- [ ] 分享功能正常

## 🚨 故障排查

### 问题 1：小程序启动失败

**症状**：
- 编译错误
- 页面显示异常
- 控制台报错

**解决方案**：
1. 检查 `app.js` 中的 `apiUrl` 配置：
```javascript
const apiUrl = 'https://tnho-fasteners.com';
```

2. 检查 `pages/index/index.js` 中的 API 调用

3. 查看控制台错误信息
   - Network Error → 检查网络连接
   - SSL Error → 检查 HTTPS 证书
   - 404 Error → 检查 API 路径

---

### 问题 2：健康检查失败

**症状**：
- 健康检查接口返回错误
- 状态码不是 200

**解决方案**：
1. 在服务器上测试：
```bash
curl https://tnho-fasteners.com/health
```

2. 检查服务状态：
```bash
systemctl status tnho-api
```

3. 检查服务日志：
```bash
journalctl -u tnho-api -n 50
```

---

### 问题 3：图片上传失败

**症状**：
- 上传进度卡住
- 返回错误信息
- 提示"不在合法域名列表中"

**解决方案**：
1. 确认 `uploadFile` 合法域名已配置：
   - 登录微信公众平台
   - 检查 **uploadFile 合法域名** 是否包含 `https://tnho-fasteners.com`

2. 检查图片大小（不超过 10MB）

3. 查看服务器日志：
```bash
journalctl -u tnho-api -f
```

4. 在服务器上测试上传：
```bash
echo "test" > /tmp/test.txt
curl -X POST https://tnho-fasteners.com/api/upload-image \
  -F "file=@/tmp/test.txt"
```

---

### 问题 4：视频生成失败

**症状**：
- 提交失败
- 进度查询返回错误
- 视频生成超时

**解决方案**：
1. 确认 `request` 合法域名已配置：
   - 登录微信公众平台
   - 检查 **request 合法域名** 是否包含 `https://tnho-fasteners.com`

2. 检查服务器日志：
```bash
journalctl -u tnho-api -f
```

3. 检查火山方舟 API Key：
```bash
cat /root/PAUL/.env | grep ARK_API_KEY
```

4. 测试视频生成接口：
```bash
curl -X POST https://tnho-fasteners.com/api/generate-video \
  -H "Content-Type: application/json" \
  -d '{
    "theme": "品质保证",
    "duration": 20,
    "description": "高品质紧固件"
  }'
```

---

### 问题 5：进度查询超时

**症状**：
- 进度一直显示"处理中"
- 超过 3 分钟仍未完成

**解决方案**：
1. 检查任务状态：
```bash
# 在服务器上查询数据库
psql -U postgres -d tnho_fasteners -c "SELECT * FROM video_generation_tasks ORDER BY created_at DESC LIMIT 10;"
```

2. 查看服务日志：
```bash
journalctl -u tnho-api -f | grep -i error
```

3. 检查火山方舟 API 是否正常

---

### 问题 6：视频无法播放

**症状**：
- 点击播放无反应
- 播放器显示错误

**解决方案**：
1. 检查视频 URL 是否有效
2. 在浏览器中直接打开视频 URL 测试
3. 检查视频格式是否支持（MP4）
4. 检查视频大小是否过大

---

## 📝 测试报告模板

完成测试后，请填写以下测试报告：

```
测试日期：_________
测试人员：_________

测试结果：
✅ 通过
❌ 失败

测试详情：
- 小程序启动：[通过/失败]
- 健康检查：[通过/失败]
- 图片上传：[通过/失败]
- 视频生成（文生视频）：[通过/失败]
- 视频生成（图生视频）：[通过/失败]
- 进度查询：[通过/失败]
- 视频播放：[通过/失败]

遇到的问题：
1. ____________________________________________
2. ____________________________________________
3. ____________________________________________

备注：
__________________________________________
```

## 🚀 下一步

### 测试通过后

1. **真机测试**
   - 在真实手机上测试
   - 测试不同网络环境（WiFi/4G/5G）
   - 测试不同手机型号

2. **性能测试**
   - 测试视频生成速度
   - 测试并发处理能力
   - 测试内存占用

3. **提交审核**
   - 在微信公众平台提交审核
   - 确保所有功能正常
   - 等待审核通过

4. **发布上线**
   - 审核通过后发布
   - 通知用户使用
   - 收集用户反馈

---

## 📞 获取帮助

如果测试过程中遇到问题，请提供以下信息：

1. 小程序 AppID
2. 测试步骤
3. 错误提示截图
4. 小程序控制台日志
5. 服务器日志：`journalctl -u tnho-api -n 100`

---

**创建时间**：2026-01-14
**最后更新**：2026-01-14
